{% extends 'sites/base_global_dashboard.html' %}
{% block content %}
{% load static %}

<!-- ── Libraries ──────────────────────────────────────────────────────── -->
<script src="{% static 'amcharts/core.js' %}"></script>
<script src="{% static 'amcharts/maps.js' %}"></script>
<script src="{% static 'amcharts/india2020High.js' %}"></script>
<script src="{% static 'amcharts/animated.js' %}"></script>

<!-- ── Styles ─────────────────────────────────────────────────────────── -->
<style>
    body.dark-mode {
        background: #0f172a;
        color: #e2e8f0;
    }

    #header {
        background-color: #002b5c;
        color: white;
        padding: 14px 24px;
        font-size: 24px;
        font-weight: bold;
    }

    #chartdiv {
        width: 100%;
        height: calc(100vh - 60px);
    }

    #legend {
        position: fixed;
        bottom: 100px;
        left: 280px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
    }

    #contact-panel {
        position: fixed;
        bottom: 100px;
        right: 40px;
        width: 380px;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 8px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        display: none;
        z-index: 1000;
    }

    body.dark-mode #contact-panel {
        background: rgba(30, 41, 59, 0.97);
        color: #e2e8f0;
    }

    #contact-header {
        background: #002b5c;
        color: white;
        padding: 10px 14px;
        font-size: 15px;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
    }

    #contact-content {
        padding: 12px;
        font-size: 13.5px;
    }

    .control-btn {
        position: fixed;
        right: 24px;
        background: #002b5c;
        color: white;
        padding: 10px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        width: 150px;
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #resetZoomBtn { top: 120px; }
    #settings-btn   { top: 170px; }
    #history-btn    { top: 220px; }
    #dark-mode-btn  { top: 270px; }

    table { width: 100%; border-collapse: collapse; }
    th {
        text-align: left;
        padding: 6px;
        background: #f5f5f5;
        width: 35%;
    }
    body.dark-mode th { background: #1e293b; }
    td { padding: 6px; }

    #settings-panel, #history-panel {
        position: fixed;
        top: 320px;
        right: -340px;
        max-height: 65vh;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        padding: 16px;
        transition: right 0.3s ease;
        z-index: 1002;
    }

    body.dark-mode #settings-panel,
    body.dark-mode #history-panel {
        background: #1e293b;
        color: #e2e8f0;
    }

    #settings-panel { width: 300px; z-index: 1002; }
    #history-panel  { width: 340px; z-index: 1003; font-size: 13px; }

    #settings-panel.open,
    #history-panel.open { right: 24px; }

    .settings-title {
        font-weight: 600;
        margin: 16px 0 10px;
        color: #333;
    }
    body.dark-mode .settings-title { color: #cbd5e1; }

    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
    }

    /* Switch & Slider styles unchanged – kept minimal */
    .switch { position: relative; width: 38px; height: 20px; }
    .switch input { display: none; }
    .slider {
        position: absolute;
        inset: 0;
        background: #ccc;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
    }
    .slider:before {
        content: "";
        position: absolute;
        width: 16px; height: 16px;
        left: 2px; bottom: 2px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }
    input:checked + .slider { background: #4caf50; }
    input:checked + .slider:before { transform: translateX(18px); }

    input[type=range] {
        width: 130px;
        accent-color: #002b5c;
    }

    .size-label {
        min-width: 70px;
        text-align: right;
        color: #555;
        font-size: 13px;
    }

    #saveSettings {
        margin-top: 20px;
        width: 100%;
        padding: 10px;
        background: #002b5c;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    /* Alerts */
    #alert-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        max-width: 400px;
    }

    .alert {
        padding: 14px 18px;
        margin-bottom: 12px;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.3);
        opacity: 0;
        transition: opacity 0.5s;
    }
    .alert.show { opacity: 1; }
    .alert-danger   { background: #dc3545; }
    .alert-success  { background: #198754; }
    .alert-warning  { background: #fd7e14; }

    .history-entry {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    body.dark-mode .history-entry { border-bottom-color: #334155; }

    .history-time {
        color: #6c757d;
        font-size: 11px;
        display: block;
        margin-bottom: 4px;
    }

    .history-danger  { color: #dc3545; font-weight: bold; }
    .history-success { color: #198754; font-weight: bold; }
</style>

<!-- ── HTML Structure ─────────────────────────────────────────────────── -->
<div id="header">INDIA NOC - SITE TOPOLOGY</div>
<div id="chartdiv"></div>

<button id="resetZoomBtn"    class="control-btn"><i class="bi bi-arrow-counterclockwise me-2"></i> Reset View</button>
<button id="settings-btn"     class="control-btn"><i class="bi bi-gear me-2"></i> Settings</button>
<button id="history-btn"      class="control-btn"><i class="bi bi-clock me-2"></i> History</button>
<button id="dark-mode-btn"    class="control-btn">
    <i class="bi bi-brightness-high me-2"></i><span>Dark Mode</span>
</button>

<!-- Legend -->
<div id="legend">
    <b>Legend</b><br>
    <div><span style="color:green;  font-size:22px">●</span> AFNET Site</div>
    <div><span style="color:yellow; font-size:22px">●</span> Site on Satcom</div>
    <div><span style="color:red;    font-size:22px">●</span> Unreachable</div>
    <div><span style="color:purple; font-size:22px">●</span> Purple Status</div>
    <div><span style="color:blue;   font-size:22px">●</span> Inactive</div>
</div>

<!-- Contact Panel -->
<div id="contact-panel">
    <div id="contact-header">
        <span id="contact-title">Site Details</span>
        <span>▼</span>
    </div>
    <div id="contact-content"></div>
</div>

<!-- Alerts Container -->
<div id="alert-container"></div>

<!-- History Panel -->
<div id="history-panel">
    <h4 style="margin:0 0 12px;">Site Status Changes</h4>
    <div id="history-list" style="min-height:100px;"></div>
    <button id="clear-history" style="margin-top:12px; width:100%; padding:8px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer;">
        Clear History
    </button>
</div>

<!-- Settings Panel -->
<div id="settings-panel">
    <div class="settings-title">Visibility</div>
    <div class="settings-row">AFNET Sites     <label class="switch"><input type="checkbox" id="showA" checked><span class="slider"></span></label></div>
    <div class="settings-row">Satcom Sites    <label class="switch"><input type="checkbox" id="showB" checked><span class="slider"></span></label></div>
    <div class="settings-row">Unreachable     <label class="switch"><input type="checkbox" id="showC" checked><span class="slider"></span></label></div>
    <div class="settings-row">Purple Status   <label class="switch"><input type="checkbox" id="showD" checked><span class="slider"></span></label></div>
    <div class="settings-row">Inactive Sites  <label class="switch"><input type="checkbox" id="showE" checked><span class="slider"></span></label></div>

    <div class="settings-title">Pulse Animation</div>
    <div class="settings-row">AFNET Sites     <label class="switch"><input type="checkbox" id="pulseA"><span class="slider"></span></label></div>
    <div class="settings-row">Satcom Sites    <label class="switch"><input type="checkbox" id="pulseB"><span class="slider"></span></label></div>
    <div class="settings-row">Unreachable     <label class="switch"><input type="checkbox" id="pulseC" checked><span class="slider"></span></label></div>
    <div class="settings-row">Purple Status   <label class="switch"><input type="checkbox" id="pulseD"><span class="slider"></span></label></div>
    <div class="settings-row">Inactive Sites  <label class="switch"><input type="checkbox" id="pulseE"><span class="slider"></span></label></div>

    <div class="settings-title">Marker Sizes</div>
    <div class="settings-row">
        Marker <span id="markerValue" class="size-label">6 px</span>
        <input type="range" id="markerSize" min="3" max="16" value="6">
    </div>
    <div class="settings-row">
        Pulse ring <span id="pulseValue" class="size-label">10 px</span>
        <input type="range" id="pulseSize" min="6" max="19" value="10">
    </div>

    <button id="saveSettings">Save Settings</button>
</div>

<!-- ── JavaScript ─────────────────────────────────────────────────────── -->
<script>
    // ── Theme Definition & Management ────────────────────────────────────
    const MAP_THEME = {
        light: {
            background: "#e8f0f2",
            polygonFill: "#5dade2",
            polygonHover: "#85c1e9",
            tooltipBg: "#ffffff",
            tooltipText: "#000000",
        },
        dark: {
            background: "#0f172a",
            polygonFill: "#1e293b",
            polygonHover: "#334155",
            tooltipBg: "#020617",
            tooltipText: "#f8fafc",
        }
    };

    let currentTheme = localStorage.getItem("mapTheme") || "light";
    let theme = MAP_THEME[currentTheme];

    // Apply initial theme class
    if (currentTheme === "dark") {
        document.body.classList.add("dark-mode");
    }

    // ── Constants ────────────────────────────────────────────────────────
    const SITE_COLORS = {
        A: "green",
        B: "yellow",
        C: "red",
        D: "purple",
        E: "blue"
    };

    const STATUS_NAMES = {
        green:  "AFNET Site",
        yellow: "Site on Satcom",
        red:    "Unreachable",
        purple: "Purple Status",
        blue:   "Inactive"
    };

    const DEFAULT_SETTINGS = {
        showA: true, showB: true, showC: true, showD: true, showE: true,
        pulseA: false, pulseB: false, pulseC: true, pulseD: false, pulseE: false,
        markerSize: 6,
        pulseSize: 10
    };

    let settings = JSON.parse(localStorage.getItem("mapSettings")) || { ...DEFAULT_SETTINGS };

    // Enforce valid ranges
    settings.markerSize = Math.max(3, Math.min(16, settings.markerSize));
    settings.pulseSize  = Math.max(6, Math.min(19, settings.pulseSize));
    if (settings.markerSize > settings.pulseSize) {
        settings.pulseSize = settings.markerSize + 2;
    }

    const PULSE_CONFIG = { opacity: 0.5, maxScale: 5, duration: 1600 };

    // ── AmCharts Initialization ──────────────────────────────────────────
    am4core.ready(function () {
        am4core.useTheme(am4themes_animated);

        const chart = am4core.create("chartdiv", am4maps.MapChart);
        chart.geodata = am4geodata_india2020High;
        chart.projection = new am4maps.projections.Miller();
        chart.zoomControl = new am4maps.ZoomControl();

        // Map polygons (states)
        const polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
        polygonSeries.useGeodata = true;
        const poly = polygonSeries.mapPolygons.template;
        poly.fill = am4core.color(theme.polygonFill);
        poly.strokeOpacity = 0.4;
        poly.tooltipText = "{name}";
        poly.states.create("hover").properties.fill = am4core.color(theme.polygonHover);

        // Site markers
        const imageSeries = chart.series.push(new am4maps.MapImageSeries());
        const template = imageSeries.mapImages.template;
        template.propertyFields.latitude  = "latitude";
        template.propertyFields.longitude = "longitude";
        template.tooltipText = "{title}";

        const pulseCircle = template.createChild(am4core.Circle);
        pulseCircle.adapter.add("radius", () => settings.pulseSize);
        pulseCircle.nonScaling = true;
        pulseCircle.propertyFields.fill = "color";
        pulseCircle.opacity = PULSE_CONFIG.opacity;
        pulseCircle.zIndex = 0;

        const markerCircle = template.createChild(am4core.Circle);
        markerCircle.adapter.add("radius", () => settings.markerSize);
        markerCircle.nonScaling = true;
        markerCircle.propertyFields.fill = "color";
        markerCircle.zIndex = 1;

        // Hide markers with unknown colors or disabled categories
        markerCircle.adapter.add("opacity", function(_, target) {
            const color = (target.dataItem?.dataContext?.color || "").toLowerCase().trim();
            if (!Object.values(SITE_COLORS).includes(color)) return 0;

            const showKey = {
                [SITE_COLORS.A]: "showA",
                [SITE_COLORS.B]: "showB",
                [SITE_COLORS.C]: "showC",
                [SITE_COLORS.D]: "showD",
                [SITE_COLORS.E]: "showE"
            }[color];

            return settings[showKey] ? 1 : 0;
        });

        // ── Pulse Animation Logic ────────────────────────────────────────
        function startPulse(circle) {
            if (circle._pulseAnim) circle._pulseAnim.stop();
            circle.scale = 1;
            circle.opacity = PULSE_CONFIG.opacity;
            circle._pulseAnim = circle.animate([
                { property: "scale",   from: 1,           to: PULSE_CONFIG.maxScale },
                { property: "opacity", from: PULSE_CONFIG.opacity, to: 0 }
            ], PULSE_CONFIG.duration);
            circle._pulseAnim.events.on("animationended", () => startPulse(circle));
        }

        function stopPulse(circle) {
            if (circle._pulseAnim) {
                circle._pulseAnim.stop();
                circle._pulseAnim = null;
            }
            circle.opacity = 0;
            circle.scale = 1;
        }

        function updatePulseForImage(image) {
            const data = image.dataItem?.dataContext;
            if (!data) return;
            const color = (data.color || "").toLowerCase().trim();
            if (!Object.values(SITE_COLORS).includes(color)) return;

            const pulse = image.children.getIndex(0);
            const shouldPulse = {
                [SITE_COLORS.A]: settings.pulseA,
                [SITE_COLORS.B]: settings.pulseB,
                [SITE_COLORS.C]: settings.pulseC,
                [SITE_COLORS.D]: settings.pulseD,
                [SITE_COLORS.E]: settings.pulseE
            }[color];

            shouldPulse ? startPulse(pulse) : stopPulse(pulse);
        }

        imageSeries.mapImages.template.events.on("inited", e => updatePulseForImage(e.target));
        imageSeries.mapImages.template.events.on("dataitemchanged", e => updatePulseForImage(e.target));

        // ── Site Click → Show Contact Info ───────────────────────────────
        template.events.on("hit", ev => {
            const ctx = ev.target.dataItem.dataContext;
            const color = (ctx.color || "").toLowerCase().trim();
            if (Object.values(SITE_COLORS).includes(color)) {
                loadContactInfo(ctx.title);
            }
        });

        chart.seriesContainer.events.on("hit", () => {
            document.getElementById("contact-panel").style.display = "none";
        });


        function loadContactInfo(siteName) {
            fetch(`/api/contact-info/${encodeURIComponent(siteName)}/`)
                .then(r => r.ok ? r.json() : [])
                .then(data => renderContact(siteName, data))
                .catch(() => renderContact(siteName, []));
        }

        function renderContact(name, contacts) {
            document.getElementById("contact-title").textContent = name;
            let content = document.getElementById("contact-content");
            if (contacts.length === 0) {
                content.innerHTML = "<i>No contact details available</i>";
            } else {
                let html = contacts.map(c => `
                    <tr><th>Email</th><td>${c.email || "—"}</td></tr>
                    <tr><th>Phone</th><td>${c.phone || "—"}</td></tr>
                    <tr><th>Address</th><td>${c.address || "—"}</td></tr>
                `).join("");
                content.innerHTML = `<table>${html}</table>`;
            }
            document.getElementById("contact-panel").style.display = "block";
        }

        document.getElementById("contact-header").onclick = () => {
            let c = document.getElementById("contact-content");
            c.style.display = c.style.display === "none" ? "block" : "none";
        };

        // ── Data Loading & Refresh ───────────────────────────────────────
        function loadSiteData() {
            fetch("{% url 'site-map-api' %}")
                .then(r => r.json())
                .then(raw => {
                    const valid = raw.filter(site => {
                        const c = (site.color || "").toLowerCase().trim();
                        return Object.values(SITE_COLORS).includes(c);
                    });
                    imageSeries.data = valid;
                    detectChanges(valid);
                    refreshAll();
                })
                .catch(err => console.error("Data fetch error:", err));
        }

        function refreshAll() {
            imageSeries.mapImages.each(updatePulseForImage);
            chart.invalidateRawData();
        }

        loadSiteData();
        setInterval(loadSiteData, 120000);

        // ── Change Detection, Alerts & History ───────────────────────────
        let prevColors = JSON.parse(localStorage.getItem("sitePreviousColors")) || {};
        let history    = JSON.parse(localStorage.getItem("siteChangeHistory"))  || [];
        const MAX_HISTORY = 100;

        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        function showAlert(msg, type = "warning") {
            if (document.hidden && Notification.permission === "granted") {
                new Notification("NOC Alert", { body: msg });
                return;
            }

            const div = document.createElement("div");
            div.className = `alert alert-${type}`;
            div.textContent = msg;
            document.getElementById("alert-container").appendChild(div);
            setTimeout(() => div.classList.add("show"), 10);
            setTimeout(() => {
                div.classList.remove("show");
                setTimeout(() => div.remove(), 500);
            }, 6500);
        }

        function addHistory(site, from, to) {
            const time = new Date().toLocaleString("en-IN", {
                day: "2-digit", month: "short", year: "numeric",
                hour: "2-digit", minute: "2-digit", hour12: true
            });
            history.unshift({ time, site, from, to });
            if (history.length > MAX_HISTORY) history.pop();
            localStorage.setItem("siteChangeHistory", JSON.stringify(history));
            updateHistoryUI();
        }

        function updateHistoryUI() {
            const list = document.getElementById("history-list");
            list.innerHTML = history.length === 0
                ? "<p style='text-align:center; color:#777;'>No changes yet.</p>"
                : history.map(h => {
                    let cls = (h.to === "red") ? "history-danger" : (h.from === "red") ? "history-success" : "";
                    return `
                    <div class="history-entry">
                        <div class="history-time">${h.time}</div>
                        <strong>${h.site}</strong><br>
                        <span class="${cls}">${STATUS_NAMES[h.from] || h.from} → ${STATUS_NAMES[h.to] || h.to}</span>
                    </div>`;
                }).join("");
        }

        function detectChanges(newData) {
            const nowColors = {};
            const nowSites = new Set();

            newData.forEach(s => {
                const t = s.title || "Unknown";
                const c = (s.color || "").toLowerCase().trim();
                if (!Object.values(SITE_COLORS).includes(c)) return;

                nowColors[t] = c;
                nowSites.add(t);

                if (prevColors[t] && prevColors[t] !== c) {
                    const old = prevColors[t];
                    let type = "warning", msg = `${t}: ${STATUS_NAMES[old]||old} → ${STATUS_NAMES[c]||c}`;

                    if (c === "red")    { type = "danger";   msg = `CRITICAL: ${t} is now UNREACHABLE`; }
                    else if (old === "red") { type = "success"; msg = `RECOVERED: ${t} is back online`; }

                    showAlert(msg, type);
                    addHistory(t, old, c);
                }
            });

            // Inactive → Active
            Object.keys(prevColors).forEach(t => {
                if (prevColors[t] === "blue" && !nowSites.has(t)) {
                    showAlert(`RECOVERED: ${t} is now ACTIVE`, "success");
                    addHistory(t, "blue", "active");
                }
            });

            // Active → Inactive
            newData.forEach(s => {
                const t = s.title;
                const c = (s.color || "").toLowerCase().trim();
                if (c === "blue" && prevColors[t] !== "blue") {
                    showAlert(`ALERT: ${t} is now INACTIVE`, "danger");
                    addHistory(t, prevColors[t] || "active", "blue");
                }
            });

            prevColors = { ...nowColors };
            localStorage.setItem("sitePreviousColors", JSON.stringify(prevColors));
        }

        // ── Settings UI Synchronization ──────────────────────────────────
        function syncSettingsUI() {
            ["A","B","C","D","E"].forEach(k => {
                document.getElementById(`show${k}`).checked  = settings[`show${k}`];
                document.getElementById(`pulse${k}`).checked = settings[`pulse${k}`];
            });
            document.getElementById("markerSize").value = settings.markerSize;
            document.getElementById("pulseSize").value  = settings.pulseSize;
            document.getElementById("markerValue").textContent = settings.markerSize + " px";
            document.getElementById("pulseValue").textContent  = settings.pulseSize + " px";
        }

        syncSettingsUI();

        // Link show ↔ pulse toggles
        ["A","B","C","D","E"].forEach(k => {
            const showEl  = document.getElementById(`show${k}`);
            const pulseEl = document.getElementById(`pulse${k}`);

            showEl.onchange = e => {
                settings[`show${k}`] = e.target.checked;
                if (!e.target.checked) {
                    settings[`pulse${k}`] = false;
                    pulseEl.checked = false;
                }
                refreshAll();
            };

            pulseEl.onchange = e => {
                settings[`pulse${k}`] = e.target.checked;
                if (e.target.checked) {
                    settings[`show${k}`] = true;
                    showEl.checked = true;
                }
                refreshAll();
            };
        });

        // Size sliders with constraints
        document.getElementById("markerSize").oninput = e => {
            let v = parseInt(e.target.value);
            if (v > settings.pulseSize) {
                settings.pulseSize = v + 2;
                document.getElementById("pulseSize").value = settings.pulseSize;
                document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
            }
            settings.markerSize = v;
            document.getElementById("markerValue").textContent = v + " px";
            refreshAll();
        };

        document.getElementById("pulseSize").oninput = e => {
            let v = Math.max(6, parseInt(e.target.value));
            e.target.value = v;
            if (v < settings.markerSize) {
                settings.markerSize = v;
                document.getElementById("markerSize").value = v;
                document.getElementById("markerValue").textContent = v + " px";
            }
            settings.pulseSize = v;
            document.getElementById("pulseValue").textContent = v + " px";
            refreshAll();
        };

        // ── UI Controls ──────────────────────────────────────────────────
        document.getElementById("saveSettings").onclick = () => {
            localStorage.setItem("mapSettings", JSON.stringify(settings));
            window.location.reload();
        };

        function closeOtherPanel(current) {
            const other = current === "settings-panel" ? "history-panel" : "settings-panel";
            document.getElementById(other)?.classList.remove("open");
        }

        document.getElementById("settings-btn").onclick = () => {
            closeOtherPanel("settings-panel");
            document.getElementById("settings-panel").classList.toggle("open");
        };

        document.getElementById("history-btn").onclick = () => {
            closeOtherPanel("history-panel");
            document.getElementById("history-panel").classList.toggle("open");
        };

        document.getElementById("resetZoomBtn").onclick = () => chart.goHome();

        document.getElementById("clear-history").onclick = () => {
            if (confirm("Clear history?")) {
                history = [];
                localStorage.setItem("siteChangeHistory", "[]");
                updateHistoryUI();
            }
        };

        // ── Theme Toggle (reloads page for clean re-render) ──────────────
        const darkBtn = document.getElementById("dark-mode-btn");
        const icon = darkBtn.querySelector("i");
        const span = darkBtn.querySelector("span");

        darkBtn.addEventListener("click", () => {
            const willBeDark = !document.body.classList.contains("dark-mode");
            localStorage.setItem("mapTheme", willBeDark ? "dark" : "light");
            window.location.reload();
        });

        // Set correct button text/icon on load
        if (currentTheme === "dark") {
            icon.className = "bi bi-moon-stars me-2";
            span.textContent = "Light Mode";
        }

        const chartdiv = document.getElementById("chartdiv");
        chartdiv.style.background = theme.background;


        // ── Initial UI State ─────────────────────────────────────────────
        updateHistoryUI();
    });

    // ── Watermark for authenticated users ────────────────────────────────
    {% if user.is_authenticated %}
    document.addEventListener("DOMContentLoaded", () => {
        const username = "{{ user.username|escapejs }}";
        const wm = document.createElement("div");
        wm.style.cssText = `position:fixed;inset:0;pointer-events:none;z-index:9999;user-select:none;display:grid;grid-template-columns:repeat(auto-fill,320px);grid-auto-rows:220px;transform:rotate(-30deg);color:rgba(0,0,0,0.03);font-size:42px;font-weight:bold;`;
        for (let i = 0; i < 60; i++) {
            const t = document.createElement("div");
            t.textContent = username;
            wm.appendChild(t);
        }
        document.body.appendChild(wm);
    });
    {% endif %}
</script>

{% endblock %}