{% extends 'sites/base_global_dashboard.html' %}
{% block content %}
{% load static %}

<!-- Load AmCharts libraries -->
<script src="{% static 'amcharts/core.js' %}"></script>
<script src="{% static 'amcharts/maps.js' %}"></script>
<script src="{% static 'amcharts/india2020High.js' %}"></script>
<script src="{% static 'amcharts/animated.js' %}"></script>

<style>
    #header {
        background-color: #002b5c;
        color: white;
        padding: 14px 24px;
        font-size: 24px;
        font-weight: bold;
    }

    #chartdiv {
        width: 100%;
        height: calc(100vh - 60px);
        background-color: #e8f0f2;
    }

    #legend {
        position: fixed;
        bottom: 100px;
        left: 280px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
    }

    #contact-panel {
        position: fixed;
        bottom: 100px;
        right: 40px;
        width: 380px;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 8px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        display: none;
        z-index: 1000;
    }

    #contact-header {
        background: #002b5c;
        color: white;
        padding: 10px 14px;
        font-size: 15px;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
    }

    #contact-content {
        padding: 12px;
        font-size: 13.5px;
    }

    #resetZoomBtn,
    #settings-btn,
    #history-btn {
        position: fixed;
        right: 24px;
        background: #002b5c;
        color: white;
        padding: 10px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        width: 110px;
        z-index: 1001;
    }

    #resetZoomBtn {
        top: 120px;
    }

    #settings-btn {
        top: 170px;
    }

    #history-btn {
        top: 220px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        text-align: left;
        padding: 6px;
        background: #f5f5f5;
        width: 35%;
    }

    td {
        padding: 6px;
    }

    #settings-panel {
        position: fixed;
        top: 270px;
        right: -300px;
        width: 280px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        padding: 16px;
        transition: right 0.3s ease;
        z-index: 1002;
        font-size: 14px;
    }

    #settings-panel.open {
        right: 24px;
    }

    .settings-title {
        font-weight: 600;
        margin: 14px 0 8px;
        color: #333;
    }

    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
    }

    .switch {
        position: relative;
        width: 38px;
        height: 20px;
    }

    .switch input {
        display: none;
    }

    .slider {
        position: absolute;
        inset: 0;
        background: #ccc;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
    }

    .slider:before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        left: 2px;
        bottom: 2px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    input:checked+.slider {
        background: #4caf50;
    }

    input:checked+.slider:before {
        transform: translateX(18px);
    }

    input[type=range] {
        width: 130px;
        accent-color: #002b5c;
    }

    .size-label {
        min-width: 70px;
        text-align: right;
        color: #555;
        font-size: 13px;
    }

    #saveSettings {
        margin-top: 16px;
        width: 100%;
        padding: 10px;
        background: #002b5c;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    /* ── Alerts ── */
    #alert-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        max-width: 400px;
    }

    .alert {
        padding: 14px 18px;
        margin-bottom: 12px;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.5s;
    }

    .alert.show {
        opacity: 1;
    }

    .alert-danger {
        background: #dc3545;
    }

    .alert-success {
        background: #198754;
    }

    .alert-warning {
        background: #fd7e14;
    }

    /* ── History Panel ── */
    #history-panel {
        position: fixed;
        top: 270px;
        right: -340px;
        width: 340px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        padding: 16px;
        transition: right 0.3s ease;
        z-index: 1003;
        max-height: 70vh;
        overflow-y: auto;
        font-size: 13px;
    }

    #history-panel.open {
        right: 24px;
    }

    .history-entry {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }

    .history-time {
        color: #6c757d;
        font-size: 11px;
        display: block;
        margin-bottom: 4px;
    }

    .history-danger {
        color: #dc3545;
        font-weight: bold;
    }

    .history-success {
        color: #198754;
        font-weight: bold;
    }
</style>

<div id="header">INDIA NOC - SITE TOPOLOGY</div>
<div id="chartdiv"></div>

<button id="resetZoomBtn">Reset View</button>
<div id="settings-btn">Settings</div>
<div id="history-btn">History</div>

<div id="settings-panel">
    <div class="settings-title">Visibility</div>
    <div class="settings-row">AFNET Sites
        <label class="switch"><input type="checkbox" id="showA" checked><span class="slider"></span></label>
    </div>
    <div class="settings-row">Satcom Sites
        <label class="switch"><input type="checkbox" id="showB" checked><span class="slider"></span></label>
    </div>
    <div class="settings-row">Unreachable
        <label class="switch"><input type="checkbox" id="showC" checked><span class="slider"></span></label>
    </div>

    <div class="settings-title">Pulse Animation</div>
    <div class="settings-row">AFNET Sites
        <label class="switch"><input type="checkbox" id="pulseA"><span class="slider"></span></label>
    </div>
    <div class="settings-row">Satcom Sites
        <label class="switch"><input type="checkbox" id="pulseB"><span class="slider"></span></label>
    </div>
    <div class="settings-row">Unreachable
        <label class="switch"><input type="checkbox" id="pulseC" checked><span class="slider"></span></label>
    </div>

    <div class="settings-title">Marker Sizes</div>
    <div class="settings-row">
        Marker <span id="markerValue" class="size-label">6 px</span>
        <input type="range" id="markerSize" min="3" max="16" value="6">
    </div>
    <div class="settings-row">
        Pulse ring <span id="pulseValue" class="size-label">10 px</span>
        <input type="range" id="pulseSize" min="6" max="19" value="10">
    </div>

    <button id="saveSettings">Save Settings</button>
</div>

<div id="legend">
    <b>Legend</b><br>
    <div><span style="color:green;font-size:22px">●</span> AFNET Site</div>
    <div><span style="color:yellow;font-size:22px">●</span> Satcom Site</div>
    <div><span style="color:red;font-size:22px">●</span> Unreachable</div>
</div>

<div id="contact-panel">
    <div id="contact-header">
        <span id="contact-title">Site Details</span>
        <span>▼</span>
    </div>
    <div id="contact-content"></div>
</div>

<!-- Alerts container -->
<div id="alert-container"></div>

<!-- History Panel -->
<div id="history-panel">
    <h4 style="margin:0 0 12px;">Site Status Changes</h4>
    <div id="history-list" style="min-height:120px;"></div>
    <button id="clear-history"
        style="margin-top:12px;width:100%;padding:8px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">Clear
        History</button>
</div>

<script>
    // ─────────────────────────────────────────────────────────────
    //          SETTINGS – change values here only
    // ─────────────────────────────────────────────────────────────

    const SITE_COLORS = {
        A: "green",
        B: "yellow",
        C: "red"
    };

    const DEFAULT_SETTINGS = {
        showA: true, showB: true, showC: true,
        pulseA: false, pulseB: false, pulseC: true,
        markerSize: 6,
        pulseSize: 10
    };

    const PULSE_CONFIG = {
        opacity: 0.5,
        maxScale: 5,
        duration: 1600
    };

    // ─────────────────────────────────────────────────────────────

    am4core.ready(function () {

        am4core.useTheme(am4themes_animated);

        let settings = JSON.parse(localStorage.getItem("mapSettings")) || { ...DEFAULT_SETTINGS };

        if (settings.markerSize > settings.pulseSize) {
            settings.pulseSize = settings.markerSize + 2;
        }
        if (settings.pulseSize < 6) settings.pulseSize = 6;
        if (settings.markerSize < 3) settings.markerSize = 3;

        const chart = am4core.create("chartdiv", am4maps.MapChart);
        chart.geodata = am4geodata_india2020High;
        chart.projection = new am4maps.projections.Miller();
        chart.zoomControl = new am4maps.ZoomControl();

        let polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
        polygonSeries.useGeodata = true;
        let poly = polygonSeries.mapPolygons.template;
        poly.fill = am4core.color("#5dade2");
        poly.strokeOpacity = 0.5;
        poly.tooltipText = "{name}";
        poly.states.create("hover").properties.fill = am4core.color("#85c1e9");

        let imageSeries = chart.series.push(new am4maps.MapImageSeries());
        let template = imageSeries.mapImages.template;
        template.propertyFields.latitude = "latitude";
        template.propertyFields.longitude = "longitude";
        template.tooltipText = "{title}";

        let pulse = template.createChild(am4core.Circle);
        pulse.adapter.add("radius", () => settings.pulseSize);
        pulse.nonScaling = true;
        pulse.propertyFields.fill = "color";
        pulse.opacity = PULSE_CONFIG.opacity;
        pulse.zIndex = 0;

        let marker = template.createChild(am4core.Circle);
        marker.adapter.add("radius", () => settings.markerSize);
        marker.nonScaling = true;
        marker.propertyFields.fill = "color";
        marker.opacity = 1;
        marker.zIndex = 1;

        marker.adapter.add("opacity", (_, target) => {
            let c = (target.dataItem?.dataContext?.color || "").toLowerCase();
            if (c === SITE_COLORS.A) return settings.showA ? 1 : 0;
            if (c === SITE_COLORS.B) return settings.showB ? 1 : 0;
            if (c === SITE_COLORS.C) return settings.showC ? 1 : 0;
            return 1;
        });

        function startPulse(circle) {
            if (circle._pulseAnim) circle._pulseAnim.stop();
            circle.scale = 1;
            circle.opacity = PULSE_CONFIG.opacity;
            circle._pulseAnim = circle.animate([
                { property: "scale", from: 1, to: PULSE_CONFIG.maxScale },
                { property: "opacity", from: PULSE_CONFIG.opacity, to: 0 }
            ], PULSE_CONFIG.duration);
            circle._pulseAnim.events.on("animationended", () => startPulse(circle));
        }

        function stopPulse(circle) {
            if (circle._pulseAnim) {
                circle._pulseAnim.stop();
                circle._pulseAnim = null;
            }
            circle.opacity = 0;
            circle.scale = 1;
        }

        function updatePulse(image) {
            let data = image.dataItem?.dataContext;
            if (!data) return;
            let c = (data.color || "").toLowerCase();
            let pulseCircle = image.children.getIndex(0);
            let shouldPulse =
                (c === SITE_COLORS.A && settings.pulseA) ||
                (c === SITE_COLORS.B && settings.pulseB) ||
                (c === SITE_COLORS.C && settings.pulseC);
            shouldPulse ? startPulse(pulseCircle) : stopPulse(pulseCircle);
        }

        imageSeries.mapImages.template.events.on("inited", e => updatePulse(e.target));
        imageSeries.mapImages.template.events.on("dataitemchanged", e => updatePulse(e.target));

        template.events.on("hit", ev => {
            loadContactInfo(ev.target.dataItem.dataContext.title);
        });

        chart.seriesContainer.events.on("hit", () => {
            document.getElementById("contact-panel").style.display = "none";
        });

        function loadContactInfo(siteName) {
            fetch(`/api/contact-info/${encodeURIComponent(siteName)}/`)
                .then(r => r.ok ? r.json() : [])
                .then(data => renderContact(siteName, data))
                .catch(() => renderContact(siteName, []));
        }

        function renderContact(name, contacts) {
            document.getElementById("contact-title").textContent = name;
            let content = document.getElementById("contact-content");
            if (contacts.length === 0) {
                content.innerHTML = "<i>No contact details available</i>";
            } else {
                let html = contacts.map(c => `
                <tr><th>Email</th><td>${c.email || "—"}</td></tr>
                <tr><th>Phone</th><td>${c.phone || "—"}</td></tr>
                <tr><th>Address</th><td>${c.address || "—"}</td></tr>
            `).join("");
                content.innerHTML = `<table>${html}</table>`;
            }
            document.getElementById("contact-panel").style.display = "block";
        }

        document.getElementById("contact-header").onclick = () => {
            let c = document.getElementById("contact-content");
            c.style.display = c.style.display === "none" ? "block" : "none";
        };

        // ─────────────────────────────────────────────────────────────
        //   CHANGE TRACKING + ALERTS + HISTORY
        // ─────────────────────────────────────────────────────────────

        let previousColors = JSON.parse(localStorage.getItem("sitePreviousColors")) || {};
        let changeHistory = JSON.parse(localStorage.getItem("siteChangeHistory")) || [];

        const MAX_HISTORY = 100;

        // ── Notification permission & helper ──
        let notificationPermission = "default";

        async function requestNotificationPermission() {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") {
                notificationPermission = "granted";
                return;
            }
            if (Notification.permission !== "denied") {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
            }
        }

        function showNotification(title, body, tag = "site-change") {
            if (notificationPermission !== "granted") return;
            new Notification(title, {
                body,
                tag,
                icon: "/static/favicon.ico" // change to your icon if you have one
            });
        }

        // Request permission on page load
        requestNotificationPermission();

        // ── Check if tab is visible/active ──
        function isTabVisible() {
            return !document.hidden;
        }

        function showChangeAlert(message, type = "warning") {
            const isVisible = isTabVisible();

            if (isVisible) {
                // In-tab floating alert
                const div = document.createElement("div");
                div.className = `alert alert-${type} show`;
                div.textContent = message;
                document.getElementById("alert-container").appendChild(div);
                setTimeout(() => {
                    div.classList.remove("show");
                    setTimeout(() => div.remove(), 600);
                }, 8000);
            } else {
                // Browser notification when tab is backgrounded
                let notifTitle = "Site Status Change";
                let notifBody = message;
                if (type === "danger") {
                    notifTitle = "CRITICAL: Site Unreachable";
                } else if (type === "success") {
                    notifTitle = "Site Recovered";
                }
                showNotification(notifTitle, notifBody);
            }
        }

        function addHistoryEntry(site, oldColor, newColor) {
            const now = new Date();
            const timeStr = now.toLocaleString("en-IN", {
                day: "2-digit", month: "short", year: "numeric",
                hour: "2-digit", minute: "2-digit", hour12: true
            });

            const entry = { time: timeStr, site, from: oldColor, to: newColor };

            changeHistory.unshift(entry);
            if (changeHistory.length > MAX_HISTORY) {
                changeHistory = changeHistory.slice(0, MAX_HISTORY);
            }

            localStorage.setItem("siteChangeHistory", JSON.stringify(changeHistory));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const list = document.getElementById("history-list");
            if (changeHistory.length === 0) {
                list.innerHTML = "<p style='text-align:center;color:#777;'>No status changes recorded yet.</p>";
                return;
            }

            let html = "";
            changeHistory.forEach(item => {
                let cls = "";
                if (item.to === "red") cls = "history-danger";
                else if (item.from === "red" && item.to !== "red") cls = "history-success";

                html += `
                <div class="history-entry">
                    <span class="history-time">${item.time}</span>
                    <strong>${item.site}</strong><br>
                    <span class="${cls}">${item.from} → ${item.to}</span>
                </div>
            `;
            });
            list.innerHTML = html;
        }

        function detectChanges(newData) {
            const current = {};

            newData.forEach(site => {
                const title = site.title || "Unknown Site";
                const color = (site.color || "").toLowerCase().trim();
                current[title] = color;

                if (previousColors[title]) {
                    const old = previousColors[title];
                    if (old !== color) {
                        let alertType = "warning";
                        let msg = `${title}: ${old} → ${color}`;

                        if (color === "red") {
                            alertType = "danger";
                            msg = `CRITICAL: ${title} is now UNREACHABLE (${old} → red)`;
                        } else if (old === "red") {
                            alertType = "success";
                            msg = `RECOVERED: ${title} is back online (${old} → ${color})`;
                        }

                        showChangeAlert(msg, alertType);
                        addHistoryEntry(title, old, color);
                    }
                }
            });

            previousColors = { ...current };
            localStorage.setItem("sitePreviousColors", JSON.stringify(previousColors));
        }

        function loadSiteData() {
            fetch("{% url 'site-map-api' %}")
                .then(r => r.json())
                .then(data => {
                    imageSeries.data = data;
                    detectChanges(data);
                    refreshAll();
                })
                .catch(err => console.error("Site data error:", err));
        }

        loadSiteData();
        setInterval(loadSiteData, 12000);

        function refreshAll() {
            imageSeries.mapImages.each(updatePulse);
            chart.invalidateRawData();
        }

        updateHistoryDisplay();

        // ── Settings UI sync ──
        function syncUI() {
            document.getElementById("showA").checked = settings.showA;
            document.getElementById("showB").checked = settings.showB;
            document.getElementById("showC").checked = settings.showC;
            document.getElementById("pulseA").checked = settings.pulseA;
            document.getElementById("pulseB").checked = settings.pulseB;
            document.getElementById("pulseC").checked = settings.pulseC;
            document.getElementById("markerSize").value = settings.markerSize;
            document.getElementById("pulseSize").value = settings.pulseSize;
            document.getElementById("markerValue").textContent = settings.markerSize + " px";
            document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
        }

        syncUI();

        // ── Close other panel when one is opened ──
        function closeOtherPanel(currentId) {
            const otherId = currentId === "settings-panel" ? "history-panel" : "settings-panel";
            const other = document.getElementById(otherId);
            if (other && other.classList.contains("open")) {
                other.classList.remove("open");
            }
        }

        document.getElementById("settings-btn").onclick = () => {
            const panel = document.getElementById("settings-panel");
            closeOtherPanel("settings-panel");
            panel.classList.toggle("open");
        };

        document.getElementById("history-btn").onclick = () => {
            const panel = document.getElementById("history-panel");
            closeOtherPanel("history-panel");
            panel.classList.toggle("open");
        };

        function linkToggles(showId, pulseId) {
            document.getElementById(showId).onchange = e => {
                settings[showId] = e.target.checked;
                if (!e.target.checked) {
                    settings[pulseId] = false;
                    document.getElementById(pulseId).checked = false;
                }
                refreshAll();
            };

            document.getElementById(pulseId).onchange = e => {
                settings[pulseId] = e.target.checked;
                if (e.target.checked) {
                    settings[showId] = true;
                    document.getElementById(showId).checked = true;
                }
                refreshAll();
            };
        }

        linkToggles("showA", "pulseA");
        linkToggles("showB", "pulseB");
        linkToggles("showC", "pulseC");

        document.getElementById("markerSize").oninput = e => {
            let val = parseInt(e.target.value);
            if (val > settings.pulseSize) {
                settings.pulseSize = val + 2;
                document.getElementById("pulseSize").value = settings.pulseSize;
                document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
            }
            settings.markerSize = val;
            document.getElementById("markerValue").textContent = val + " px";
            refreshAll();
        };

        document.getElementById("pulseSize").oninput = e => {
            let val = parseInt(e.target.value);
            if (val < 6) {
                val = 6;
                e.target.value = 6;
            }
            if (val < settings.markerSize) {
                settings.markerSize = val;
                document.getElementById("markerSize").value = val;
                document.getElementById("markerValue").textContent = val + " px";
            }
            settings.pulseSize = val;
            document.getElementById("pulseValue").textContent = val + " px";
            refreshAll();
        };

        document.getElementById("saveSettings").onclick = () => {
            localStorage.setItem("mapSettings", JSON.stringify(settings));
            window.location.reload(true);
        };

        document.getElementById("clear-history").onclick = () => {
            if (confirm("Clear all change history?")) {
                changeHistory = [];
                localStorage.setItem("siteChangeHistory", JSON.stringify([]));
                updateHistoryDisplay();
            }
        };

        document.getElementById("resetZoomBtn").onclick = () => chart.goHome();
    });
</script>

{% if user.is_authenticated %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const username = "{{ user.username|escapejs }}";
        const wm = document.createElement("div");
        wm.style.cssText = `position:fixed;inset:0;pointer-events:none;z-index:9999;user-select:none;display:grid;grid-template-columns:repeat(auto-fill,320px);grid-auto-rows:220px;transform:rotate(-30deg);color:rgba(0,0,0,0.04);font-size:42px;font-weight:bold;`;
        for (let i = 0; i < 60; i++) { let t = document.createElement("div"); t.textContent = username; wm.appendChild(t); }
        document.body.appendChild(wm);
    });
</script>
{% endif %}

{% endblock %}