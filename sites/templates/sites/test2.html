{% extends 'sites/base_global_dashboard.html' %}
{% block content %}
{% load static %}

<!-- Libraries -->
<script src="{% static 'amcharts/core.js' %}"></script>
<script src="{% static 'amcharts/maps.js' %}"></script>
<script src="{% static 'amcharts/india2020High.js' %}"></script>
<script src="{% static 'amcharts/animated.js' %}"></script>
<!-- <style src="{% static 'css/india_map_css.css' %}"></style> -->
<link rel="stylesheet" href="{% static 'css/india_map_css.css' %}">
    
<!-- Styles -->


<div id="main-content-wrapper">

    <div id="map-column">

        <div id="chartdiv"></div>
        <button id="resetZoomBtn" class="control-btn"><i class="bi bi-arrow-counterclockwise me-2"></i> Reset
            View</button>
        <button id="settings-btn" class="control-btn"><i class="bi bi-gear me-2"></i> Settings</button>
        <button id="dark-mode-btn" class="control-btn">
            <i class="bi bi-brightness-high me-2"></i><span>Dark Mode</span>
        </button>

        <div id="legend">
            <b>Legend</b><br>
            <div><span style="color:green; font-size:22px">●</span> AFNET Site</div>
            <div><span style="color: yellow; font-size:22px">●</span> Site on Satcom</div>
            <div><span style="color:red; font-size:22px">●</span>Unreachable</div>
            <div><span style="color:orange; font-size:22px">●</span> IACCS Nodes</div>
        </div>

        <div id="last-updated">
            Last updated: <span id="last-update-time">-</span>
        </div>
    </div>
    <div id="sidebar-column">
        <button id="sidebar-toggle" title="Collapse sidebar">→</button>

        <div class="sidebar-content">

            <!-- Site Search -->

            <div class="mb-4 position-relative"> <input type="text" id="site-search"
                    placeholder="Search sites (e.g. MCC)" autocomplete="off">
                <div id="search-results"></div>
            </div>

            <div class="panel-header" id="group-header">
                <span>Site Groups</span>
                <span>▼</span>
            </div>

            <div class="panel-content" id="group-content">
                <!-- Group selector -->
                <div class="btn-group btn-group-sm w-100 mb-3">
                    <button class="btn btn-outline-light group-btn active" data-group="group_A">IACCS</button>
                    <button class="btn btn-outline-light group-btn" data-group="group_B">DC</button>
                </div>

                <!-- Group sites list -->

                <div id="group-sites-list" class="city-container"></div>
                <div id="group-empty" style="text-align:center; color:var(--text-muted); padding:30px 0; display:none;">
                    No sites in this group
                </div>
            </div>

            <!-- MCT and Satcom display codes -->
            <div class="panel-header" id="subtype-header">
                <span>MCT & Satcom</span>
                <span id="subtype-arrow"></span>
            </div>

            <div class="panel-content" id="subtype-content">
                <!-- Group selector -->
                <div class="btn-group btn-group-sm w-100 mb-3">
                    <button class="btn btn-outline-light type-btn active" data-type="MCT_Vehicle">MCT</button>
                    <button class="btn btn-outline-light type-btn" data-type="SATCOM">SATCOM</button>
                </div>

                <div id="subtype-list"></div>
                <!-- Group sites list -->
                <!-- <div id="subtype-data-container"></div> -->
                <div id="subtype-empty"
                    style="text-align: center; color: var(--text-muted); padding: 30px 0; display: none;">
                    No Data in this group
                </div>
            </div>

            <!-- Current Active Issues -->
            <div class="panel-header" id="problems-header">
                <span>Current Active Issues</span>
                <span>▼</span>
            </div>

            <div class="panel-content" id="problems-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class=" mb-0">
                        Current Active Issues
                        <span id="issues-count" class="badge bg-danger ms-2"
                            style="font-size:0.8rem; display:none;">0</span>
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light sort-btn active" data-sort="time">Newest</button>
                        <button class="btn btn-outline-light sort-btn" data-sort="name">Name</button>
                        <button class="btn btn-outline-light sort-btn" data-sort="color">Color</button>
                    </div>
                </div>

                <div id="problems-list"></div>

                <div class="glass-card" id="city-shelf">
                    <div id="city-list" class="city-container"></div>
                </div>

                <div id="problems-empty"
                    style="text-align:center; color:var(--text-muted); padding:50px 0; display:none;">
                    No active issues detected
                </div>
            </div>

            <!-- Status History -->

            <div class="panel-header" id="history-header">
                <span id="history-panel-title">Status History</span>
                <span>▼</span>
            </div>

            <div class="panel-content" id="history-content">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h6 class="mb-0" id="history-panel-subtitle">Status History</h6>
                    <div class="d-flex align-items-center gap-2">
                        <button id="history-back-btn" style="display:none;"
                            class="btn btn-outline-light btn-sm">Back</button>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light history-sort-btn active" data-order="desc">Newest
                                first</button>
                            <button class="btn btn-outline-light history-sort-btn" data-order="asc">Oldest
                                first</button>

                        </div>
                    </div>
                </div>

                <div id="history-list" style="height: 300px; overflow-y:auto;"></div>
            </div>

            <!-- Contact Panel (will be moved here when sidebar open) -->

            <div id="contact-panel" style="display:none;">

                <div id="contact-header">
                    <span id="contact-title">Site Details</span>
                    <span>▼</span>
                    <div id="contact-content" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Panel -->

<div id="settings-panel">
    <div class="settings-title">Visibility</div>
    <div class="settings-row">AFNET Sites <label class="switch"><input type="checkbox" id="showA" checked><span
                class="slider"></span></label></div>

    <div class="settings-row">Satcom Sites <label class="switch"><input type="checkbox" id="showB" checked><span
                class="slider"></span></label></div>

    <div class="settings-row">Unreachable <label class="switch"><input type="checkbox" id="showC" checked><span
                class="slider"></span></label></div>

    <div class="settings-row">IACCS Sites <label class="switch"><input type="checkbox" id="showD" checked><span
                class="slider"></span></label></div>


    <div class="settings-title">Pulse Animation</div>
    <div class="settings-row">AFNET Sites <label class="switch"><input type="checkbox" id="pulseA"><span
                class="slider"></span></label></div>

    <div class="settings-row">Satcom Sites <label class="switch"><input type="checkbox" id="pulseB"><span
                class="slider"></span></label></div>

    <div class="settings-row">Unreachable <label class="switch"><input type="checkbox" id="pulseC" checked><span
                class="slider"></span></label></div>

    <div class="settings-row">IACCS Sites <label class="switch"><input type="checkbox" id="pulseD"><span
                class="slider"></span></label></div>


    <div class="settings-title">Marker Sizes</div>


    <div class="settings-row">
        Marker <span id="markerValue" class="size-label">6 px</span>
        <input type="range" id="markerSize" min="3" max="16" value="6">
    </div>
    <div class="settings-row">
        Pulse ring <span id="pulseValue" class="size-label">10 px</span>
        <input type="range" id="pulseSize" min="6" max="19" value="10">
    </div>

    <button id="saveSettings">Save Settings</button>

</div>

<div id="alert-container"></div>

<!-- JavaScript -->

<script>

    let iaccsNodes = [
        { node_name: "IACCS_Node_1", type: "OG", node_location: "DELHI",    latitude: 28.6139, longitude: 77.2090, status: "UP" },
        { node_name: "IACCS_Node_2", type: "OG", node_location: "DELHI",    latitude: 28.6139, longitude: 77.2090, status: "UP" },
        { node_name: "IACCS_Node_3", type: "OG", node_location: "CHENNAI",  latitude: 13.0827, longitude: 80.2707, status: "UP" },
        { node_name: "IACCS_Node_4", type: "OG", node_location: "KOLKATA",  latitude: 22.5726, longitude: 88.3639, status: "UP" },
        { node_name: "IACCS_Node_5", type: "OG", node_location: "BANGALORE",latitude: 12.9716, longitude: 77.5946, status: "UP" },
        { node_name: "IACCS_Node_6", type: "OG", node_location: "BANGALORE",latitude: 12.9716, longitude: 77.5946, status: "UP" },
        { node_name: "IACCS_Node_7", type: "UG", node_location: "BANGALORE",latitude: 12.9716, longitude: 77.5946, status: "UP" },
        { node_name: "IACCS_Node_8", type: "UG", node_location: "BANGALORE",latitude: 12.9716, longitude: 77.5946, status: "UP" },
    ];

    const dc_locations = ["DELHI", "MUMBAI", "KOLKATA", "CHENNAI"];


    let currentGroup = "group_A";

    // - Theme & Constants

    const MAP_THEME = {
        light: { background: "#f1f5f9", polygonFill: "#60a5fa", polygonHover: "#93c5fd", polygonStroke: "#e2e8f0", tooltipBg: "#ffffff", tooltipText: "#0f172a" },
        dark: { background: "#0b1121", polygonFill: "#60a5fa", polygonHover: "#93c5fd", polygonStroke: "#e2e8f0", tooltipBg: "#ffffff", tooltipText: "#0f172a" }
    };


    // };

    let currentTheme = localStorage.getItem("mapTheme") || "dark";

    let theme = MAP_THEME[currentTheme];

    const root = document.documentElement;

    if (currentTheme === "dark") document.body.classList.add("dark-mode");

    if (currentTheme === "dark") {
        root.style.setProperty("--bg-color", "#0f172a");
    }
    else {
        root.style.setProperty("--bg-color", "#e8f0f2");
    }


    const SITE_COLORS = { A: "green", B: "yellow", C: "red", D: "orange" };

    let settings = JSON.parse(localStorage.getItem("mapSettings")) || {
        showA: true, showB: true, showC: true, showD: true, showE: true,
        pulseA: false, pulseB: false, pulseC: true, pulseD: false, pulseE: false,
        markerSize: 6, pulseSize: 10
    };


    const PULSE_CONFIG = { opacity: 0.45, maxScale: 5.5, duration: 1800 };

    // - Helpers
    function formatDateLocal(dt) {
        return new Date(dt).toLocaleString('en-IN', {
            day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: true
        }).replace(/,/g, '');
    }

    function showAlert(message, type = "danger") {
        const container = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }

    function debounce(fn, delay = 200) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn(...args), delay);
        };
    }

    // ── AmCharts ─────────────────────────────────────────────────────────────
    let chartInstance;

    am4core.ready(function () {
        am4core.useTheme(am4themes_animated);
        chartInstance = am4core.create("chartdiv", am4maps.MapChart);
        chartInstance.geodata = am4geodata_india2020High;
        chartInstance.projection = new am4maps.projections.Miller();
        chartInstance.zoomControl = new am4maps.ZoomControl();
        chartInstance.tooltip.background.fill = am4core.color(theme.tooltipBg);
        chartInstance.tooltip.label.fill = am4core.color(theme.tooltipText);
        chartInstance.background.fill = am4core.color(theme.background);

        const polygonSeries = chartInstance.series.push(new am4maps.MapPolygonSeries());
        polygonSeries.useGeodata = true;
        const poly = polygonSeries.mapPolygons.template;
        poly.fill = am4core.color(theme.polygonFill);
        poly.stroke = am4core.color(theme.polygonStroke);
        poly.strokeOpacity = 0.35;
        poly.tooltipText = "{name} - {address}";
        poly.states.create("hover").properties.fill = am4core.color(theme.polygonHover);

        const imageSeries = chartInstance.series.push(new am4maps.MapImageSeries());
        const template = imageSeries.mapImages.template;
        template.propertyFields.latitude = "latitude";
        template.propertyFields.longitude = "longitude";
        template.tooltipText = "{title} - {address}";

        const pulseCircle = template.createChild(am4core.Circle);
        pulseCircle.adapter.add("radius", () => settings.pulseSize);
        pulseCircle.nonScaling = true;
        pulseCircle.propertyFields.fill = "color";
        pulseCircle.opacity = PULSE_CONFIG.opacity;
        pulseCircle.zIndex = 0;

        const markerCircle = template.createChild(am4core.Circle);
        markerCircle.adapter.add("radius", () => settings.markerSize);
        markerCircle.nonScaling = true;
        markerCircle.propertyFields.fill = "color";
        markerCircle.zIndex = 1;

        markerCircle.adapter.add("opacity", (_, target) => {
            const c = (target.dataItem?.dataContext?.color || "").toLowerCase().trim();
            if (!Object.values(SITE_COLORS).includes(c)) return 0;
            const key = Object.keys(SITE_COLORS).find(k => SITE_COLORS[k] === c);
            return settings[`show${key}`] ? 1 : 0;
        });

        function zoomToLatLon(lat, lon, zoomLevel = 8, animate = true) {
            if (!chartInstance) return;

            chartInstance.zoomToGeoPoint(
                { latitude: lat, longitude: lon },
                zoomLevel,
                animate
            );
        }



        function focusSiteTemporarily(siteTitle, duration = 5000) {
            console.log("focus site function invoked11");

            if (!imageSeries) {
                console.log("image series not found");
                return;
            }
            let found = false;
            imageSeries.mapImages.each(function (img) {
                if (found === true) return;
                console.log(`checking image index ${img}`);
                if (!img || !img.dataItem) {
                    console.log("no dataitem or img found");
                    return;
                }


                const ctx = img.dataItem.dataContext;

                if (!ctx) {
                    console.log("no datacontext found on dataitem");
                    return;
                }

                img.isHover = false;

                if (img.tooltip) {
                    img.tooltip?.hide();
                    console.log("reset hover and tooltip");
                }
                else {
                    console.log("no tooltip instance on image");
                }

                if (ctx.title === siteTitle) {
                    found = true;
                    img.isHover = true;
                    img.showTooltip();
                }
            });
        }

        let subtypeData = [];
        let currentSubtype = "MCT_Vehicle";

        document.getElementById('subtype-header').addEventListener('click', () => {
            const content = document.getElementById('subtype-content');
            content.style.display = content.style.display === "none" ? "block" : "none";
            const arrow = document.getElementById("subtype-arrow");
            arrow.textContent = content.style.display === "none" ? "" : "a";
            if (content.style.display === "block") refreshMCT_SatcomData();
        });


        async function loadMCT_SatcomData() {
            console.log("fetching data from db");
            try {
                const response = await fetch("{% url 'mct_satcom_india_map' %}")
                if (!response.ok) throw new Error(`HTTP Error status ${response.status} -`);

                const data = await response.json();

                if (!Array.isArray(data)) {
                    console.warn("feched data is not array returning empty array");
                    return [];
                }

                return data.filter(item => item.name && item.data_type && item.status);
            }
            catch (err) {
                console.error(err);
                showAlert("Failed to load site data", "danger");
                return [];
            }
        }
        async function refreshMCT_SatcomData() {
            const data = await loadMCT_SatcomData();
            if (data.length) subtypeData = data;
            renderMCT_SatcomData(currentSubtype);
        }

        window.loadMCT_SatcomData = loadMCT_SatcomData;

        function renderMCT_SatcomData(selectedGroup) {
            const container = document.getElementById('subtype-list');
            const emptyDiv = document.getElementById('subtype-empty');
            container.innerHTML = '';
            const filteredData = subtypeData.filter(d => d.data_type ===
                selectedGroup);

            if (filteredData.length === 0) {
                emptyDiv.style.display = 'block';
                return;
            }
            else {
                emptyDiv.style.display = 'none';
            }

            const statusList = ['FULLY_OPS', 'RESTRICTED_OPS', 'NON_OPS'];
            statusList.forEach(status => {
                const items = filteredData.filter(d => d.status === status);
                if (items.length > 0) {
                    const statusHeader = document.createElement('div');
                    statusHeader.textContent = `${status} (Total:${items.length})`;
                    statusHeader.style.fontWeight = '700';
                    statusHeader.marginTop = "10px";
                    statusHeader.marginBottom = "6px";
                    statusHeader.style.color = '#off';
                    statusHeader.style.fontSize = "14px";
                    container.appendChild(statusHeader);
                    const row = document.createElement('div');
                    row.style.display = "flex";
                    row.style.flexWrap = "wrap";
                    row.style.gap = "6px";
                    row.style.marginBottom = "10px";
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item.name;
                        div.style.backgroundImage = "linear-gradient(45deg, #ff00ff, #00ffff)";
                        div.style.color = '#000';
                        div.style.fontWeight = '600';
                        div.style.padding = '4px 10px';
                        div.style.borderRadius = '6px';
                        div.style.boxShadow = "0 0 8px rgba(0, 255, 255, 0.6)";
                        div.style.textShadow = "0 0 4px #00ffff";
                        div.style.fontFamily = 'monospace';
                        div.style.display = "inline-block";
                        row.appendChild(div);
                    });
                    container.appendChild(row);
                }
            });

        }
        document.querySelectorAll(".type-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".type-btn")
                    .forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                currentSubtype = btn.dataset.type;
                renderMCT_SatcomData(currentSubtype);
            });
        });




        document.addEventListener("DOMContentLoaded", async () => {
            await refreshMCT_SatcomData();
            setInterval(refreshMCT_SatcomData, 12000);
        });


        function loadIACCSData() {
            fetch("{% url 'india_map_iaccs_status' %}")
                .then(r => r.json())
                .then(sitesdata => {
                    const countByTitle = {};

                    sitesdata.forEach(item => {
                        countByTitle[item.title] = item.count;
                    });
                    console.log("counttitle data is", countByTitle);
                    siteData.forEach(site => {
                        const count = countByTitle[site.title];

                        if (count !== undefined) {
                            const totalDots = site.status.length;
                            site.status = site.status.map((dot, index) => {
                                return index < count ? "red" : "green";
                            });
                        }

                        console.log(allSitesData);



                        

                        if (site.group === "group_B") {
                            const newColor = colorByTitle[site.title];
                            if (newColor) {
                                site.status = site.status.map(() => newColor);
                            } else {
                                console.log("color is not found");
                            }
                        }

                    });
                })
                .catch(err => {
                    console.error(err);
                    showAlert("Failed to load IACCS data", "danger");
                });
        }

        //function for AECMS, OPS, TEST groups

        const groupList = document.getElementById("group-sites-list");
        const groupEmpty = document.getElementById("group-empty");

        function renderGroupSites(group) {
            const filtered = siteData.filter(s => s.group === group);
            groupList.innerHTML = "";
            groupEmpty.style.display = filtered.length ? "none" : "block";

            filtered.forEach(site => {
                const div = document.createElement("div");
                div.className = "group-site";

                div.onclick = () => {
                    zoomToLatLon(site.latitude, site.longitude, 10);
                    setTimeout(() => { focusSiteTemporarily(site.title, 5000); }, 600);
                };

                let dotsHtml = site.status.map((s, index) => {
                    let label = s === 'green' ? 'Reachable' : 'Alert';
                    return `<div class="dot bg-${s}" data-label="${site.title} #${index + 1}: ${label}"></div>`;
                }).join('');

                div.innerHTML = `
                    <span class="city-name" > ${site.title}</span> 
                    <div class="status-dots">${dotsHtml}</div> 
                `;
                groupList.appendChild(div);
            });
        }

        document.querySelectorAll(".group-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".group-btn").forEach(b =>
                    b.classList.remove("active"));
                btn.classList.add("active");
                currentGroupbtn.dataset.group; renderGroupSites(currentGroup);
            });
        });

        function showIACCSData() {
            loadIACCSData();
            renderGroupSites(currentGroup);
        }
        showIACCSData();
        setInterval(showIACCSData, 120000);

        document.getElementById("group-header").addEventListener("click", () => {
            setTimeout(() => {
                renderGroupSites(currentGroup);
            }, 0)
        });


        function startPulse(circle) {
            if (circle._pulseAnim) circle._pulseAnim.stop();
            circle.scale = 1;
            circle.opacity = PULSE_CONFIG.opacity;

            circle._pulseAnim = circle.animate([
                { property: "scale", from: 1, to: PULSE_CONFIG.maxScale },
                { property: "opacity", from: PULSE_CONFIG.opacity, to: 0 }
            ], PULSE_CONFIG.duration);

            circle._pulseAnim.events.on("animationended", () => startPulse(circle));
        }

        function stopPulse(circle) {
            if (circle._pulseAnim) circle._pulseAnim.stop();
            circle.opacity = 0;
            circle.scale = 1;
        }

        function updatePulse(image) {
            const data = image.dataItem?.dataContext;
            if (!data) return;
            const c = (data.color || "").toLowerCase().trim();
            if (!Object.values(SITE_COLORS).includes(c)) return;

            const pulse = image.children.getIndex(0);
            const key = Object.keys(SITE_COLORS).find(k => SITE_COLORS[k] === c);

            if (settings[`pulse${key}`]) {
                startPulse(pulse);
            } else {
                stopPulse(pulse);
            }
        }

        imageSeries.mapImages.template.events.on("inited", e => updatePulse(e.target));
        imageSeries.mapImages.template.events.on("dataitemchanged", e => updatePulse(e.target));


        template.events.on("hit", ev => {
            const ctx = ev.target.dataItem.dataContext;
            fetch(`/api/site-contact-info/${encodeURIComponent(ctx.title)}/`)
                .then(r => r.ok ? r.json() : [])
                .then(data => {
                    document.getElementById("contact-title").textContent = ctx.title;
                    const content = document.getElementById("contact-content");
                    content.innerHTML = data.length === 0
                        ? "<i style='color:var(--text-muted)'>No contact details available</i>"
                        : `<table>${data.map(c => `
                        <tr><th>Email</th><td>${c.email || "-"}</td></tr>
                        <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
                        <tr><th>Address</th><td>${c.address || "-"}</td></tr>
                        <tr><th>EN Details</th><td><a href="/getnasdetails_india_map/${c.id}/">view EN Details</a></td></tr>
                    `).join("")}</table>`;

                    document.getElementById("contact-panel").style.display = "block";
                    document.getElementById("contact-content").style.display = "block";
                })
                .catch(() => {
                    showAlert("Failed to load contact info", "danger");
                    document.getElementById("contact-panel").style.display = "block";
                });
        });

        chartInstance.seriesContainer.events.on("hit", () => {
            document.getElementById("contact-panel").style.display = "none";
        });

        // ────────────────────────────────────────────────
        // Data Loading
        // ────────────────────────────────────────────────

        let allSitesData = [];
        let colorByTitle = {};

        function loadSiteData() {
            fetch("{% url 'site-map-api' %}")
                .then(r => r.json())
                .then(raw => {
                    allSitesData = raw.filter(s => Object.values(SITE_COLORS).includes((s.color || "").toLowerCase().trim()));
                    imageSeries.data = allSitesData;
                    updateProblemsDisplay(allSitesData);
                    refreshAll();
                    document.getElementById("last-update-time").textContent = formatDateLocal(new Date());
                    colorByTitle = Object.fromEntries(allSitesData.map(item => [item.title.trim(), item.color]));


                })
                .catch(err => {
                    console.error(err);
                    showAlert("Failed to load site data", "danger");
                });
        }

        function refreshAll() {
            imageSeries.mapImages.each(updatePulse);
            chartInstance.invalidateRawData();
        }

        loadSiteData();
        setInterval(loadSiteData, 120000);

        // ────────────────────────────────────────────────
        // Sidebar Collapse
        // ────────────────────────────────────────────────

        const sidebar = document.getElementById('sidebar-column');
        const toggleBtn = document.getElementById('sidebar-toggle');
        const contactPanel = document.getElementById('contact-panel');
        const sidebarContent = document.querySelector('#sidebar-column .sidebar-content');

        function updateContactPosition() {
            if (sidebar.classList.contains('collapsed')) {
                document.body.appendChild(contactPanel);
                contactPanel.style.position = "fixed";
                contactPanel.style.bottom = "100px";
                contactPanel.style.right = "40px";
                contactPanel.style.width = "400px";
                contactPanel.style.margin = "0";
            } else {
                sidebarContent.appendChild(contactPanel);
                contactPanel.style.position = "relative";
                contactPanel.style.bottom = "auto";
                contactPanel.style.right = "auto";
                contactPanel.style.width = "100%";
                contactPanel.style.maxWidth = "380px";
                contactPanel.style.margin = "20px 0";
            }
        }

        if (localStorage.getItem('sidebarCollapsed') === "true") {
            sidebar.classList.add('collapsed');
            toggleBtn.textContent = '»';
            toggleBtn.title = 'Expand sidebar';
            updateContactPosition();
        }

        toggleBtn.addEventListener('click', () => {
            const collapsed = sidebar.classList.toggle('collapsed');
            toggleBtn.textContent = collapsed ? '»' : '«';
            toggleBtn.title = collapsed ? 'Expand sidebar' : 'Collapse sidebar';
            localStorage.setItem('sidebarCollapsed', collapsed);
            updateContactPosition();
        });



        //Site Search    
        const searchInput = document.getElementById("site-search");
        const searchResults = document.getElementById("search-results");

        searchInput.addEventListener("input", debounce(() => {
            const query = searchInput.value.toLowerCase().trim();
            searchResults.innerHTML = "";
            searchResults.style.display = "none";

            if (query.length < 2) return;

            const matches = allSitesData.filter(s =>
                s.title.toLowerCase().includes(query) ||
                (s.address || "").toLowerCase().includes(query)
            );

            if (matches.length === 0) {
                searchResults.innerHTML = '<div class="p-3 text-center text-muted">No matching sites</div>';
            } else {
                matches.forEach(site => {
                    const item = document.createElement("div");
                    item.className = "search-item";
                    item.textContent = site.title;
                    item.onclick = () => {
                        zoomToLatLon(site.latitude, site.longitude, 10);
                        setTimeout(() => focusSiteTemporarily(site.title, 5000), 600);
                        searchInput.value = "";
                        searchResults.style.display = "none";
                    };
                    searchResults.appendChild(item);
                });
            }
            searchResults.style.display = "block";
        }, 300));

        document.addEventListener("click", e => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = "none";
            }
        });


        function loadContactInfo(siteName) {
            fetch(`/api/site-contact-info/${encodeURIComponent(siteName)}/`)
                .then(r => r.ok ? r.json() : [])
                .then(data => {
                    document.getElementById("contact-title").textContent = siteName;
                    const content = document.getElementById("contact-content");
                    content.innerHTML = data.length === 0
                        ? "<i style='color:var(--text-muted)'>No contact details available</i>"
                        : `<table>${data.map(c => `
                            <tr><th>Email</th><td>${c.email || "-"}</td></tr>
                            <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
                            <tr><th>Address</th><td>${c.address || "-"}</td></tr>
                            <tr><th>EN Details</th><td><a href="/getnasdetails_india_map/${c.id}/">view EN Details</a></td></tr>
                        `).join("")}</table>`;

                    document.getElementById("contact-panel").style.display = "block";
                    document.getElementById("contact-content").style.display = "block";
                })
                .catch(() => {
                    showAlert("Failed to load contact info", "danger");
                    document.getElementById("contact-panel").style.display = "block";
                });
        }

        // ── Accordion (fixed version) ────────────────────────────────────────
        document.querySelectorAll('.panel-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const isCurrentlyOpen = content.classList.contains('open');

                // Close all other panels
                document.querySelectorAll('.panel-content').forEach(c => {
                    if (c !== content) c.classList.remove('open');
                });

                // Reset all arrows
                document.querySelectorAll('.panel-header span:last-child').forEach(s => {
                    s.textContent = '▼';
                });

                // Toggle clicked panel
                if (isCurrentlyOpen) {
                    content.classList.remove('open');
                    header.querySelector('span:last-child').textContent = '▼';
                } else {
                    content.classList.add('open');
                    header.querySelector('span:last-child').textContent = '▲';
                }
            });
        });

        // ── Current Active Issues ────────────────────────────────────────────
        let nameSortAsc = true;
        let colorSortDesc = true;
        let timeSortNewestFirst = true;

        function updateProblemsDisplay(sites) {
            const problematic = sites.filter(s => ["red", "yellow"].includes((s.color || "").toLowerCase().trim()));
            const list = document.getElementById("problems-list");
            const empty = document.getElementById("problems-empty");
            list.innerHTML = "";

            if (problematic.length === 0) {
                empty.style.display = "block";
                document.getElementById("issues-count").style.display = "none";
                return;
            }
            empty.style.display = "none";
            document.getElementById("issues-count").textContent = problematic.length;
            document.getElementById("issues-count").style.display = "inline";

            problematic.sort((a, b) => new Date(b.problem_since) - new Date(a.problem_since));

            renderProblemEntries(problematic);
        }

        function renderProblemEntries(items) {
            const list = document.getElementById("problems-list");
            list.innerHTML = "";

            items.forEach(site => {
                const color = (site.color || "").toLowerCase().trim();
                const div = document.createElement("div");
                div.className = `problem-entry ${color === "red" ? "red" : "yellow"}`;
                div.innerHTML = `
                    <div class="problem-site">${site.title}</div>
                    <div class="problem-status">${color === "red" ? "Unreachable" : "Satcom"}</div>
                    <div class="problem-since">since ${formatDateLocal(site.problem_since)}</div>
                `;
                list.appendChild(div);
            });

            attachProblemClickListeners();
        }

        document.querySelectorAll('#problems-content .sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const sortType = btn.dataset.sort;
                let items = [...allSitesData].filter(s => ["red", "yellow"].includes((s.color || "").toLowerCase().trim()));

                document.querySelectorAll('#problems-content .sort-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (sortType === "time") {
                    timeSortNewestFirst = !timeSortNewestFirst;
                    btn.textContent = timeSortNewestFirst ? "Newest" : "Oldest";

                    items.sort((a, b) => {
                        const ta = new Date(a.problem_since);
                        const tb = new Date(b.problem_since);
                        return timeSortNewestFirst ? tb - ta : ta - tb;
                    });
                } else if (sortType === "name") {
                    nameSortAsc = !nameSortAsc;
                    items.sort((a, b) => {
                        const cmp = a.title.localeCompare(b.title);
                        return nameSortAsc ? cmp : -cmp;
                    });
                } else if (sortType === "color") {
                    colorSortDesc = !colorSortDesc;
                    items.sort((a, b) => {
                        const ca = (a.color || "").toLowerCase().trim();
                        const cb = (b.color || "").toLowerCase().trim();
                        const cmp = ca.localeCompare(cb);
                        return colorSortDesc ? -cmp : cmp;
                    });
                }

                renderProblemEntries(items);
            });
        });

        // ── History ──────────────────────────────────────────────────────────
        let currentHistorySite = null;

        function renderHistoryEntries(entries) {
            const list = document.getElementById('history-list');
            list.innerHTML = "";

            if (!entries || entries.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:50px 0;">No history records found</div>';
                return;
            }

            entries.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'history-entry';
                div.innerHTML = `
                    <div class="history-time">${formatDateLocal(entry.status_changed_at)}</div>
                    <div style="font-weight:600; margin:4px 0;">
                        ${entry.site__name || entry.site_name || "—"}
                    </div>
                    <div>
                        <span style="color:var(--text-muted);">from</span> 
                        <span>${entry.past_status}</span> 
                        <span style="color:var(--text-muted);"> → </span> 
                        <span style="${/down|unreach/i.test(entry.current_status) ? 'color:var(--danger);font-weight:600;' : 'color:var(--success);font-weight:600;'}">
                            ${entry.current_status}
                        </span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function loadAllSitesHistory(order = "desc") {
            fetch("{% url 'status-history-all-sites' %}")
                .then(r => r.ok ? r.json() : [])
                .then(data => {
                    data.sort((a, b) => {
                        const ta = new Date(a.status_changed_at);
                        const tb = new Date(b.status_changed_at);
                        return order === "desc" ? tb - ta : ta - tb;
                    });
                    renderHistoryEntries(data);
                })
                .catch(() => {
                    showAlert("Failed to load history", "danger");
                    document.getElementById('history-list').innerHTML =
                        '<div style="text-align:center; color:var(--text-muted); padding:50px 0;">History unavailable</div>';
                });
        }

        function loadSiteHistory(siteName, order = "desc") {
            currentHistorySite = siteName;
            fetch(`/api/status-history/${encodeURIComponent(siteName)}/`)
                .then(r => r.ok ? r.json() : [])
                .then(data => {
                    data.sort((a, b) => {
                        const ta = new Date(a.status_changed_at);
                        const tb = new Date(b.status_changed_at);
                        return order === "desc" ? tb - ta : ta - tb;
                    });
                    renderHistoryEntries(data);
                })
                .catch(() => {
                    showAlert("Failed to load site history", "danger");
                    document.getElementById('history-list').innerHTML =
                        '<div style="color:var(--danger);padding:30px 0;text-align:center;">History unavailable</div>';
                });
        }

        document.getElementById('history-back-btn').addEventListener('click', () => {
            document.getElementById('history-back-btn').style.display = 'none';
            document.getElementById('history-panel-subtitle').textContent = 'Status History';
            currentHistorySite = null;
            loadAllSitesHistory("desc");
        });

        function attachProblemClickListeners() {
            document.querySelectorAll('.problem-entry').forEach(el => {
                el.addEventListener('click', () => {
                    const site = el.querySelector('.problem-site').textContent.trim();
                    loadSiteHistory(site, "desc");

                    document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('open'));
                    const historyContent = document.getElementById('history-content');
                    historyContent.classList.add('open');
                    document.getElementById('history-header').querySelector('span:last-child').textContent = '▲';

                    document.getElementById('history-panel-subtitle').textContent = `History: ${site}`;
                    document.getElementById('history-back-btn').style.display = 'inline-block';

                    if (sidebar.classList.contains('collapsed')) {
                        sidebar.classList.remove('collapsed');
                        toggleBtn.textContent = '→';
                        localStorage.setItem('sidebarCollapsed', 'false');
                    }
                });
            });
        }

        document.querySelectorAll('#history-content .history-sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const order = btn.dataset.order;
                document.querySelectorAll('#history-content .history-sort-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (currentHistorySite) {
                    loadSiteHistory(currentHistorySite, order);
                } else {
                    loadAllSitesHistory(order);
                }
            });
        });

        // ── Settings UI ──────────────────────────────────────────────────────
        function syncSettingsUI() {
            ["A", "B", "C", "D"].forEach(k => {
                document.getElementById(`show${k}`).checked = settings[`show${k}`];
                document.getElementById(`pulse${k}`).checked = settings[`pulse${k}`];
            });
            document.getElementById("markerSize").value = settings.markerSize;
            document.getElementById("pulseSize").value = settings.pulseSize;
            document.getElementById("markerValue").textContent = settings.markerSize + " px";
            document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
        }
        syncSettingsUI();

        ["A", "B", "C", "D"].forEach(k => {
            const showEl = document.getElementById(`show${k}`);
            const pulseEl = document.getElementById(`pulse${k}`);
            showEl.onchange = e => {
                settings[`show${k}`] = e.target.checked;
                if (!e.target.checked) {
                    settings[`pulse${k}`] = false;
                    pulseEl.checked = false;
                }
                refreshAll();
            };
            pulseEl.onchange = e => {
                settings[`pulse${k}`] = e.target.checked;
                if (e.target.checked) {
                    settings[`show${k}`] = true;
                    showEl.checked = true;
                }
                refreshAll();
            };
        });

        document.getElementById("markerSize").oninput = debounce(e => {
            let v = parseInt(e.target.value);
            if (v > settings.pulseSize) {
                settings.pulseSize = v + 2;
                document.getElementById("pulseSize").value = settings.pulseSize;
                document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
            }
            settings.markerSize = v;
            document.getElementById("markerValue").textContent = v + " px";
            refreshAll();
        });

        document.getElementById("pulseSize").oninput = debounce(e => {
            let v = Math.max(6, parseInt(e.target.value));
            e.target.value = v;
            if (v < settings.markerSize) {
                settings.markerSize = v;
                document.getElementById("markerSize").value = v;
                document.getElementById("markerValue").textContent = v + " px";
            }
            settings.pulseSize = v;
            document.getElementById("pulseValue").textContent = v + " px";
            refreshAll();
        });

        document.getElementById("saveSettings").onclick = () => {
            localStorage.setItem("mapSettings", JSON.stringify(settings));
            window.location.reload();
        };

        document.getElementById("settings-btn").onclick = () => {
            document.getElementById("settings-panel").classList.toggle("open");
        };

        document.getElementById("resetZoomBtn").onclick = () => chartInstance.goHome();

        const darkBtn = document.getElementById("dark-mode-btn");
        darkBtn.onclick = () => {
            const isDark = !document.body.classList.contains("dark-mode");
            localStorage.setItem("mapTheme", isDark ? "dark" : "light");
            window.location.reload();
        };

        // Initial load
        updateProblemsDisplay([]);
    });
</script>

{% endblock %}
