{% extends 'sites/base_global_dashboard.html' %}
{% block content %}
{% load static %}
<!-- Libraries -->
<link rel="stylesheet" href="{% static 'css/india_map_css.css' %}">
<script src="{% static 'amcharts/core.js' %}"></script>
<script src="{% static 'amcharts/maps.js' %}"></script>
<script src="{% static 'amcharts/india2020High.js' %}"></script>
<script src="{% static 'amcharts/animated.js' %}"></script>
<style>
    :root {
        --bg-dark: #0b1121;
        --bg-darker: #060617;
        --panel-glass: rgba(15, 23, 42, 0.88);
        --text: #e2e8f0;
        --text-muted: #94a3b8;
        --accent: #60a5fa;
        --accent-glow: rgba(96, 165, 250, 0.24);
        --danger: #f87171;
        --warning: #fbbf24;
        --success: #34d399;
        --border: rgba(96, 165, 250, 0.30);
        --shadow-sm: 0 6px 20px 6px rgba(0, 0, 0, 0.55);
        --shadow-md: 0 16px 40px 12px rgba(0, 0, 0, 0.65);
        --transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
        --status-green: #28a745;
        --status-red: #ef4444;
        --bg-color: #e8f0f2;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
    }

    body.dark-mode {
        background: var(--bg-darker);
        color: var(--text);
    }

    #main-content-wrapper {
        display: flex;
        height: calc(100vh - 60px);
        overflow: hidden;
    }

    #map-column {
        flex: 1;
        position: relative;
    }

    #chartdiv {
        width: 100%;
        height: 100%;
        background-color: var(--bg-color);
    }


    #last-updated {
        position: absolute;
        bottom: 16px;
        right: 32px;
        color: var(--text-muted);
        font-size: 13px;
        z-index: 1000;
        pointer-events: none;
    }

    .control-btn {
        position: absolute;
        left: 32px;
        background: rgba(2, 43, 92, 0.80);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        color: white;
        padding: 12px 18px;
        border: 1px solid var(--border);
        border-radius: 14px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0.3px;
        width: 190px;
        z-index: 1002;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
    }


    .control-btn:hover {
        transform: translateY(-4px) scale(1.03);
        box-shadow: 0 16px 40px 12px var(--accent-glow);
        border-color: var(--accent);
        background: rgba(2, 43, 92, 0.94);
    }

    #resetZoomBtn {
        top: 32px;
    }

    #settingsBtn {
        top: 92px;
    }

    #darkModeBtn {
        top: 157px;
    }

    #legend {
        position: absolute;
        bottom: 40px;
        left: 32px;
        backdrop-filter: blur(16px);
        background: var(--panel-glass);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px 24px;
        font-size: 14px;
        box-shadow: var(--shadow-md);
        z-index: 1001;
        transition: var(--transition);
        color: var(--text);
    }

    #legend:hover {
        transform: translateY(-6px);
        box-shadow: 0 20px 50px 12px var(--accent-glow);
    }

    #legend b {
        color: var(--accent);
        font-weight: 700;
    }


    /* BOX LIMITED TO CONTENT --- */

    .city-container {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: flex-start;
    }

    .city-name {
        font-size: 12px;
        font-weight: 700;
        color: var(--text-color);
        white-space: nowrap;
    }

    /* Status Dot Hover */

    .status-dots {
        display: flex;
        gap: 5px;
    }

    .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
        position: relative;
        transition: transform 0.25;
    }

    .dot:hover {
        transform: scale(1.4);
        z-index: 10;
    }

    .dot::after {
        content: attr(data-label);
        position: absolute;
        bottom: 18px;
        left: 50%;
        transform: translateX(-50%);
        background: #222;
        color: #fff;
        padding: 4px 8px;
        font-size: 10px;
        border-radius: 4px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: 0.2s;
    }

    .dot:hover::after {
        opacity: 1;
    }

    .bg-green {
        background-color: var(--status-green);
    }

    .bg-red {
        background-color: var(--status-red);
    }

    #sidebar-column {
        width: 420px;
        min-width: 420px;
        background: var(--panel-glass);
        backdrop-filter: blur(20px);
        border-left: 1px solid var(--border);
        box-shadow: -8px 0 32px rgba(0, 0, 0, 0.6);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: width 0.45s cubic-bezier (0.22, 1, 0.36, 1);
        position: relative;
        z-index: 1000;
    }

    #sidebar-column.collapsed {
        width: 64px;
        min-width: 64px;
    }

    #sidebar-column.collapsed .sidebar-content {
        opacity: 0;
        pointer-events: none;
    }

    #sidebar-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(2, 43, 92, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 22px;
        cursor: pointer;
        z-index: 1010;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
    }

    #sidebar-toggle:hover {
        transform: scale(1.14) rotate(180deg);
        background: var(--accent);
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px 20px;
        transition: opacity 0.45s ease;
    }

    .sidebar-content::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
        background: rgba(30, 41, 59, 0.4);
        border-radius: 10px;
    }


    .sidebar-content::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 10px;
    }

    .panel-header {
        background: linear-gradient(135deg, rgba(30, 58, 138, 0.88), rgba(59, 130, 246, 0.38));
        color: white;
        padding: 16px 20px;
        font-size: 15.5px;
        font-weight: 600;
        border-radius: 14px;
        margin-bottom: 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
    }


    .panel-header:hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 40px 12px var(--accent-glow);
    }

    .panel-content {
        background: rgba(15, 23, 42, 0.68);
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 20px;
        margin-bottom: 20px;
        display: none;
        animation: fadeInUp 0.45s ease-out;
    }

    .panel-content.open {
        display: block;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(16px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .problem-entry {
        border-radius: 12px;
        padding: 16px 18px;
        margin-bottom: 12px;
        background: rgba(30, 41, 59, 0.62);
        border-left: 5px solid var(--danger);
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        cursor: pointer;
    }

    .problem-entry.yellow {
        border-left-color: var(--warning);
    }

    .problem-entry:hover {
        transform: translateX(8px) scale(1.02);
        box-shadow: 0 12px 36px 8px rgba(239, 68, 68, 0.42);
    }

    .problem-site {
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 6px;
    }

    .problem-status {
        font-size: 13.5px;
        font-weight: 700;
        margin: 4px 0;
    }


    .problem-since {
        font-size: 12.5px;
        color: var(--text-muted);
    }


    .history-entry {
        padding: 14px 18px;
        margin-bottom: 12px;
        background: rgba(30, 41, 59, 0.62);
        border-radius: 12px;
        font-size: 13.8px;
        transition: var(--transition);
    }

    .history-entry:hover {
        background: rgba(96, 165, 250, 0.15);
        transform: translateX(4px);
    }

    .history-time {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 6px;
    }



    #alert-container {
        position: fixed;
        top: 24px;
        right: 460px;
        z-index: 2000;
        max-width: 420px;
    }


    .alert {
        padding: 16px 22px;
        margin-bottom: 14px;
        border-radius: 14px;
        color: white;
        font-size: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
        animation: slideInRight 0.45s ease-out;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(140%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }

    }

    .alert-danger {
        background: rgba(239, 68, 68, 0.92);
        border-color: #fca5a5;
    }

    .alert-success {
        border-color: #6ee7b7;
        background: rgba(16, 185, 129, 0.92);

    }

    .alert-warning {
        background: rgba(245, 158, 11, 0.92);
        border-color: #fcd34d;
    }

    .sort-btn.active,
    .history-sort-btn.active {
        background: var(--accent);
        color: white !important;
        border-color: var(--accent);
    }


    #site-search {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: rgba(30, 41, 59, 0.8);
        color: var(--text);
        font-size: 14px;
    }

    #site-search::placeholder {
        color: var(--text-muted);
    }

    #search-results {
        position: absolute;
        top: 100%;
        left: 0;
        max-height: 300px;
        right: 0;
        overflow-y: auto;
        background: var(--panel-glass);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-top: 6px;
        z-index: 1002;
        box-shadow: var(--shadow-md);
        display: none;
    }

    #search-results.search-item {
        padding: 10px 14px;
        cursor: pointer;
        color: var(--text);
    }

    #search-results .search-item:hover,
    .search-item.active {
        background: rgba(96, 165, 250, 0.3);
    }


    #contact-panel {
        background: var(--panel-glass);
        backdrop-filter: blur(16px);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow-md);
        color: var(--text);
        margin: 20px 0;
        width: 100%;
        max-width: 380px;
        position: relative;
        z-index: 1001;
    }

    #contact-panel {
        display: none;
    }

    #contact-panel.open {
        display: block;
    }

    #contact-header {
        background: linear-gradient(135deg, rgba(2, 43, 92, 0.9), rgba(30, 58, 138, 0.7));
        color: white;
        padding: 14px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border-radius: 14px 14px 0 0;
    }

    #contact-content {
        padding: 20px;
        font-size: 14px;
    }

    /* Floating contact panel when sidebar is collapsed */
    body.sidebar-collapsed #contact-panel.open {
        position: fixed;
        bottom: 100px;
        right: 40px;
        width: 400px;
        max-width: 400px;
        margin: 0;
        z-index: 9999;
    }


    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        text-align: left;
        padding: 10px 0;
        color: var(--text-muted);
        width: 35%;
    }

    td {
        padding: 10px 0;
    }

    #settings-panel,
    #history-panel {
        position: fixed;
        top: 100px;
        right: -340px;
        max-height: 80vh;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        padding: 16px;
        transition: right 0.3s ease;
        z-index: 1002;
    }

    body.dark-mode #settings-panel,
    body.dark-mode #history-panel {
        background: #1e293b;
        color: #e2e8f0;
    }

    #settings-panel {
        width: 300px;
        z-index: 1002;
    }


    #history-panel {
        width: 340px;
        z-index: 1003;
        font-size: 13px;
    }

    #settings-panel.open,
    #history-panel.open {
        right: 24px;
    }

    .settings-title {
        font-weight: 600;
        margin: 16px 0 10px;
        color: #cbd5e1;
    }

    body.dark-mode.settings-title {
        color: #cbd5e1;
    }

    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
    }

    .switch {
        position: relative;
        width: 38px;
        height: 20px;
    }

    .switch input {
        display: none;
    }

    .slider {
        position: absolute;
        inset: 0;
        background: #ccc;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.35;
    }

    .slider:before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        left: 2px;
        bottom: 2px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    input:checked+.slider {
        background: #4caf50;
    }

    input:checked+.slider:before {
        transform: translateX(18px);
    }

    input[type=range] {
        width: 130px;
        accent-color: #002b5c;
    }

    .size-label {
        min-width: 70px;
        text-align: right;
        color: #555;
        font-size: 13px;
    }

    #saveSettings {
        margin-top: 20px;
        width: 100%;
        padding: 10px;
        background: #002b5c;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .group-site {
        background: rgba(30, 41, 59, 0.62);
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        width: 100px;
    }

    .group-site:hover {
        transform: translateX(6px);
        box-shadow: 0 12px 36px 8px var(--accent-glow);
    }

    .group-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14.5px;
    }

    .status-dots {
        display: flex;
        gap: 6px;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .status-dot.green {
        background: #22c55e;
    }

    .status-dot.yellow {
        background: #fbbf24;
    }

    .status-dot.red {
        background: #ef4444;
    }

    .status-dot.blue {
        background: #3b82f6;
    }

    .status-dot.orange {
        background: #a855f7;
    }

    .location-name {
        font-weight: 700;
        font-size: 14px;
        margin: 12px 0 6px 0;
        color: var(--text-primary);
    }

    .location-dots-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 14px;
        margin-bottom: 8px;
    }

    .location-dots-container .dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        transition: transform 0.15s ease;
    }

    .location-dots-container .dot:hover {
        transform: scale(1.4);
    }
</style>

<div id="main-content-wrapper">
    <div id="map-column">
        <div id="chartdiv"></div>
        <button id="resetZoomBtn" class="control-btn"><i class="bi bi-arrow-counterclockwise me-2"></i> Reset
            View</button>
        <button id="settingsBtn" class="control-btn"><i class="bi bi-gear me-2"></i> Settings</button>
        <button id="darkModeBtn" class="control-btn">
            <i class="bi bi-brightness-high me-2"></i><span>Dark Mode</span>
        </button>
        <div id="legend">
            <b>Legend</b><br>
            <div><span style="color:green; font-size:22px">●</span> AFNET Site</div>
            <div><span style="color: yellow; font-size:22px">●</span> Site on Satcom</div>
            <div><span style="color:red; font-size:22px">●</span>Unreachable</div>
            <div><span style="color:orange; font-size:22px">●</span> IACCS Nodes</div>
        </div>
        <div id="last-updated">
            Last updated: <span id="last-update-time">-</span>
        </div>
    </div>
    <div id="sidebar-column">
        <button id="sidebar-toggle" title="Collapse sidebar">→</button>
        <div class="sidebar-content">
            <!-- Site Search -->
            <div class="mb-4 position-relative">
                <input type="text" id="site-search" placeholder="Search sites (e.g. MCC)" autocomplete="off">
                <div id="search-results"></div>
            </div>
            <!-- Site Groups -->
            <div class="panel-header" id="group-header">
                <span>Site Groups</span><span>▼</span>
            </div>
            <div class="panel-content" id="group-content">
                <div class="btn-group btn-group-sm w-100 mb-3">
                    <button class="btn btn-outline-light group-btn active" data-group="iaccs">IACCS</button>
                    <button class="btn btn-outline-light group-btn" data-group="dc">DC</button>
                </div>
                <div id="group-sites-list" class="city-container"></div>
                <div id="group-empty" style="text-align:center; color:var(--text-muted); padding:30px 0; display:none;">
                    No sites in this group
                </div>
            </div>
            <!-- MCT and Satcom -->
            <div class="panel-header" id="subtype-header">
                <span>MCT & Satcom</span>
                <span id="subtype-arrow">▼</span>
            </div>
            <div class="panel-content" id="subtype-content">
                <div class="btn-group btn-group-sm w-100 mb-3">
                    <button class="btn btn-outline-light type-btn active" data-type="MCT_Vehicle">MCT</button>
                    <button class="btn btn-outline-light type-btn" data-type="SATCOM">SATCOM</button>
                </div>
                <div id="subtype-list"></div>
                <div id="subtype-empty"
                    style="text-align:center; color:var(--text-muted); padding:30px 0; display:none;">
                    No Data in this group
                </div>
            </div>
            <!-- Current Active Issues -->
            <div class="panel-header" id="problems-header">
                <span>Current Active Issues</span><span>▼</span>
            </div>
            <div class="panel-content" id="problems-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        Current Active Issues
                        <span id="issues-count" class="badge bg-danger ms-2"
                            style="font-size:0.8rem; display:none;">0</span>
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light sort-btn active" data-sort="time">Newest</button>
                        <button class="btn btn-outline-light sort-btn" data-sort="name">Name</button>
                        <button class="btn btn-outline-light sort-btn" data-sort="color">Color</button>
                    </div>
                </div>
                <div id="problems-list"></div>
                <div id="problems-empty"
                    style="text-align:center; color:var(--text-muted); padding:50px 0; display:none;">
                    No active issues detected
                </div>
            </div>
            <!-- Status History -->
            <div class="panel-header" id="history-header">
                <span id="history-panel-title">Status History</span><span>▼</span>
            </div>
            <div class="panel-content" id="history-content">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h6 class="mb-0" id="history-panel-subtitle">Status History</h6>
                    <div class="d-flex align-items-center gap-2">
                        <button id="history-back-btn" style="display:none;"
                            class="btn btn-outline-light btn-sm">Back</button>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-light history-sort-btn active" data-order="desc">Newest
                                first</button>
                            <button class="btn btn-outline-light history-sort-btn" data-order="asc">Oldest
                                first</button>
                        </div>
                    </div>
                </div>
                <div id="history-list" style="height: 300px; overflow-y:auto;"></div>
            </div>
            <!-- Contact Panel -->
            <div id="contact-panel" style="display:none;">
                <div id="contact-header">
                    <span id="contact-title">Site Details</span>
                    <span id="contact-arrow">▼</span>
                </div>
                <div id="contact-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Panel -->
<div id="settings-panel">
    <div class="settings-title">Visibility</div>
    <div class="settings-row">AFNET Sites <label class="switch"><input type="checkbox" id="showA" checked><span
                class="slider"></span></label></div>
    <div class="settings-row">Satcom Sites <label class="switch"><input type="checkbox" id="showB" checked><span
                class="slider"></span></label></div>
    <div class="settings-row">Unreachable <label class="switch"><input type="checkbox" id="showC" checked><span
                class="slider"></span></label></div>
    <div class="settings-row">IACCS Sites <label class="switch"><input type="checkbox" id="showD" checked><span
                class="slider"></span></label></div>

    <div class="settings-title">Pulse Animation</div>
    <div class="settings-row">AFNET Sites <label class="switch"><input type="checkbox" id="pulseA"></label></div>
    <div class="settings-row">Satcom Sites <label class="switch"><input type="checkbox" id="pulseB"></label></div>
    <div class="settings-row">Unreachable <label class="switch"><input type="checkbox" id="pulseC" checked><span
                class="slider"></span></label></div>
    <div class="settings-row">IACCS Sites <label class="switch"><input type="checkbox" id="pulseD"></label></div>

    <div class="settings-title">Marker Sizes</div>
    <div class="settings-row">
        Marker <span id="markerValue" class="size-label">6 px</span>
        <input type="range" id="markerSize" min="3" max="16" value="6">
    </div>
    <div class="settings-row">
        Pulse ring <span id="pulseValue" class="size-label">10 px</span>
        <input type="range" id="pulseSize" min="6" max="19" value="10">
    </div>
    <button id="saveSettings">Save Settings</button>
</div>

<div id="alert-container"></div>

<script>
    // ──────────────────────────────────────────────────────────────
    // Shared Utilities
    // ──────────────────────────────────────────────────────────────
    const Utils = {
        formatDateLocal(dt) {
            return new Date(dt).toLocaleString('en-IN', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            }).replace(/,/g, '');
        },
        showAlert(message, type = "danger") {
            const container = document.getElementById("alert-container");
            const alert = document.createElement("div");
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        },
        debounce(fn, delay = 200) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }
    };

    // ──────────────────────────────────────────────────────────────
    // Settings Module
    // ──────────────────────────────────────────────────────────────
    const SettingsModule = (function () {
        const MAP_THEME = {
            light: { background: "#f1f5f9", polygonFill: "#60a5fa", polygonHover: "#93c5fd", polygonStroke: "#e2e8f0", tooltipBg: "#ffffff", tooltipText: "#0f172a" },
            dark: { background: "#0b1121", polygonFill: "#60a5fa", polygonHover: "#93c5fd", polygonStroke: "#e2e8f0", tooltipBg: "#ffffff", tooltipText: "#0f172a" }
        };
        let settings = JSON.parse(localStorage.getItem("mapSettings")) || {
            showA: true, showB: true, showC: true, showD: true,
            pulseA: false, pulseB: false, pulseC: true, pulseD: false,
            markerSize: 6, pulseSize: 10
        };
        let currentTheme = localStorage.getItem("mapTheme") || "dark";
        let theme = MAP_THEME[currentTheme];

        function applyTheme() {
            const root = document.documentElement;
            document.body.classList.toggle("dark-mode", currentTheme === "dark");
            root.style.setProperty("--bg-color", currentTheme === "dark" ? "#0f172a" : "#e8f0f2");
        }

        function syncUI() {
            ["A", "B", "C", "D"].forEach(k => {
                document.getElementById(`show${k}`).checked = settings[`show${k}`];
                document.getElementById(`pulse${k}`).checked = settings[`pulse${k}`];
            });
            document.getElementById("markerSize").value = settings.markerSize;
            document.getElementById("pulseSize").value = settings.pulseSize;
            document.getElementById("markerValue").textContent = settings.markerSize + " px";
            document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
        }

        function init() {
            applyTheme();
            syncUI();

            ["A", "B", "C", "D"].forEach(k => {
                document.getElementById(`show${k}`).onchange = e => {
                    settings[`show${k}`] = e.target.checked;
                    if (!e.target.checked) {
                        settings[`pulse${k}`] = false;
                        document.getElementById(`pulse${k}`).checked = false;
                    }
                    MapModule.refreshMarkersVisibilityAndPulse();
                };
                document.getElementById(`pulse${k}`).onchange = e => {
                    settings[`pulse${k}`] = e.target.checked;
                    if (e.target.checked) {
                        settings[`show${k}`] = true;
                        document.getElementById(`show${k}`).checked = true;
                    }
                    MapModule.refreshMarkersVisibilityAndPulse();
                };
            });

            document.getElementById("markerSize").oninput = Utils.debounce(e => {
                let v = parseInt(e.target.value);
                if (v > settings.pulseSize) {
                    settings.pulseSize = v + 2;
                    document.getElementById("pulseSize").value = settings.pulseSize;
                    document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
                }
                settings.markerSize = v;
                document.getElementById("markerValue").textContent = v + " px";
                MapModule.updateMarkerAndPulseSizes();
            }, 150);

            document.getElementById("pulseSize").oninput = Utils.debounce(e => {
                let v = Math.max(6, parseInt(e.target.value));
                e.target.value = v;
                if (v < settings.markerSize) {
                    settings.markerSize = v;
                    document.getElementById("markerSize").value = v;
                    document.getElementById("markerValue").textContent = v + " px";
                }
                settings.pulseSize = v;
                document.getElementById("pulseValue").textContent = v + " px";
                MapModule.updateMarkerAndPulseSizes();
            }, 150);

            document.getElementById("saveSettings").onclick = () => {
                localStorage.setItem("mapSettings", JSON.stringify(settings));
                window.location.reload();
            };

            document.getElementById("settingsBtn").onclick = () => {
                document.getElementById("settings-panel").classList.toggle("open");
                UIController.closeAllPanels();
            };

            document.getElementById("darkModeBtn").onclick = () => {
                currentTheme = currentTheme === "light" ? "dark" : "light";
                localStorage.setItem("mapTheme", currentTheme);
                theme = MAP_THEME[currentTheme];
                applyTheme();
                MapModule.applyThemeToChart();
            };
        }

        return {
            init,
            getSettings: () => settings,
            getTheme: () => theme,
            getCurrentThemeName: () => currentTheme
        };
    })();

    // ──────────────────────────────────────────────────────────────
    // Contacts Module
    // ──────────────────────────────────────────────────────────────
    // const ContactsModule = (function() {
    //     const panel = document.getElementById("contact-panel");
    //     const titleEl = document.getElementById("contact-title");
    //     const contentEl = document.getElementById("contact-content");
    //     const arrowEl = document.getElementById("contact-arrow");
    //     const sidebarContent = document.querySelector('#sidebar-column .sidebar-content');

    //     async function loadContactInfo(siteName) {
    //         console.log("Loading contact info for:", siteName);
    //         try {
    //             const resp = await fetch(`/api/site-contact-info/${encodeURIComponent(siteName)}/`);
    //             if (!resp.ok) {
    //                 throw new Error(`HTTP ${resp.status}`);
    //             }
    //             const data = await resp.json();
    //             console.log("Contact data received:", data);
    //             titleEl.textContent = siteName;
    //             contentEl.innerHTML = data.length === 0
    //                 ? "<i style='color:var(--text-muted)'>No contact details available</i>"
    //                 : `<table>${data.map(c => `
    //                     <tr><th>Email</th><td>${c.email || "-"}</td></tr>
    //                     <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
    //                     <tr><th>Address</th><td>${c.address || "-"}</td></tr>
    //                     <tr><th>EN Details</th><td><a href="/getnasdetails_india_map/${c.id}/">view EN Details</a></td></tr>
    //                 `).join("")}</table>`;
    //         } catch (err) {
    //             console.error("Contact fetch error:", err);
    //             Utils.showAlert("Failed to load contact info", "danger");
    //             contentEl.innerHTML = "<i style='color:var(--danger)'>Error loading contact information</i>";
    //         }
    //     }

    //     function showContactPanel(siteName) {
    //         console.log("showContactPanel called for:", siteName);
    //         loadContactInfo(siteName);

    //         // Force visibility and positioning
    //         panel.style.display = "block !important";
    //         panel.style.visibility = "visible !important";
    //         panel.style.opacity = "1 !important";
    //         panel.style.zIndex = "9999 !important";

    //         contentEl.style.display = "block !important";
    //         arrowEl.textContent = "▲";

    //         if (document.getElementById('sidebar-column').classList.contains('collapsed')) {
    //             document.body.appendChild(panel);
    //             panel.style.position = "fixed";
    //             panel.style.bottom = "100px";
    //             panel.style.right = "40px";
    //             panel.style.width = "400px";
    //             panel.style.zIndex = "9999";
    //         } else {
    //             if (panel.parentElement !== sidebarContent) {
    //                 sidebarContent.appendChild(panel);
    //             }
    //             panel.style.position = "relative";
    //             panel.style.width = "100%";
    //             panel.style.maxWidth = "380px";
    //             panel.style.margin = "20px 0";
    //             panel.style.zIndex = "auto";
    //         }

    //         // Scroll to panel if in sidebar
    //         if (!sidebar.classList.contains('collapsed')) {
    //             panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    //         }
    //     }

    //     function hideContactPanel() {
    //         panel.style.display = "none";
    //     }

    //     function init() {
    //         // No additional init needed
    //     }

    //     return { init, showContactPanel, hideContactPanel };
    // })();

    const ContactsModule = (function () {
        const panel = document.getElementById("contact-panel");
        const titleEl = document.getElementById("contact-title");
        const contentEl = document.getElementById("contact-content");
        const arrowEl = document.getElementById("contact-arrow");
        const sidebar = document.getElementById("sidebar-column");
        const sidebarContent = document.querySelector('#sidebar-column .sidebar-content');

        async function loadContactInfo(siteName) {
            try {
                const resp = await fetch(`/api/site-contact-info/${encodeURIComponent(siteName)}/`);
                if (!resp.ok) throw new Error();
                const data = await resp.json();
                titleEl.textContent = siteName;
                contentEl.innerHTML = data.length === 0
                    ? "<i style='color:var(--text-muted)'>No contact details available</i>"
                    : `<table>${data.map(c => `
                    <tr><th>Email</th><td>${c.email || "-"}</td></tr>
                    <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
                    <tr><th>Address</th><td>${c.address || "-"}</td></tr>
                    <tr><th>EN Details</th><td><a href="/getnasdetails_india_map/${c.id}/">view EN Details</a></td></tr>
                `).join("")}</table>`;
            } catch {
                contentEl.innerHTML = "<i style='color:var(--danger)'>Error loading contact information</i>";
            }
        }
function showContactPanel(siteName) {
    console.log("showContactPanel called for:", siteName);
    loadContactInfo(siteName);

    panel.classList.add("open");
    panel.style.display = "block";
    
    arrowEl.textContent = "▲";

    if (sidebar.classList.contains("collapsed")) {
        document.body.appendChild(panel);
    } else {
        if (panel.parentElement !== sidebarContent) {
            sidebarContent.appendChild(panel);
        }
        panel.scrollIntoView({ behavior: "smooth", block: "center" });
    }
}

function hideContactPanel() {
    panel.style.display = "none";
    // panel.classList.remove("open");
}




        function init() {
            // No additional init needed
        }

        return { showContactPanel, hideContactPanel, showContactPanel };
    })();


    // ──────────────────────────────────────────────────────────────
    // Map Module
    // ──────────────────────────────────────────────────────────────
    const MapModule = (function () {
        const SITE_COLORS = { A: "green", B: "yellow", C: "red", D: "orange" };
        const PULSE_CONFIG = { opacity: 0.45, maxScale: 5.5, duration: 1800 };

        let chart, imageSeries, polygonSeries;

        function createChart() {
            am4core.useTheme(am4themes_animated);
            chart = am4core.create("chartdiv", am4maps.MapChart);
            chart.geodata = am4geodata_india2020High;
            chart.projection = new am4maps.projections.Miller();
            chart.zoomControl = new am4maps.ZoomControl();

            polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
            polygonSeries.useGeodata = true;
            const poly = polygonSeries.mapPolygons.template;
            poly.fill = am4core.color(SettingsModule.getTheme().polygonFill);
            poly.stroke = am4core.color(SettingsModule.getTheme().polygonStroke);
            poly.strokeOpacity = 0.35;
            poly.tooltipText = "{name}";
            poly.states.create("hover").properties.fill = am4core.color(SettingsModule.getTheme().polygonHover);

            imageSeries = chart.series.push(new am4maps.MapImageSeries());
            const template = imageSeries.mapImages.template;
            template.propertyFields.latitude = "latitude";
            template.propertyFields.longitude = "longitude";
            template.tooltipText = "{title} - {address}";

            const pulse = template.createChild(am4core.Circle);
            pulse.adapter.add("radius", () => SettingsModule.getSettings().pulseSize);
            pulse.nonScaling = true;
            pulse.propertyFields.fill = "color";
            pulse.opacity = PULSE_CONFIG.opacity;
            pulse.zIndex = 0;

            const marker = template.createChild(am4core.Circle);
            marker.adapter.add("radius", () => SettingsModule.getSettings().markerSize);
            marker.nonScaling = true;
            marker.propertyFields.fill = "color";
            marker.zIndex = 1;

            marker.adapter.add("opacity", (_, target) => {
                const c = (target.dataItem?.dataContext?.color || "").toLowerCase().trim();
                if (!Object.values(SITE_COLORS).includes(c)) return 0;
                const key = Object.keys(SITE_COLORS).find(k => SITE_COLORS[k] === c);
                return SettingsModule.getSettings()[`show${key}`] ? 1 : 0;
            });

            template.events.on("inited", e => updatePulse(e.target));
            template.events.on("dataitemchanged", e => updatePulse(e.target));

            chart.background.fill = am4core.color(SettingsModule.getTheme().background);
            chart.tooltip.background.fill = am4core.color(SettingsModule.getTheme().tooltipBg);
            chart.tooltip.label.fill = am4core.color(SettingsModule.getTheme().tooltipText);
        }

        function updatePulse(image) {
            const data = image.dataItem?.dataContext;
            if (!data) return;
            const c = (data.color || "").toLowerCase().trim();
            if (!Object.values(SITE_COLORS).includes(c)) return;

            const pulse = image.children.getIndex(0);
            const key = Object.keys(SITE_COLORS).find(k => SITE_COLORS[k] === c);
            const shouldPulse = SettingsModule.getSettings()[`pulse${key}`];

            if (shouldPulse) {
                startPulse(pulse);
            } else {
                stopPulse(pulse);
            }
        }

        function startPulse(circle) {
            if (circle._pulseAnim) circle._pulseAnim.stop();
            circle.scale = 1;
            circle.opacity = PULSE_CONFIG.opacity;
            circle._pulseAnim = circle.animate([
                { property: "scale", from: 1, to: PULSE_CONFIG.maxScale },
                { property: "opacity", from: PULSE_CONFIG.opacity, to: 0 }
            ], PULSE_CONFIG.duration);
            circle._pulseAnim.events.on("animationended", () => startPulse(circle));
        }

        function stopPulse(circle) {
            if (circle._pulseAnim) circle._pulseAnim.stop();
            circle.opacity = 0;
            circle.scale = 1;
        }

        function zoomToLatLon(lat, lon, zoomLevel = 8, animate = true) {
            if (!chart) return;
            chart.zoomToGeoPoint({ latitude: lat, longitude: lon }, zoomLevel, animate);
        }

        function focusSiteTemporarily(siteTitle, duration = 5000) {
            let found = false;
            imageSeries.mapImages.each(img => {
                if (found) return;
                const ctx = img.dataItem?.dataContext;
                if (!ctx || ctx.title !== siteTitle) return;
                found = true;
                img.isHover = true;
                if (img.tooltip) img.showTooltip();
            });
        }

        function applyThemeToChart() {
            if (!chart) return;
            chart.background.fill = am4core.color(SettingsModule.getTheme().background);
            polygonSeries.mapPolygons.template.fill = am4core.color(SettingsModule.getTheme().polygonFill);
            polygonSeries.mapPolygons.template.stroke = am4core.color(SettingsModule.getTheme().polygonStroke);
            polygonSeries.mapPolygons.template.states.getKey("hover").properties.fill = am4core.color(SettingsModule.getTheme().polygonHover);
            chart.tooltip.background.fill = am4core.color(SettingsModule.getTheme().tooltipBg);
            chart.tooltip.label.fill = am4core.color(SettingsModule.getTheme().tooltipText);
            chart.invalidateRawData();
        }

        function updateMarkerAndPulseSizes() {
            imageSeries.mapImages.each(img => {
                if (img.children.length >= 2) {
                    img.children.getIndex(0).invalidate();
                    img.children.getIndex(1).invalidate();
                }
            });
        }

        function refreshMarkersVisibilityAndPulse() {
            imageSeries.mapImages.each(img => {
                const marker = img.children.getIndex(1);
                if (marker) marker.invalidateProperty("opacity");
                updatePulse(img);
            });
        }

        function setData(data) {
            imageSeries.data = data;
        }

        function init() {
            createChart();
            document.getElementById("resetZoomBtn").onclick = () => chart?.goHome();


            polygonSeries.mapPolygons.template.events.on("hit", ev => {
                console.log("Map background clicked, checking to hide contact panel");
                const contactPanel = document.getElementById("contact-panel");
                if (contactPanel && contactPanel.style.display === "block") {
                    console.log("Hiding contact panel due to map background click");
                    ContactsModule.hideContactPanel();
                }
            });

            imageSeries.mapImages.template.events.on("hit", ev => {
                ev.event.stopPropagation();
                const ctx = ev.target.dataItem?.dataContext;
                if (ctx && ctx.title) {
                    ContactsModule.showContactPanel(ctx.title);
                    const contactpanel = document.getElementById("contact-panel");
                    if (contactpanel) {
                        contactpanel.style.display = "block";
                        contactpanel.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }
            });
        }

        return {
            init,
            setData,
            zoomToLatLon,
            focusSiteTemporarily,
            applyThemeToChart,
            updateMarkerAndPulseSizes,
            refreshMarkersVisibilityAndPulse,
            getChart: () => chart
        };
    })();

    // ──────────────────────────────────────────────────────────────
    // MCT / SATCOM Module
    // ──────────────────────────────────────────────────────────────
    const MCTModule = (function () {
        let subtypeData = [];
        let currentSubtype = "MCT_Vehicle";

        async function loadData() {
            try {
                const resp = await fetch("{% url 'mct_satcom_india_map' %}");
                if (!resp.ok) throw new Error("HTTP " + resp.status);
                const data = await resp.json();
                if (!Array.isArray(data)) return [];
                return data.filter(item => item.name && item.data_type && item.status);
            } catch (err) {
                console.error(err);
                Utils.showAlert("Failed to load MCT/Satcom data", "danger");
                return [];
            }
        }

        function render(selectedType) {
            const container = document.getElementById('subtype-list');
            const emptyDiv = document.getElementById('subtype-empty');
            container.innerHTML = '';

            const filtered = subtypeData.filter(d => d.data_type === selectedType);
            if (filtered.length === 0) {
                emptyDiv.style.display = 'block';
                return;
            }
            emptyDiv.style.display = 'none';

            const statuses = ['FULLY_OPS', 'RESTRICTED_OPS', 'NON_OPS'];
            statuses.forEach(status => {
                const items = filtered.filter(d => d.status === status);
                if (items.length === 0) return;

                const header = document.createElement('div');
                header.textContent = `${status} (Total: ${items.length})`;
                header.style.fontWeight = '700';
                header.style.margin = "10px 0 6px";
                header.style.fontSize = "14px";
                container.appendChild(header);

                const row = document.createElement('div');
                row.className = 'city-container';
                items.forEach(item => {
                    const tag = document.createElement('div');
                    tag.classList.add("group-site");
                    const span = document.createElement('span');
                    span.classList.add("city-name");
                    span.textContent = item.name;
                    tag.appendChild(span);
                    row.appendChild(tag);
                });
                container.appendChild(row);
            });
        }

        async function refresh() {
            subtypeData = await loadData();
            render(currentSubtype);
        }

        function init() {
            document.querySelectorAll(".type-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".type-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    currentSubtype = btn.dataset.type;
                    render(currentSubtype);
                });
            });

            // document.getElementById('subtype-header').addEventListener('click', () => {
            //     const content = document.getElementById('subtype-content');
            //     const visible = content.style.display !== "none";
            //     content.style.display = visible ? "none" : "block";
            //     document.getElementById("subtype-arrow").textContent = visible ? "▼" : "▲";
            //     if (!visible) refresh();
            // });

            refresh();
            setInterval(refresh, 120000);
        }

        return { init };
    })();

    // ──────────────────────────────────────────────────────────────
    // IACCS & DC Groups Module
    // ──────────────────────────────────────────────────────────────
    const GroupsModule = (function () {
        let groupNodes = [
            { title: "IACCS_Node_1", type: "IACCS", sub_type: "OG", node_location: "DELHI", latitude: 28.6139, longitude: 77.2090, color: "orange", status: ["green"] },
            { title: "IACCS_Node_2", type: "IACCS", sub_type: "OG", node_location: "DELHI", latitude: 28.6139, longitude: 77.2090, color: "orange", status: ["green"] },
            { title: "IACCS_Node_3", type: "IACCS", sub_type: "OG", node_location: "CHENNAI", latitude: 13.0827, longitude: 80.2707, color: "orange", status: ["green"] },
            { title: "IACCS_Node_4", type: "IACCS", sub_type: "OG", node_location: "KOLKATA", latitude: 22.5726, longitude: 88.3639, color: "orange", status: ["green"] },
            { title: "IACCS_Node_5", type: "IACCS", sub_type: "OG", node_location: "BANGALORE", latitude: 12.9716, longitude: 77.5946, color: "orange", status: ["green"] },
            { title: "IACCS_Node_6", type: "IACCS", sub_type: "OG", node_location: "BANGALORE", latitude: 12.9716, longitude: 77.5946, color: "orange", status: ["green"] },
            { title: "IACCS_Node_7", type: "IACCS", sub_type: "UG", node_location: "BANGALORE", latitude: 12.9716, longitude: 77.5946, color: "orange", status: ["green"] },
            { title: "IACCS_Node_8", type: "IACCS", sub_type: "UG", node_location: "BANGALORE", latitude: 12.9716, longitude: 77.5946, color: "orange", status: ["green"] },
            { title: "DELHI", type: "DC", node_location: "DELHI", latitude: 28.6139, longitude: 77.2090, color: "orange", status: ["green"] },
            { title: "MUMBAI", type: "DC", node_location: "MUMBAI", latitude: 19.0760, longitude: 72.8777, color: "orange", status: ["green"] },
            { title: "CHENNAI", type: "DC", node_location: "CHENNAI", latitude: 13.0827, longitude: 80.2707, color: "orange", status: ["green"] },
            { title: "KOLKATA", type: "DC", node_location: "KOLKATA", latitude: 22.5726, longitude: 88.3639, color: "orange", status: ["green"] },
            { title: "BANGALORE", type: "DC", node_location: "BANGALORE", latitude: 12.9716, longitude: 77.5946, color: "orange", status: ["green"] },
        ];

        let currentGroup = "iaccs";

        function normalizeTitle(title) {
            return (title || "").trim().toUpperCase();
        }

        function renderGroupSites() {
            const list = document.getElementById("group-sites-list");
            const empty = document.getElementById("group-empty");
            list.innerHTML = "";

            const nodes = currentGroup === "iaccs"
                ? groupNodes.filter(n => n.type === "IACCS")
                : groupNodes.filter(n => n.type === "DC");

            if (nodes.length === 0) {
                empty.style.display = "block";
                return;
            }
            empty.style.display = "none";

            if (currentGroup === "dc") {
                nodes.forEach(node => {
                    const div = document.createElement("div");
                    div.className = "group-site";
                    div.onclick = () => {
                        MapModule.zoomToLatLon(node.latitude, node.longitude, 10);
                        setTimeout(() => MapModule.focusSiteTemporarily(node.title, 5000), 600);
                    };
                    const dotsHtml = node.status.map(s => `<div class="dot bg-${s}"></div>`).join('');
                    div.innerHTML = `
                    <span class="city-name">${node.title}</span>
                    <div class="status-dots">${dotsHtml}</div>
                `;
                    list.appendChild(div);
                });
                return;
            }

            const grouped = {};
            nodes.forEach(node => {
                const loc = (node.node_location || "Unknown").toUpperCase();
                if (!grouped[loc]) grouped[loc] = [];
                grouped[loc].push(node);
            });

            Object.keys(grouped).sort().forEach(location => {
                const locationNodes = grouped[location];

                const groupSite = document.createElement("div");
                groupSite.className = "group-site";

                const cityName = document.createElement("span");
                cityName.className = "city-name";
                cityName.textContent = location;
                groupSite.appendChild(cityName);

                const statusDots = document.createElement("div");
                statusDots.className = "status-dots";

                locationNodes.forEach(node => {
                    const dot = document.createElement("div");
                    dot.className = `dot bg-${node.status[0] || "gray"}`;
                    dot.title = `${node.title} (${node.sub_type || "?"})`;
                    dot.style.cursor = "pointer";

                    dot.onclick = (e) => {
                        e.stopPropagation();
                        MapModule.zoomToLatLon(node.latitude, node.longitude, 10);
                        setTimeout(() => {
                            MapModule.focusSiteTemporarily(node.title, 5000);
                            ContactsModule.showContactPanel(node.title);
                        }, 600);
                    };

                    statusDots.appendChild(dot);
                });

                groupSite.appendChild(statusDots);
                list.appendChild(groupSite);
            });
        }

        async function updateNodeStatuses() {
            try {
                const resp = await fetch("{% url 'india_map_iaccs_status' %}");
                if (!resp.ok) throw new Error("Status fetch failed");
                const downItems = await resp.json();

                const downIaccs = new Set(
                    downItems.filter(item => item.type === "IACCS")
                        .map(item => normalizeTitle(item.node_name))
                );
                const downDc = new Set(
                    downItems.filter(item => item.type === "DC")
                        .map(item => normalizeTitle(item.node_name))
                );

                groupNodes.forEach(node => {
                    const normTitle = normalizeTitle(node.title);
                    if (node.type === "IACCS") {
                        node.status = downIaccs.has(normTitle) ? ["red"] : ["green"];
                    } else if (node.type === "DC") {
                        node.status = downDc.has(normTitle) ? ["red"] : ["green"];
                    }
                });

                renderGroupSites();
            } catch (err) {
                console.error("Failed to update IACCS/DC status", err);
            }
        }

        function init() {
            document.querySelectorAll(".group-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".group-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    currentGroup = btn.dataset.group;
                    renderGroupSites();
                });
            });

            document.getElementById("group-header").addEventListener("click", () => {
                setTimeout(renderGroupSites, 10);
            });

            updateNodeStatuses();
            setInterval(updateNodeStatuses, 60000);
        }

        return {
            init,
            renderGroupSites
        };
    })();

    // ──────────────────────────────────────────────────────────────
    // Main Map Data Module
    // ──────────────────────────────────────────────────────────────
    const MainMapDataModule = (function () {
        let mapSitesData = [];

        async function loadAndUpdate() {
            try {
                const resp = await fetch("{% url 'site-map-api' %}");
                if (!resp.ok) throw new Error();
                const raw = await resp.json();
                mapSitesData = raw.filter(s =>
                    ["green", "yellow", "red", "orange"].includes((s.color || "").toLowerCase().trim())
                );
                MapModule.setData(mapSitesData);
                ProblemsModule.updateProblemsDisplay(mapSitesData);
                document.getElementById("last-update-time").textContent = Utils.formatDateLocal(new Date());
            } catch (err) {
                console.error(err);
                Utils.showAlert("Failed to load main map data", "danger");
            }
        }

        function init() {
            loadAndUpdate();
            setInterval(loadAndUpdate, 120000);
        }

        return {
            init,
            getMapSitesData: () => mapSitesData
        };
    })();


    // ──────────────────────────────────────────────────────────────
    // Problems Module
    // ──────────────────────────────────────────────────────────────
    const ProblemsModule = (function () {
        let nameSortAsc = true;
        let colorSortDesc = true;
        let timeSortNewestFirst = true;

        function renderEntries(items) {
            const list = document.getElementById("problems-list");
            list.innerHTML = "";
            items.forEach(site => {
                const color = (site.color || "").toLowerCase().trim();
                const div = document.createElement("div");
                div.className = `problem-entry ${color === "red" ? "red" : "yellow"}`;
                div.innerHTML = `
                <div class="problem-site">${site.title}</div>
                <div class="problem-status">${color === "red" ? "Unreachable" : "Satcom"}</div>
                <div class="problem-since">since ${Utils.formatDateLocal(site.problem_since)}</div>
            `;
                list.appendChild(div);
            });
            attachClickListeners();

        }

        function attachClickListeners() {
            document.querySelectorAll('.problem-entry').forEach(el => {
                el.addEventListener('click', () => {
                    const site = el.querySelector('.problem-site').textContent.trim();
                    UIController.closeAllPanels();
                    UIController.openPanel('history');
                    HistoryModule.loadSiteHistory(site, "desc");
                    if (document.getElementById('sidebar-column').classList.contains('collapsed')) {
                        UIController.toggleSidebar();
                    }
                });
            });
        }



        function updateProblemsDisplay(sites) {
            const problematic = sites.filter(s => ["red", "yellow"].includes((s.color || "").toLowerCase().trim()));
            const list = document.getElementById("problems-list");
            const empty = document.getElementById("problems-empty");
            const countEl = document.getElementById("issues-count");

            problematic.sort((a, b) => new Date(b.problem_since) - new Date(a.problem_since));
            renderEntries(problematic);

            if (problematic.length === 0) {
                empty.style.display = "block";
                countEl.style.display = "none";
                list.innerHTML = "";
                return;
            }

            empty.style.display = "none";
            countEl.textContent = problematic.length;
            countEl.style.display = "inline";
        }

        function init() {
            document.querySelectorAll('#problems-content .sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.sort;
                    document.querySelectorAll('#problems-content .sort-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    let items = [...MainMapDataModule.getMapSitesData()]
                        .filter(s => ["red", "yellow"].includes((s.color || "").toLowerCase().trim()));

                    if (type === "time") {
                        timeSortNewestFirst = !timeSortNewestFirst;
                        btn.textContent = timeSortNewestFirst ? "Newest" : "Oldest";
                        items.sort((a, b) => timeSortNewestFirst
                            ? new Date(b.problem_since) - new Date(a.problem_since)
                            : new Date(a.problem_since) - new Date(b.problem_since));
                    } else if (type === "name") {
                        nameSortAsc = !nameSortAsc;
                        items.sort((a, b) => nameSortAsc
                            ? a.title.localeCompare(b.title)
                            : b.title.localeCompare(a.title));
                    } else if (type === "color") {
                        colorSortDesc = !colorSortDesc;
                        items.sort((a, b) => {
                            const ca = (a.color || "").toLowerCase().trim();
                            const cb = (b.color || "").toLowerCase().trim();
                            const cmp = ca.localeCompare(cb);
                            return colorSortDesc ? -cmp : cmp;
                        });
                    }

                    renderEntries(items);
                });
            });
        }

        return { init, updateProblemsDisplay };
    })();

    // ──────────────────────────────────────────────────────────────
    // History Module
    // ──────────────────────────────────────────────────────────────
    const HistoryModule = (function () {
        let currentHistorySite = null;

        function renderEntries(entries) {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            if (!entries || entries.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:50px 0;">No history records found</div>';
                return;
            }

            entries.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'history-entry';
                div.innerHTML = `
                <div class="history-time">${Utils.formatDateLocal(entry.status_changed_at)}</div>
                <div class="history-site" style="font-weight:600; margin:4px 0;">
                    ${entry.site__name || entry.site__sitename || "—"}
                </div>
                <div>
                    <span style="color:var(--text-muted);">from</span>
                    <span>${entry.past_status}</span>
                    <span style="color:var(--text-muted);"> → </span>
                    <span style="${/down|unreach/i.test(entry.current_status) ? 'color:var(--danger);font-weight:600;' : 'color:var(--success);font-weight:600;'}">
                        ${entry.current_status}
                    </span>
                </div>
            `;
                list.appendChild(div);
            });
            allSitesProblemClickListener();

        }

        function allSitesProblemClickListener() {
            document.querySelectorAll('.history-entry').forEach(el => {
                el.addEventListener('click', () => {
                    const site = el.querySelector('.history-site').textContent.trim();
                    console.log("Problem entry clicked for site:", site);
                    UIController.closeAllPanels();
                    UIController.openPanel('history');
                    HistoryModule.loadSiteHistory(site, "desc");
                    if (document.getElementById('sidebar-column').classList.contains('collapsed')) {
                        UIController.toggleSidebar();
                    }
                });
            });
        }

        async function loadAllHistory(order = "desc") {
            currentHistorySite = null;
            document.getElementById('history-back-btn').style.display = 'none';
            document.getElementById('history-panel-subtitle').textContent = 'Status History';

            try {
                const resp = await fetch("{% url 'status-history-all-sites' %}");
                if (!resp.ok) throw new Error();
                let data = await resp.json();
                data.sort((a, b) => {
                    const ta = new Date(a.status_changed_at);
                    const tb = new Date(b.status_changed_at);
                    return order === "desc" ? tb - ta : ta - tb;
                });
                renderEntries(data);
            } catch (e) {
                Utils.showAlert("Failed to load history", "danger");
                document.getElementById('history-list').innerHTML =
                    '<div style="text-align:center; color:var(--text-muted); padding:50px 0;">History unavailable</div>';
            }
        }

        async function loadSiteHistory(siteName, order = "desc") {
            currentHistorySite = siteName;
            document.getElementById('history-back-btn').style.display = 'inline-block';
            document.getElementById('history-panel-subtitle').textContent = `Status History - ${siteName}`;

            try {
                const resp = await fetch(`/api/status-history/${encodeURIComponent(siteName)}/`);
                if (!resp.ok) throw new Error();
                let data = await resp.json();
                data.sort((a, b) => {
                    const ta = new Date(a.status_changed_at);
                    const tb = new Date(b.status_changed_at);
                    return order === "desc" ? tb - ta : ta - tb;
                });
                renderEntries(data);
            } catch (e) {
                Utils.showAlert("Failed to load site history", "danger");
                document.getElementById('history-list').innerHTML =
                    '<div style="color:var(--danger);padding:30px 0;text-align:center;">History unavailable</div>';
            }
        }

        function init() {
            document.getElementById('history-back-btn').onclick = () => {
                document.getElementById('history-back-btn').style.display = 'none';
                document.getElementById('history-panel-subtitle').textContent = 'Status History';
                currentHistorySite = null;
                loadAllHistory("desc");
            };

            document.querySelectorAll('#history-content .history-sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const order = btn.dataset.order;
                    document.querySelectorAll('#history-content .history-sort-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (currentHistorySite) {
                        loadSiteHistory(currentHistorySite, order);
                    } else {
                        loadAllHistory(order);
                    }
                });
            });

            loadAllHistory("desc");
        }

        return { init, loadSiteHistory };
    })();

    // ──────────────────────────────────────────────────────────────
    // UI Controller
    // ──────────────────────────────────────────────────────────────
    const UIController = (function () {
        const sidebar = document.getElementById('sidebar-column');
        const toggleBtn = document.getElementById('sidebar-toggle');
        const contactPanel = document.getElementById('contact-panel');
        const sidebarContent = document.querySelector('#sidebar-column .sidebar-content');

        function updateContactPosition() {
            const collapsed = sidebar.classList.contains("collapsed");
            document.body.classList.toggle("sidebar-collapsed", collapsed);

            if (collapsed) {
                document.body.appendChild(contactPanel);
            } else {
                sidebarContent.appendChild(contactPanel);
            }
        }


        function toggleSidebar() {
            const collapsed = sidebar.classList.toggle('collapsed');
            toggleBtn.textContent = collapsed ? '»' : '→';
            toggleBtn.title = collapsed ? 'Expand sidebar' : 'Collapse sidebar';
            localStorage.setItem('sidebarCollapsed', collapsed);
            updateContactPosition();
        }

        function openPanel(panelId) {
            document.querySelectorAll('.panel-content').forEach(c => {
                if (c.id !== panelId + '-content') {
                    c.classList.remove('open');
                }
            });
            document.querySelectorAll('.panel-header span:last-child').forEach(s => {
                s.textContent = '▼';
            });

            const content = document.getElementById(panelId + '-content');
            const header = document.getElementById(panelId + '-header');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                header.querySelector('span:last-child').textContent = '▼';
            } else {
                content.classList.add('open');
                header.querySelector('span:last-child').textContent = '▲';
            }
        }

        function closeAllPanels() {
            console.log("Closing all panels");
            document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('open'));
            document.querySelectorAll('.panel-header span:last-child').forEach(s => s.textContent = '▼');
            console.log("All panels closed");
        }

        window.closeAllPanels = closeAllPanels; // Expose for debugging

        function init() {
            if (localStorage.getItem('sidebarCollapsed') === "true") {
                sidebar.classList.add('collapsed');
                toggleBtn.textContent = '»';
                toggleBtn.title = 'Expand sidebar';
                updateContactPosition();
            }

            toggleBtn.addEventListener('click', toggleSidebar);



            document.querySelectorAll('.panel-header').forEach(header => {
                header.addEventListener('click', () => {
                    const panelId = header.id.replace('-header', '');
                    const content = document.getElementById(panelId + '-content');
                    if (content.classList.contains('open')) {
                        closeAllPanels();
                    } else {
                        closeAllPanels();
                        openPanel(panelId);
                    }
                });
            });

            const searchInput = document.getElementById("site-search");
            const searchResults = document.getElementById("search-results");

            searchInput.addEventListener("input", Utils.debounce(() => {
                const query = searchInput.value.toLowerCase().trim();
                searchResults.innerHTML = "";
                searchResults.style.display = "none";
                if (query.length < 2) return;

                const allSites = MainMapDataModule.getMapSitesData();
                const matches = allSites.filter(s =>
                    s.title.toLowerCase().includes(query) ||
                    (s.address || "").toLowerCase().includes(query)
                );

                if (matches.length === 0) {
                    searchResults.innerHTML = '<div class="p-3 text-center text-muted">No matching sites</div>';
                } else {
                    matches.forEach(site => {
                        const item = document.createElement("div");
                        item.className = "search-item";
                        item.textContent = `${site.title} - ${site.address || ""}`;
                        item.onclick = () => {
                            MapModule.zoomToLatLon(site.latitude, site.longitude, 10);
                            setTimeout(() => {
                                MapModule.focusSiteTemporarily(site.title, 5000);
                                ContactsModule.showContactPanel(site.title);
                            }, 600);
                            searchInput.value = "";
                            searchResults.style.display = "none";
                        };
                        searchResults.appendChild(item);
                    });
                }
                searchResults.style.display = "block";
            }, 300));

            document.addEventListener("click", e => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = "none";
                }
            });

            let selectedIndex = -1;

            searchInput.addEventListener("keydown", e => {
                const items = searchResults.querySelectorAll(".search-item");
                if (!items.length || searchResults.style.display === "none") return;

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % items.length;
                    updateActiveItem(items);
                }

                if (e.key === "ArrowUp") {
                    e.preventDefault();
                    selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                    updateActiveItem(items);
                }

                if (e.key === "Enter") {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        items[selectedIndex].click(); // 🔥 treat as click
                    }
                }

                if (e.key === "Escape") {
                    searchResults.style.display = "none";
                    selectedIndex = -1;
                }
            });

            function updateActiveItem(items) {
                items.forEach((el, i) => {
                    el.classList.toggle("active", i === selectedIndex);
                });

                items[selectedIndex]?.scrollIntoView({
                    block: "nearest"
                });
            }

        }

        return { init, toggleSidebar, openPanel, closeAllPanels };
    })();

    // ──────────────────────────────────────────────────────────────
    // App Orchestration
    // ──────────────────────────────────────────────────────────────
    am4core.ready(function () {
        SettingsModule.init();
        MapModule.init();
        MCTModule.init();
        GroupsModule.init();
        MainMapDataModule.init();
        ProblemsModule.init();
        HistoryModule.init();
        // ContactsModule.init();
        UIController.init();

        document.getElementById("last-update-time").textContent = Utils.formatDateLocal(new Date());
    });


</script>
{% endblock %}