{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NOC – India Site Topology</title>

    <!-- amCharts -->
    <script src="{% static 'amcharts/core.js' %}"></script>
    <script src="{% static 'amcharts/maps.js' %}"></script>
    <script src="{% static 'amcharts/india2020High.js' %}"></script>
    <script src="{% static 'amcharts/animated.js' %}"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #eef2f5;
        }

        #header {
            background-color: #002b5c;
            color: white;
            padding: 12px 20px;
            font-size: 22px;
            font-weight: bold;
        }

        #chartdiv {
            width: 100%;
            height: calc(100vh - 60px);
            background-color: #d7e0e1;
        }
    </style>
</head>

<body>

<div id="header">
    INDIA NOC – SITE TOPOLOGY
</div>

<div id="chartdiv"></div>

<script>
am4core.ready(function () {

    am4core.useTheme(am4themes_animated);

    var chart = am4core.create("chartdiv", am4maps.MapChart);

    chart.geodata = am4geodata_india2020High;
    chart.projection = new am4maps.projections.Miller();

    // ------------------------
    // INDIA MAP
    // ------------------------
    var polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
    polygonSeries.useGeodata = true;

    var polygonTemplate = polygonSeries.mapPolygons.template;
    polygonTemplate.tooltipText = "{name}";
    polygonTemplate.fill = am4core.color("#5685d1");
    polygonTemplate.strokeOpacity = 0.4;

    // ------------------------
    // SITE MARKERS
    // ------------------------
    var imageSeries = chart.series.push(new am4maps.MapImageSeries());

    imageSeries.mapImages.template.propertyFields.latitude = "latitude";
    imageSeries.mapImages.template.propertyFields.longitude = "longitude";
    imageSeries.mapImages.template.tooltipText = "{title}";

    var marker = imageSeries.mapImages.template.createChild(am4core.Circle);
    marker.radius = 5;
    marker.nonScaling = true;
    marker.propertyFields.fill = "color";

    var pulse = imageSeries.mapImages.template.createChild(am4core.Circle);
    pulse.radius = 3;
    pulse.propertyFields.fill = "color";

    pulse.events.on("inited", function (event) {
        animatePulse(event.target);
    });

    function animatePulse(circle) {
        var animation = circle.animate(
            [
                { property: "scale", from: 1, to: 5 },
                { property: "opacity", from: 1, to: 0 }
            ],
            1200,
            am4core.ease.circleOut
        );

        animation.events.on("animationended", function () {
            animatePulse(circle);
        });
    }

    // ------------------------
    // LOAD DATA FROM DJANGO
    // ------------------------
    function loadSiteData() {
        fetch("{% url 'site-map-api' %}")
            .then(response => response.json())
            .then(data => {
                imageSeries.data = data;
            })
            .catch(error => {
                console.error("Failed to load site data", error);
            });
    }

    loadSiteData();

    // Auto refresh every 60 sec (NOC style)
    setInterval(loadSiteData, 20000);

    // Zoom controls
    chart.zoomControl = new am4maps.ZoomControl();

});
</script>

</body>
</html>
