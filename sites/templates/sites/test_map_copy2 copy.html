{% extends 'sites/base_global_dashboard.html' %}
{% block content %}
{% load static %}
<script src="{% static 'amcharts/core.js' %}"></script>
<script src="{% static 'amcharts/maps.js' %}"></script>
<script src="{% static 'amcharts/india2020High.js' %}"></script>
<script src="{% static 'amcharts/animated.js' %}"></script>

<style>
#header {
    background-color: #002b5c;
    color: white;
    padding: 12px 20px;
    font-size: 22px;
    font-weight: bold;
}

#chartdiv {
    padding-top: 10px;
    width: 100%;
    height: calc(100vh - 50px);
    background-color: #d7e0e1;
    padding-bottom: 100px;
}

#legend {
    position: fixed;
    bottom: 90px;
    left: 270px;
    background: rgba(0, 0, 0, 0.65);
    color: white;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 13px;
    z-index: 1000;
}

#contact-panel {
    position: fixed;
    bottom: 90px;
    right: 40px;
    width: 360px;
    background: rgba(255, 255, 255, 0.96);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    display: none;
    z-index: 1000;
}

#contact-header {
    background: #002b5c;
    color: white;
    padding: 8px 10px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    cursor: pointer;
}

#contact-content {
    padding: 10px;
    font-size: 13px;
}

#resetZoomBtn {
    position: fixed;
    top: 110px;
    right: 20px;
    background: #002b5c;
    color: white;
    padding: 8px 12px;
    cursor: pointer;
    border: white;
    border-radius: 4px;
    z-index: 1000;
    width: 90px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    text-align: left;
    padding: 4px;
    width: 35%;
    background: #f0f0f0;
}

td {
    padding: 4px;
}

#settings-btn {
    position: fixed;
    top: 160px;
    right: 20px;
    background: #002b5c;
    color: white;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
    z-index: 1001;
    width: 90px;
}

#settings-panel {
    position: fixed;
    right: -260px;
    top: 200px;
    width: 240px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    padding: 12px;
    transition: right 0.3s ease;
    z-index: 1000;
}

#settings-panel.open {
    right: 20px;
}

.settings-title {
    font-weight: bold;
    margin-bottom: 8px;
}

.settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 6px 0;
    font-size: 13px;
}

.switch {
    position: relative;
    width: 34px;
    height: 18px;
}

.switch input {
    display: none;
}

.slider {
    position: absolute;
    background: #ccc;
    border-radius: 18px;
    inset: 0;
    cursor: pointer;
}

.slider:before {
    content: "";
    position: absolute;
    height: 14px;
    width: 14px;
    left: 2px;
    bottom: 2px;
    background: white;
    border-radius: 50%;
    transition: 0.2s;
}

input:checked + .slider {
    background: #4caf50;
}

input:checked + .slider:before {
    transform: translateX(16px);
}

input[type=range] {
    width: 110px;
}
</style>

<div id="header">INDIA NOC - SITE TOPOLOGY</div>
<div id="chartdiv"></div>
<button id="resetZoomBtn">Reset</button>
<div id="settings-btn">Settings</div>

<div id="settings-panel">
    <div class="settings-title">Show Sites</div>
    <div class="settings-row">AFNET Site
        <label class="switch">
            <input type="checkbox" id="showA" checked>
            <span class="slider"></span>
        </label>
    </div>
    <div class="settings-row">Site on Satcom
        <label class="switch">
            <input type="checkbox" id="showB" checked>
            <span class="slider"></span>
        </label>
    </div>
    <div class="settings-row">Site Unreachable
        <label class="switch">
            <input type="checkbox" id="showC" checked>
            <span class="slider"></span>
        </label>
    </div>
    <hr>
    <div class="settings-title">Pulse</div>
    <div class="settings-row">AFNET Site
        <label class="switch">
            <input type="checkbox" id="pulseA" checked> 
            <span class="slider"></span>
        </label>
    </div>
    <div class="settings-row">Site on Satcom
        <label class="switch">
            <input type="checkbox" id="pulseB" checked>
            <span class="slider"></span>
        </label>
    </div>
    <div class="settings-row">Site Unreachable
        <label class="switch">
            <input type="checkbox" id="pulseC" checked>
            <span class="slider"></span>
        </label>
    </div>
    <div class="settings-title">Sizes</div>
    <div class="settings-row">Marker Size
        <input type="range" id="markerSize" min="3" max="12">
    </div>
    <div class="settings-row">Pulse Size
        <input type="range" id="pulseSize" min="5" max="15">
    </div>
    <hr>
    <button id="saveSettings" style="width: 100%; padding: 6px; background: #002b5c; color: white; border: none; border-radius: 4px;">
        Save Settings
    </button>
</div>

<div id="legend">
    <b>Legend</b><br>
    <div><span style="color: green; font-size: 20px;">●</span> AFNET Site</div>
    <div><span style="color: yellow; font-size: 20px;">●</span> Site on Satcom</div>
    <div><span style="color: red; font-size: 20px;">●</span> Site Unreachable</div>
</div>

<div id="contact-panel">
    <div id="contact-header">
        <span id="contact-title">Site Detail</span>
        <span>▼</span>
    </div>
    <div id="contact-content"></div>
</div>

<script>
am4core.ready(function() {
    am4core.useTheme(am4themes_animated);

    const DEFAULT_SETTINGS = {
        showA: true,
        showB: true,
        showC: true,
        pulseA: false,
        pulseB: false,
        pulseC: true,
        markerSize: 5,
        pulseSize: 8
    };

    let SETTINGS = JSON.parse(localStorage.getItem("mapSettings")) || {...DEFAULT_SETTINGS};

    const COLOR_TYPE_A = "green";
    const COLOR_TYPE_B = "yellow";
    const COLOR_TYPE_C = "red";

    /* -------------MAP----------*/
    var chart = am4core.create("chartdiv", am4maps.MapChart);
    chart.geodata = am4geodata_india2020High;
    chart.projection = new am4maps.projections.Miller();
    chart.zoomControl = new am4maps.ZoomControl();
    chart.tooltip.label.fill = am4core.color("#ffffff");
    chart.tooltip.background.fill = am4core.color("#000000");
    chart.tooltip.background.opacity = 0.85;

    /* -------RESET ZOOM BUTTON------- */
    document.getElementById("resetZoomBtn").onclick = function() {
        chart.goHome();
    };

    /* --States-- */
    var polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
    polygonSeries.useGeodata = true;
    var polygonTemplate = polygonSeries.mapPolygons.template;
    polygonTemplate.fill = am4core.color("#5685d1");
    polygonTemplate.strokeOpacity = 0.4;
    polygonTemplate.cursorOverStyle = am4core.MouseCursorStyle.pointer;
    polygonTemplate.tooltipText = "{name}";

    /* hover color for states */
    polygonTemplate.states.create("hover").properties.fill = am4core.color("#ceadada6");

    /* Sites */
    var imageSeries = chart.series.push(new am4maps.MapImageSeries());
    imageSeries.mapImages.template.propertyFields.latitude = "latitude";
    imageSeries.mapImages.template.propertyFields.longitude = "longitude";
    imageSeries.mapImages.template.tooltipText = "{title}";

    /*--Pulse circle--*/
    var pulse = imageSeries.mapImages.template.createChild(am4core.Circle);
    pulse.adapter.add("radius", () => SETTINGS.pulseSize);
    pulse.nonScaling = true;
    pulse.propertyFields.fill = "color";
    pulse.opacity = 0.5;
    pulse.strokeWidth = 0;
    pulse.zIndex = 0;

    /* Solid site marker */
    var marker = imageSeries.mapImages.template.createChild(am4core.Circle);
    marker.adapter.add("radius", () => SETTINGS.markerSize);
    marker.nonScaling = true;
    marker.propertyFields.fill = "color";
    marker.opacity = 1;
    marker.zIndex = 1;

    /*---Show/ Hide Site types--*/
    marker.adapter.add("opacity", function(target) {
        let c = (target.dataItem?.dataContext?.color || "").toLowerCase().trim();
        if (c === COLOR_TYPE_A) return SETTINGS.showA ? 1 : 0;
        if (c === COLOR_TYPE_B) return SETTINGS.showB ? 1 : 0;
        if (c === COLOR_TYPE_C) return SETTINGS.showC ? 1 : 0;
        return 1;
    });

    function startPulse(circle) {
        if (circle._pulseAnim) { circle._pulseAnim.stop(); }
        circle.scale = 1;
        circle.opacity = 1;
        circle._pulseAnim = circle.animate([
            { property: "scale", from: 1, to: 5 },
            { property: "scale", from: 1, to: 5 },
            { property: "opacity", from: 1, to: 0 }
        ], 1200);
        circle._pulseAnim.events.on("animationended", function() {
            startPulse(circle);
        });
    }

    function stopPulse(circle) {
        if (circle._pulseAnim) {
            circle._pulseAnim.stop();
            circle._pulseAnim = null;
        }
        circle.opacity = 0;
        circle.scale = 1;
    }

    function updatePulse(mapImage) {
        let data = mapImage.dataItem.dataContext;
        let pulseCircle = mapImage.children.getIndex(0); // pulse is first child
        let c = (data.color || "").toLowerCase().trim();
        let shouldPulse = (
            (c === COLOR_TYPE_A && SETTINGS.pulseA) ||
            (c === COLOR_TYPE_B && SETTINGS.pulseB) ||
            (c === COLOR_TYPE_C && SETTINGS.pulseC)
        );
        if (shouldPulse) {
            startPulse(pulseCircle);
        } else {
            stopPulse(pulseCircle);
        }
    }

    imageSeries.mapImages.template.events.on("inited", function(ev) {
        updatePulse(ev.target);
    });

    imageSeries.mapImages.template.events.on("dataitemchanged", function(ev) {
        updatePulse(ev.target);
    });

    /* ================= site click handler ================= */
    imageSeries.mapImages.template.events.on("hit", function(ev) {
        loadContactInfo(ev.target.dataItem.dataContext.title);
    });

    /*------------Auto Close contact panel on map click ---*/
    chart.seriesContainer.events.on("hit", function() {
        document.getElementById("contact-panel").style.display = "none";
    });

    /*-------------Contact info fetch--------------*/
    function loadContactInfo(siteName) {
        fetch(`/api/site-contact-info/${siteName}/`)
            .then(r => r.json())
            .then(data => renderContact(siteName, data));
    }

    function renderContact(siteName, contacts) {
        document.getElementById("contact-title").innerText = siteName;
        let panel = document.getElementById("contact-panel");
        let content = document.getElementById("contact-content");

        if (contacts.length === 0) {
            content.innerHTML = "<i>No Contact Details Available</i>";
        } else {
            let rows = "";
            contacts.forEach(c => {
                rows += `<tr><th>Email</th><td>${c.email || "-"}</td></tr>
                         <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
                         <tr><th>Address</th><td>${c.address || "-"}</td></tr>`;
            });
            content.innerHTML = `<table>${rows}</table>`;
        }
        panel.style.display = "block";
    }

    /* ================= collapse expand contact panel ================= */
    document.getElementById("contact-header").onclick = function() {
        let c = document.getElementById("contact-content");
        c.style.display = (c.style.display === "none") ? "block" : "none";
    };

    /* ================= Load Site Data ================= */
    function loadSiteData() {
        fetch("{% url 'site-map-api' %}").then(r => r.json()).then(data => {
            imageSeries.data = data;
        });
    }

    loadSiteData();
    setInterval(loadSiteData, 120000);

    /* ================= Settings Panel ================= */
    Object.keys(SETTINGS).forEach(k => {
        let el = document.getElementById(k);
        if (el) {
            (el.type === "checkbox") ? el.checked = SETTINGS[k] : el.value = SETTINGS[k];
        }
    });

    function refresh() {
        console.log("Refreshing markers...");
        imageSeries.mapImages.each(m => { updatePulse(m); });
        chart.invalidateRawData();
    }

    ["showA", "showB", "showC", "pulseA", "pulseB", "pulseC"].forEach(id => {
        document.getElementById(id).onchange = e => {
            SETTINGS[id] = e.target.checked;
            refresh();
        };
    });

    document.getElementById("markerSize").oninput = e => {
        SETTINGS.markerSize = +e.target.value;
        refresh();
    };

    document.getElementById("pulseSize").oninput = e => {
        SETTINGS.pulseSize = +e.target.value;
        refresh();
    };

    document.getElementById("saveSettings").onclick = () => {
        localStorage.setItem("mapSettings", JSON.stringify(SETTINGS));
        window.location.reload(true);
        alert("Settings Saved");
    };

    function initSettingsUI() {
        Object.keys(SETTINGS).forEach(key => {
            const el = document.getElementById(key);
            if (!el) return;
            if (el.type === "checkbox") {
                el.checked = SETTINGS[key];
            } else {
                el.value = SETTINGS[key];
            }
        });
    }

    initSettingsUI();

    document.getElementById("settings-btn").onclick = () =>
        document.getElementById("settings-panel").classList.toggle("open");
});
</script>

<style>
.watermark {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fill, 300px);
    grid-template-rows: repeat(auto-fill, 200px);
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 9999;
    user-select: none;
    transform: rotate(-30deg);
    color: rgba(0, 0, 0, 0.04);
}
</style>

{% if user.is_authenticated %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const username = "{{ user.username|escapejs }}";
    const watermark = document.createElement("div");
    watermark.id = "username-watermark";
    watermark.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fill, 300px);
        grid-template-rows: repeat(auto-fill, 200px);
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 9999;
        user-select: none;
    `;

    for (let i = 0; i < 60; i++) {
        const text = document.createElement("div");
        text.innerText = username;
        text.style.cssText = `
            font-size: 40px;
            font-weight: bold;
            color: rgba(0,0,0,0.04);
            transform: rotate(-30deg);
            white-space: nowrap;
        `;
        watermark.appendChild(text);
    }
    document.body.appendChild(watermark);
});
</script>
{% endif %}

{% endblock %}