{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NOC – India Site Topology</title>

    <!-- amCharts -->
    <script src="{% static 'amcharts/core.js' %}"></script>
    <script src="{% static 'amcharts/maps.js' %}"></script>
    <script src="{% static 'amcharts/india2020High.js' %}"></script>
    <script src="{% static 'amcharts/animated.js' %}"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #eef2f5;
        }

        #header {
            background-color: #002b5c;
            color: white;
            padding: 12px 20px;
            font-size: 22px;
            font-weight: bold;
        }

        #chartdiv {
            width: 100%;
            height: calc(100vh - 60px);
            background-color: #d7e0e1;
        }

        /* Floating Legend */
        #legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.65);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 1000;
        }

        #legend div {
            margin: 4px 0;
        }

        /* Contact Panel */
        #contact-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: rgba(255,255,255,0.96);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            display: none;
            z-index: 1000;
        }

        #contact-header {
            background: #002b5c;
            color: white;
            padding: 8px 10px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }

        #contact-content {
            padding: 10px;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 4px;
            width: 35%;
            background: #f0f0f0;
        }

        td {
            padding: 4px;
        }
    </style>
</head>

<body>

<div id="header">INDIA NOC – SITE TOPOLOGY</div>

<div id="chartdiv"></div>

<!-- Floating Legend -->
<div id="legend">
    <b>Legend</b>
    <div><span style="color:#00c853;">●</span> UP</div>
    <div><span style="color:#ff5252;">●</span> DOWN</div>
    <div><span style="color:#ffab00;">●</span> MAINT</div>
    <div><span style="color:#b0bec5;">●</span> UNKNOWN</div>
</div>

<!-- Contact Panel -->
<div id="contact-panel">
    <div id="contact-header">
        <span id="contact-title">Site Contact</span>
        <span>—</span>
    </div>
    <div id="contact-content"></div>
</div>

<script>
am4core.ready(function () {

    am4core.useTheme(am4themes_animated);

    var chart = am4core.create("chartdiv", am4maps.MapChart);
    chart.geodata = am4geodata_india2020High;
    chart.projection = new am4maps.projections.Miller();

    /* TOOLTIP VISIBILITY */
    chart.tooltip.label.fill = am4core.color("#ffffff");
    chart.tooltip.background.fill = am4core.color("#000000");
    chart.tooltip.background.opacity = 0.85;

    /* INDIA MAP */
    var polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
    polygonSeries.useGeodata = true;

    var polygonTemplate = polygonSeries.mapPolygons.template;
    polygonTemplate.tooltipText = "{name}";
    polygonTemplate.fill = am4core.color("#5685d1");
    polygonTemplate.strokeOpacity = 0.4;
    polygonTemplate.cursorOverStyle = am4core.MouseCursorStyle.pointer;

    /* HOVER STATE */
    var hoverState = polygonTemplate.states.create("hover");
    hoverState.properties.fill = am4core.color("#d32f2f");  // red on hover

    /* SITE MARKERS */
    var imageSeries = chart.series.push(new am4maps.MapImageSeries());
    imageSeries.mapImages.template.propertyFields.latitude = "latitude";
    imageSeries.mapImages.template.propertyFields.longitude = "longitude";
    imageSeries.mapImages.template.tooltipText = "{title}";

    var marker = imageSeries.mapImages.template.createChild(am4core.Circle);
    marker.radius = 5;
    marker.nonScaling = true;
    marker.propertyFields.fill = "color";

    var pulse = imageSeries.mapImages.template.createChild(am4core.Circle);
    pulse.radius = 3;
    pulse.propertyFields.fill = "color";

    pulse.events.on("inited", function (event) {
        animatePulse(event.target);
    });

    function animatePulse(circle) {
        circle.animate(
            [
                { property: "scale", from: 1, to: 5 },
                { property: "opacity", from: 1, to: 0 }
            ],
            1200,
            am4core.ease.circleOut
        ).events.on("animationended", function () {
            animatePulse(circle);
        });
    }

    /* CLICK SITE → LOAD CONTACT */
    imageSeries.mapImages.template.events.on("hit", function (ev) {
        var siteName = ev.target.dataItem.dataContext.title;
        loadContactInfo(siteName);
    });

    function loadContactInfo(siteName) {
        fetch(`/api/contact-info/${siteName}/`)
            .then(r => r.json())
            .then(data => renderContact(siteName, data))
            .catch(() => alert("Failed to load contact info"));
    }

    function renderContact(siteName, contacts) {
        document.getElementById("contact-title").innerText = siteName;
        var content = document.getElementById("contact-content");
        var panel = document.getElementById("contact-panel");

        if (contacts.length === 0) {
            content.innerHTML = "<i>No contact details available</i>";
        } else {
            let rows = "";
            contacts.forEach(c => {
                rows += `
                    <tr><th>Email</th><td>${c.email}</td></tr>
                    <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
                    <tr><th>Address</th><td>${c.address || "-"}</td></tr>
                `;
            });
            content.innerHTML = `<table>${rows}</table>`;
        }
        panel.style.display = "block";
    }

    document.getElementById("contact-header").onclick = function () {
        var c = document.getElementById("contact-content");
        c.style.display = (c.style.display === "none") ? "block" : "none";
    };

    /* LOAD SITES */
    function loadSiteData() {
        fetch("{% url 'site-map-api' %}")
            .then(r => r.json())
            .then(data => imageSeries.data = data);
    }

    loadSiteData();
    setInterval(loadSiteData, 20000);

    chart.zoomControl = new am4maps.ZoomControl();

});
</script>

</body>
</html>
