{% extends 'sites/base_global_dashboard.html' %}
{% block content %}
{% load static %}

<!-- ──────────────────────────────────────────────── -->
<!-- Load AmCharts Libraries -->
<!-- ──────────────────────────────────────────────── -->
<script src="{% static 'amcharts/core.js' %}"></script>
<script src="{% static 'amcharts/maps.js' %}"></script>
<script src="{% static 'amcharts/india2020High.js' %}"></script>
<script src="{% static 'amcharts/animated.js' %}"></script>

<!-- ──────────────────────────────────────────────── -->
<!-- CSS Styles -->
<!-- Panels are now scrollable with max-height to never exceed screen -->
<!-- ──────────────────────────────────────────────── -->
<style>
    #header {
        background-color: #002b5c;
        color: white;
        padding: 14px 24px;
        font-size: 24px;
        font-weight: bold;
    }

    #chartdiv {
        width: 100%;
        height: calc(100vh - 60px);
        background-color: #0b1220;
    }

    #legend {
        position: fixed;
        bottom: 100px;
        left: 280px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
    }

    #contact-panel {
        position: fixed;
        bottom: 100px;
        right: 40px;
        width: 380px;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 8px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        display: none;
        z-index: 1000;
    }

    #contact-header {
        background: #002b5c;
        color: white;
        padding: 10px 14px;
        font-size: 15px;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
    }

    #contact-content {
        padding: 12px;
        font-size: 13.5px;
    }

    #resetZoomBtn,
    #settings-btn,
    #history-btn {
        position: fixed;
        right: 24px;
        background: #002b5c;
        color: white;
        padding: 10px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        width: 130px;
        z-index: 1001;
        display: flex;
        align-items: flex-start;
    }

    #resetZoomBtn {
        top: 120px;
    }

    #settings-btn {
        top: 170px;
    }

    #history-btn {
        top: 220px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        text-align: left;
        padding: 6px;
        background: #f5f5f5;
        width: 35%;
    }

    td {
        padding: 6px;
    }

    #settings-panel {
        position: fixed;
        top: 270px;
        right: -300px;
        width: 280px;
        max-height: 70vh;
        /* Prevents going beyond screen height */
        overflow-y: auto;
        /* Scrollable if many rows (e.g. future colors) */
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        padding: 16px;
        transition: right 0.3s ease;
        z-index: 1002;
        font-size: 14px;
    }

    #settings-panel.open {
        right: 24px;
    }

    .settings-title {
        font-weight: 600;
        margin: 14px 0 8px;
        color: #333;
    }

    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
    }

    .switch {
        position: relative;
        width: 38px;
        height: 20px;
    }

    .switch input {
        display: none;
    }

    .slider {
        position: absolute;
        inset: 0;
        background: #ccc;
        border-radius: 20px;
        cursor: pointer;
        transition: 0.3s;
    }

    .slider:before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        left: 2px;
        bottom: 2px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    input:checked+.slider {
        background: #4caf50;
    }

    input:checked+.slider:before {
        transform: translateX(18px);
    }

    input[type=range] {
        width: 130px;
        accent-color: #002b5c;
    }

    .size-label {
        min-width: 70px;
        text-align: right;
        color: #555;
        font-size: 13px;
    }

    #saveSettings {
        margin-top: 16px;
        width: 100%;
        padding: 10px;
        background: #002b5c;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    /* ── Alerts ── */
    #alert-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        max-width: 400px;
    }

    .alert {
        padding: 14px 18px;
        margin-bottom: 12px;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.5s;
    }

    .alert.show {
        opacity: 1;
    }

    .alert-danger {
        background: #dc3545;
    }

    .alert-success {
        background: #198754;
    }

    .alert-warning {
        background: #fd7e14;
    }

    /* ── History Panel – scrollable if needed ── */
    #history-panel {
        position: fixed;
        top: 270px;
        right: -340px;
        width: 340px;
        max-height: 70vh;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        padding: 16px;
        transition: right 0.3s ease;
        z-index: 1003;
        font-size: 13px;
    }

    #history-panel.open {
        right: 24px;
    }

    .history-entry {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }

    .history-time {
        color: #6c757d;
        font-size: 11px;
        display: block;
        margin-bottom: 4px;
    }

    .history-danger {
        color: #dc3545;
        font-weight: bold;
    }

    .history-success {
        color: #198754;
        font-weight: bold;
    }
</style>

<div id="header">INDIA NOC - SITE TOPOLOGY</div>
<div id="chartdiv"></div>

<button id="resetZoomBtn"><i class="bi bi-arrow-counterclockwise me-2" aria-hidden="true"></i>Reset View</button>
<div id="settings-btn"><i class="bi bi-gear me-2" aria-hidden="true"></i>Settings</div>
<div id="history-btn"><i class="bi bi-clock me-2" aria-hidden="true"></i>History</div>

<!-- ──────────────────────────────────────────────── -->
<!-- Settings Panel – includes toggles for all 5 colors -->
<!-- ──────────────────────────────────────────────── -->
<div id="settings-panel">
    <div class="settings-title">Visibility</div>
    <div class="settings-row">AFNET Sites
        <label class="switch"><input type="checkbox" id="showA" checked><span class="slider"></span></label>
    </div>
    <div class="settings-row">Satcom Sites
        <label class="switch"><input type="checkbox" id="showB" checked><span class="slider"></span></label>
    </div>
    <div class="settings-row">Unreachable
        <label class="switch"><input type="checkbox" id="showC" checked><span class="slider"></span></label>
    </div>
    <div class="settings-row">Purple Status
        <label class="switch"><input type="checkbox" id="showD" checked><span class="slider"></span></label>
    </div>
    <div class="settings-row">Inactive Sites
        <label class="switch"><input type="checkbox" id="showE" checked><span class="slider"></span></label>
    </div>

    <div class="settings-title">Pulse Animation</div>
    <div class="settings-row">AFNET Sites
        <label class="switch"><input type="checkbox" id="pulseA"><span class="slider"></span></label>
    </div>
    <div class="settings-row">Satcom Sites
        <label class="switch"><input type="checkbox" id="pulseB"><span class="slider"></span></label>
    </div>
    <div class="settings-row">Unreachable
        <label class="switch"><input type="checkbox" id="pulseC" checked><span class="slider"></span></label>
    </div>
    <div class="settings-row">Purple Status
        <label class="switch"><input type="checkbox" id="pulseD"><span class="slider"></span></label>
    </div>
    <div class="settings-row">Inactive Sites
        <label class="switch"><input type="checkbox" id="pulseE"><span class="slider"></span></label>
    </div>

    <div class="settings-title">Marker Sizes</div>
    <div class="settings-row">
        Marker <span id="markerValue" class="size-label">6 px</span>
        <input type="range" id="markerSize" min="3" max="16" value="6">
    </div>
    <div class="settings-row">
        Pulse ring <span id="pulseValue" class="size-label">10 px</span>
        <input type="range" id="pulseSize" min="6" max="19" value="10">
    </div>

    <button id="saveSettings">Save Settings</button>
</div>

<!-- ──────────────────────────────────────────────── -->
<!-- Legend – shows all 5 defined colors -->
<!-- ──────────────────────────────────────────────── -->
<div id="legend">
    <b>Legend</b><br>
    <div><span style="color:green;font-size:22px">●</span> AFNET Site</div>
    <div><span style="color:yellow;font-size:22px">●</span> Site on Satcom</div>
    <div><span style="color:red;font-size:22px">●</span> Unreachable</div>
    <div><span style="color:purple;font-size:22px">●</span> Purple Status</div>
    <div><span style="color:blue;font-size:22px">●</span> Inactive</div>
</div>

<!-- ──────────────────────────────────────────────── -->
<!-- Contact Panel -->
<!-- ──────────────────────────────────────────────── -->
<div id="contact-panel">
    <div id="contact-header">
        <span id="contact-title">Site Details</span>
        <span>▼</span>
    </div>
    <div id="contact-content"></div>
</div>

<!-- Alerts container -->
<div id="alert-container"></div>

<!-- History Panel – scrollable -->
<div id="history-panel">
    <h4 style="margin:0 0 12px;">Site Status Changes</h4>
    <div id="history-list" style="min-height:100px;"></div>
    <button id="clear-history"
        style="margin-top:12px;width:100%;padding:8px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">Clear
        History</button>
</div>

<script>
    // ────────────────────────────────────────────────
    // GLOBAL SETTINGS & CONSTANTS
    // All 5 colors are fully supported with visibility/pulse toggles
    // ────────────────────────────────────────────────
    const SITE_COLORS = {
        A: "green",
        B: "yellow",
        C: "red",
        D: "purple",
        E: "blue"
    };

    const STATUS_NAMES = {
        "green": "AFNET Site",
        "yellow": "Site on Satcom",
        "red": "Unreachable",
        "purple": "Purple Status",
        "blue": "Inactive"
    };

    const DEFAULT_SETTINGS = {
        showA: true, showB: true, showC: true, showD: true, showE: true,
        pulseA: false, pulseB: false, pulseC: true, pulseD: false, pulseE: false,
        markerSize: 6,
        pulseSize: 10
    };

    const PULSE_CONFIG = {
        opacity: 0.5,
        maxScale: 5,
        duration: 1600
    };

    let settings = JSON.parse(localStorage.getItem("mapSettings")) || { ...DEFAULT_SETTINGS };

    // Fix invalid saved sizes
    if (settings.markerSize > settings.pulseSize) settings.pulseSize = settings.markerSize + 2;
    if (settings.pulseSize < 6) settings.pulseSize = 6;
    if (settings.markerSize < 3) settings.markerSize = 3;

    // ────────────────────────────────────────────────
    // MAP & MARKER SETUP
    // Sites are only shown if their color matches one of the 5 defined colors
    // Any other color → marker is hidden (opacity = 0)
    // ────────────────────────────────────────────────
    am4core.ready(function () {

        am4core.useTheme(am4themes_animated);

        const chart = am4core.create("chartdiv", am4maps.MapChart);
        chart.geodata = am4geodata_india2020High;
        chart.projection = new am4maps.projections.Miller();
        chart.zoomControl = new am4maps.ZoomControl();

        let polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
        polygonSeries.useGeodata = true;
        let poly = polygonSeries.mapPolygons.template;
        poly.fill = am4core.color("#1f3b57");
        poly.strokeOpacity = 0.5;
        poly.tooltipText = "{name}";
        poly.states.create("hover").properties.fill = am4core.color("#2e5f8a");

        let imageSeries = chart.series.push(new am4maps.MapImageSeries());
        let template = imageSeries.mapImages.template;
        template.propertyFields.latitude = "latitude";
        template.propertyFields.longitude = "longitude";
        template.tooltipText = "{title}";

        let pulse = template.createChild(am4core.Circle);
        pulse.adapter.add("radius", () => settings.pulseSize);
        pulse.nonScaling = true;
        pulse.propertyFields.fill = "color";
        pulse.opacity = PULSE_CONFIG.opacity;
        pulse.zIndex = 0;

        let marker = template.createChild(am4core.Circle);
        marker.adapter.add("radius", () => settings.markerSize);
        marker.nonScaling = true;
        marker.propertyFields.fill = "color";
        marker.opacity = 1;
        marker.zIndex = 1;

        marker.adapter.add("opacity", (_, target) => {
            let c = (target.dataItem?.dataContext?.color || "").toLowerCase().trim();
            console.log("Marker color:", c);

            // Explicitly hide if color is unknown / not in our list of 5
            if (!Object.values(SITE_COLORS).includes(c)) {
                console.log("Hiding marker due to unknown color", c);
                return 0; // Hide marker completely (no dot on map)
            }

            // Only show if the corresponding toggle is enabled
            switch (c) {
                case SITE_COLORS.A: return settings.showA ? 1 : 0;
                case SITE_COLORS.B: return settings.showB ? 1 : 0;
                case SITE_COLORS.C: return settings.showC ? 1 : 0;
                case SITE_COLORS.D: return settings.showD ? 1 : 0;
                case SITE_COLORS.E: return settings.showE ? 1 : 0;
                default: return 0; // Extra safety – should never hit this
            }
        });
        // ────────────────────────────────────────────────
        // Pulse Animation
        // ────────────────────────────────────────────────
        function startPulse(circle) {
            if (circle._pulseAnim) circle._pulseAnim.stop();
            circle.scale = 1;
            circle.opacity = PULSE_CONFIG.opacity;
            circle._pulseAnim = circle.animate([
                { property: "scale", from: 1, to: PULSE_CONFIG.maxScale },
                { property: "opacity", from: PULSE_CONFIG.opacity, to: 0 }
            ], PULSE_CONFIG.duration);
            circle._pulseAnim.events.on("animationended", () => startPulse(circle));
        }

        function stopPulse(circle) {
            if (circle._pulseAnim) {
                circle._pulseAnim.stop();
                circle._pulseAnim = null;
            }
            circle.opacity = 0;
            circle.scale = 1;
        }

        function updatePulse(image) {
            let data = image.dataItem?.dataContext;
            if (!data) return;
            let c = (data.color || "").toLowerCase().trim();

            // Skip pulse if color is unknown (already hidden by opacity)
            if (!Object.values(SITE_COLORS).includes(c)) return;

            let pulseCircle = image.children.getIndex(0);
            let shouldPulse =
                (c === SITE_COLORS.A && settings.pulseA) ||
                (c === SITE_COLORS.B && settings.pulseB) ||
                (c === SITE_COLORS.C && settings.pulseC) ||
                (c === SITE_COLORS.D && settings.pulseD) ||
                (c === SITE_COLORS.E && settings.pulseE);

            shouldPulse ? startPulse(pulseCircle) : stopPulse(pulseCircle);
        }

        imageSeries.mapImages.template.events.on("inited", e => updatePulse(e.target));
        imageSeries.mapImages.template.events.on("dataitemchanged", e => updatePulse(e.target));

        // ────────────────────────────────────────────────
        // Site Click → Contact Info
        // ────────────────────────────────────────────────
        template.events.on("hit", ev => {
            const title = ev.target.dataItem.dataContext.title;
            const color = (ev.target.dataItem.dataContext.color || "").toLowerCase().trim();

            // Only allow click if it's a known color
            if (Object.values(SITE_COLORS).includes(color)) {
                loadContactInfo(title);
            }
        });

        chart.seriesContainer.events.on("hit", () => {
            document.getElementById("contact-panel").style.display = "none";
        });

        function loadContactInfo(siteName) {
            fetch(`/api/contact-info/${encodeURIComponent(siteName)}/`)
                .then(r => r.ok ? r.json() : [])
                .then(data => renderContact(siteName, data))
                .catch(() => renderContact(siteName, []));
        }

        function renderContact(name, contacts) {
            document.getElementById("contact-title").textContent = name;
            let content = document.getElementById("contact-content");
            if (contacts.length === 0) {
                content.innerHTML = "<i>No contact details available</i>";
            } else {
                let html = contacts.map(c => `
                <tr><th>Email</th><td>${c.email || "—"}</td></tr>
                <tr><th>Phone</th><td>${c.phone || "—"}</td></tr>
                <tr><th>Address</th><td>${c.address || "—"}</td></tr>
            `).join("");
                content.innerHTML = `<table>${html}</table>`;
            }
            document.getElementById("contact-panel").style.display = "block";
        }

        document.getElementById("contact-header").onclick = () => {
            let c = document.getElementById("contact-content");
            c.style.display = c.style.display === "none" ? "block" : "none";
        };

        // ────────────────────────────────────────────────
        // Data Loading & Refresh
        // ────────────────────────────────────────────────
        function loadSiteData() {
            fetch("{% url 'site-map-api' %}")
                .then(r => r.json())
                .then(rawData => {
                    // Filter out ANY site with invalid/unknown color BEFORE setting data
                    const validData = rawData.filter(site => {
                        const color = (site.color || "").toLowerCase().trim();
                        const isValid = Object.values(SITE_COLORS).includes(color);

                        if (!isValid) {
                            console.log(`Filtered out invalid color site: ${site.title || "Unknown"} → color: ${color}`);
                        }

                        return isValid;
                    });

                    // Log how many were filtered (for debugging)
                    if (validData.length < rawData.length) {
                        console.log(`Filtered ${rawData.length - validData.length} invalid-color sites. Rendering ${validData.length} valid sites.`);
                    }

                    imageSeries.data = validData;
                    detectChanges(validData);  // Only detect changes on valid sites
                    refreshAll();
                })
                .catch(err => console.error("Site data error:", err));
        }

        loadSiteData();
        setInterval(loadSiteData, 120000);

        function refreshAll() {
            imageSeries.mapImages.each(updatePulse);
            chart.invalidateRawData();
        }

        // ────────────────────────────────────────────────
        // Change Detection, Alerts & History
        // ────────────────────────────────────────────────
        let previousColors = JSON.parse(localStorage.getItem("sitePreviousColors")) || {};
        let changeHistory = JSON.parse(localStorage.getItem("siteChangeHistory")) || [];

        const MAX_HISTORY = 100;

        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        function showAlert(message, type = "warning") {
            if (document.hidden) {
                if (Notification.permission === "granted") {
                    new Notification("Site Status Alert", { body: message });
                }
            } else {
                const div = document.createElement("div");
                div.className = `alert alert-${type}`;
                div.textContent = message;
                document.getElementById("alert-container").appendChild(div);
                setTimeout(() => div.classList.add("show"), 10);
                setTimeout(() => {
                    div.classList.remove("show");
                    setTimeout(() => div.remove(), 400);
                }, 7000);
            }
        }

        function addHistoryEntry(site, oldColor, newColor) {
            const now = new Date();
            const timeStr = now.toLocaleString("en-IN", {
                day: "2-digit", month: "short", year: "numeric",
                hour: "2-digit", minute: "2-digit", hour12: true
            });

            changeHistory.unshift({ time: timeStr, site, from: oldColor, to: newColor });
            if (changeHistory.length > MAX_HISTORY) changeHistory.pop();

            localStorage.setItem("siteChangeHistory", JSON.stringify(changeHistory));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const list = document.getElementById("history-list");
            list.innerHTML = changeHistory.map(item => {
                let cls = item.to === "red" ? "history-danger" : (item.from === "red" && item.to !== "red") ? "history-success" : "";
                return `
                <div class="history-entry">
                    <div class="history-time">${item.time}</div>
                    <strong>${item.site}</strong><br>
                    <span class="${cls}">${STATUS_NAMES[item.from] || item.from} → ${STATUS_NAMES[item.to] || item.to}</span>
                </div>
            `;
            }).join("") || "<p style='text-align:center;color:#777;'>No changes recorded yet.</p>";
        }

        function detectChanges(newData) {
            const currentColors = {};
            const currentSites = new Set();

            newData.forEach(site => {
                const title = site.title || "Unknown";
                const color = (site.color || "").toLowerCase().trim();

                // Skip unknown colors – they are already hidden by opacity filter
                if (!Object.values(SITE_COLORS).includes(color)) return;

                currentColors[title] = color;
                currentSites.add(title);

                // Normal change detection for A/B/C/D (purple)
                if (previousColors[title]) {
                    const oldColor = previousColors[title];
                    if (oldColor !== color) {
                        let type = "warning";
                        let msg = `${title}: ${STATUS_NAMES[oldColor] || oldColor} → ${STATUS_NAMES[color] || color}`;

                        if (color === "red") {
                            type = "danger";
                            msg = `CRITICAL: ${title} is now UNREACHABLE (${STATUS_NAMES[oldColor] || oldColor} → ${STATUS_NAMES[color] || color})`;
                        } else if (oldColor === "red") {
                            type = "success";
                            msg = `RECOVERED: ${title} is back online (${STATUS_NAMES[oldColor] || oldColor} → ${STATUS_NAMES[color] || color})`;
                        } else if (color === "yellow" && oldColor === "green") {
                            msg = `${title}: AFNET Site → Site on Satcom`;
                        } else if (color === "green" && oldColor === "yellow") {
                            msg = `${title}: Site on Satcom → normal AFNET Site`;
                        }

                        showAlert(msg, type);
                        addHistoryEntry(title, oldColor, color);
                    }
                }
            });

            // Special for blue (E) – inactive/active
            Object.keys(previousColors).forEach(title => {
                if (previousColors[title] === "blue" && !currentSites.has(title)) {
                    showAlert(`RECOVERED: ${title} is now ACTIVE (was Inactive)`, "success");
                    addHistoryEntry(title, "blue", "active");
                }
            });

            newData.forEach(site => {
                const title = site.title;
                const color = (site.color || "").toLowerCase().trim();
                if (color === "blue" && previousColors[title] !== "blue") {
                    showAlert(`ALERT: ${title} is now INACTIVE`, "danger");
                    addHistoryEntry(title, previousColors[title] || "active", "blue");
                }
            });

            previousColors = { ...currentColors };
            localStorage.setItem("sitePreviousColors", JSON.stringify(previousColors));
        }

        // ────────────────────────────────────────────────
        // Settings UI Sync & Handlers
        // ────────────────────────────────────────────────
        function syncUI() {
            ["A", "B", "C", "D", "E"].forEach(letter => {
                document.getElementById("show" + letter).checked = settings["show" + letter];
                document.getElementById("pulse" + letter).checked = settings["pulse" + letter];
            });
            document.getElementById("markerSize").value = settings.markerSize;
            document.getElementById("pulseSize").value = settings.pulseSize;
            document.getElementById("markerValue").textContent = settings.markerSize + " px";
            document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
        }

        syncUI();

        // Link show ↔ pulse toggles for all 5 types
        ["A", "B", "C", "D", "E"].forEach(letter => {
            const showId = "show" + letter;
            const pulseId = "pulse" + letter;
            document.getElementById(showId).onchange = e => {
                settings[showId] = e.target.checked;
                if (!e.target.checked) {
                    settings[pulseId] = false;
                    document.getElementById(pulseId).checked = false;
                }
                refreshAll();
            };

            document.getElementById(pulseId).onchange = e => {
                settings[pulseId] = e.target.checked;
                if (e.target.checked) {
                    settings[showId] = true;
                    document.getElementById(showId).checked = true;
                }
                refreshAll();
            };
        });

        // ────────────────────────────────────────────────
        // Size Constraints
        // ────────────────────────────────────────────────
        document.getElementById("markerSize").oninput = e => {
            let val = parseInt(e.target.value);
            if (val > settings.pulseSize) {
                settings.pulseSize = val + 2;
                document.getElementById("pulseSize").value = settings.pulseSize;
                document.getElementById("pulseValue").textContent = settings.pulseSize + " px";
            }
            settings.markerSize = val;
            document.getElementById("markerValue").textContent = val + " px";
            refreshAll();
        };

        document.getElementById("pulseSize").oninput = e => {
            let val = parseInt(e.target.value);
            if (val < 6) {
                val = 6;
                e.target.value = 6;
            }
            if (val < settings.markerSize) {
                settings.markerSize = val;
                document.getElementById("markerSize").value = val;
                document.getElementById("markerValue").textContent = val + " px";
            }
            settings.pulseSize = val;
            document.getElementById("pulseValue").textContent = val + " px";
            refreshAll();
        };

        // ────────────────────────────────────────────────
        // Save Settings & Panel Controls
        // ────────────────────────────────────────────────
        document.getElementById("saveSettings").onclick = () => {
            localStorage.setItem("mapSettings", JSON.stringify(settings));
            window.location.reload(true);
        };

        // Mutual exclusive panels
        function closeOtherPanel(currentId) {
            const otherId = currentId === "settings-panel" ? "history-panel" : "settings-panel";
            const other = document.getElementById(otherId);
            if (other && other.classList.contains("open")) {
                other.classList.remove("open");
            }
        }

        document.getElementById("settings-btn").onclick = () => {
            closeOtherPanel("settings-panel");
            document.getElementById("settings-panel").classList.toggle("open");
        };

        document.getElementById("history-btn").onclick = () => {
            closeOtherPanel("history-panel");
            document.getElementById("history-panel").classList.toggle("open");
        };

        document.getElementById("clear-history").onclick = () => {
            if (confirm("Clear all change history?")) {
                changeHistory = [];
                localStorage.setItem("siteChangeHistory", JSON.stringify([]));
                updateHistoryDisplay();
            }
        };

        document.getElementById("resetZoomBtn").onclick = () => chart.goHome();

        // Initial history load
        updateHistoryDisplay();
    });
</script>

{% if user.is_authenticated %}
<!-- ──────────────────────────────────────────────── -->
<!-- Watermark -->
<!-- ──────────────────────────────────────────────── -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const username = "{{ user.username|escapejs }}";
        const wm = document.createElement("div");
        wm.style.cssText = `position:fixed;inset:0;pointer-events:none;z-index:9999;user-select:none;display:grid;grid-template-columns:repeat(auto-fill,320px);grid-auto-rows:220px;transform:rotate(-30deg);color:rgba(0,0,0,0.04);font-size:42px;font-weight:bold;`;
        for (let i = 0; i < 60; i++) {
            let t = document.createElement("div");
            t.textContent = username;
            wm.appendChild(t);
        }
        document.body.appendChild(wm);
    });
</script>
{% endif %}

{% endblock %}