{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NOC – India Site Topology</title>

    <!-- amCharts -->
    <script src="{% static 'amcharts/core.js' %}"></script>
    <script src="{% static 'amcharts/maps.js' %}"></script>
    <script src="{% static 'amcharts/india2020High.js' %}"></script>
    <script src="{% static 'amcharts/animated.js' %}"></script>

    <style>
        body { margin: 0; font-family: Arial, sans-serif; background-color: #eef2f5; }
        #header { background-color: #002b5c; color: white; padding: 12px 20px; font-size: 22px; font-weight: bold; }
        #chartdiv { width: 100%; height: calc(100vh - 60px); background-color: #d7e0e1; }

        #legend {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.65); color: white;
            padding: 10px 14px; border-radius: 6px;
            font-size: 13px; z-index: 1000;
        }

        #contact-panel {
            position: fixed; bottom: 20px; right: 20px;
            width: 360px;
            background: rgba(255,255,255,0.96);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            display: none; z-index: 1000;
        }

        #contact-header {
            background: #002b5c; color: white;
            padding: 8px 10px; font-size: 14px;
            display: flex; justify-content: space-between;
            cursor: pointer;
        }

        #contact-content { padding: 10px; font-size: 13px; }

        #resetZoomBtn {
            position: fixed; top: 95px; right: 20px;
            z-index: 1000;
            background: #ffffff; border: 1px solid #ccc;
            padding: 6px 10px; cursor: pointer;
            border-radius: 4px;
        }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 4px; width: 40%; background: #f0f0f0; }
        td { padding: 4px; }
    </style>
</head>

<body>

<div id="header">INDIA NOC – SITE TOPOLOGY</div>
<div id="chartdiv"></div>
<button id="resetZoomBtn">⟳ Reset</button>

<div id="legend">
    <b>Legend</b><br>
    ● Color = Site Type<br>
    Pulse = Status ≠ UP
</div>

<div id="contact-panel">
    <div id="contact-header">
        <span id="contact-title">Site Details</span>
        <span>—</span>
    </div>
    <div id="contact-content"></div>
</div>

<script>
am4core.ready(function () {

    var ENABLE_PULSE = true;
    am4core.useTheme(am4themes_animated);

    /* ================= MAP ================= */
    var chart = am4core.create("chartdiv", am4maps.MapChart);
    chart.geodata = am4geodata_india2020High;
    chart.projection = new am4maps.projections.Miller();

    /* ================= STATES ================= */
    var polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
    polygonSeries.useGeodata = true;
    polygonSeries.mapPolygons.template.fill = am4core.color("#5685d1");
    polygonSeries.mapPolygons.template.states.create("hover")
        .properties.fill = am4core.color("#d32f2f");

    /* ================= SITES ================= */
    var imageSeries = chart.series.push(new am4maps.MapImageSeries());
    imageSeries.mapImages.template.propertyFields.latitude = "latitude";
    imageSeries.mapImages.template.propertyFields.longitude = "longitude";
    imageSeries.mapImages.template.tooltipText = "{title} ({status})";

    var marker = imageSeries.mapImages.template.createChild(am4core.Circle);
    marker.radius = 5;
    marker.nonScaling = true;
    marker.propertyFields.fill = "color";

    var pulse = imageSeries.mapImages.template.createChild(am4core.Circle);
    pulse.radius = 3;
    pulse.propertyFields.fill = "color";

    pulse.events.on("dataitemchanged", function (ev) {
        let d = ev.target.dataItem.dataContext;
        ev.target.stopAnimation();
        ev.target.disabled = true;
        ev.target.__isAnimating = false;

        if (ENABLE_PULSE && d.status !== "UP") {
            ev.target.disabled = false;
            animatePulse(ev.target);
        }
    });

    function animatePulse(circle) {
        if (circle.__isAnimating) return;
        circle.__isAnimating = true;

        circle.animate(
            [{ property: "scale", from: 1, to: 5 },
             { property: "opacity", from: 1, to: 0 }],
            1200
        ).events.on("animationended", function () {
            circle.__isAnimating = false;
            animatePulse(circle);
        });
    }

    /* ================= CLICK HANDLER ================= */
    imageSeries.mapImages.template.events.on("hit", function (ev) {
        let site = ev.target.dataItem.dataContext;
        loadContactInfo(site);
    });

    chart.seriesContainer.events.on("hit", function () {
        document.getElementById("contact-panel").style.display = "none";
    });

    /* ================= CONTACT + SITE DETAILS ================= */
    function loadContactInfo(site) {
        fetch(`/api/contact-info/${site.title}/`)
            .then(r => r.json())
            .then(contacts => renderDetails(site, contacts));
    }

    function renderDetails(site, contacts) {
        document.getElementById("contact-title").innerText = site.title;
        let panel = document.getElementById("contact-panel");
        let html = `
            <table>
                <tr><th>Status</th><td>${site.status}</td></tr>
                <tr><th>Site Type</th><td>${site.site_type || "-"}</td></tr>
                <tr><th>Latitude</th><td>${site.latitude}</td></tr>
                <tr><th>Longitude</th><td>${site.longitude}</td></tr>
            </table>
            <hr>
        `;

        if (contacts.length === 0) {
            html += "<i>No contact details available</i>";
        } else {
            contacts.forEach(c => {
                html += `
                    <table>
                        <tr><th>Email</th><td>${c.email}</td></tr>
                        <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
                        <tr><th>Address</th><td>${c.address || "-"}</td></tr>
                    </table><hr>
                `;
            });
        }

        document.getElementById("contact-content").innerHTML = html;
        panel.style.display = "block";
    }

    document.getElementById("contact-header").onclick = function () {
        let c = document.getElementById("contact-content");
        c.style.display = (c.style.display === "none") ? "block" : "none";
    };

    /* ================= LOAD DATA ================= */
    function loadSiteData() {
        fetch("{% url 'site-map-api' %}")
            .then(r => r.json())
            .then(data => imageSeries.data = data);
    }

    loadSiteData();
    setInterval(loadSiteData, 20000);

    chart.zoomControl = new am4maps.ZoomControl();
    document.getElementById("resetZoomBtn").onclick = () => chart.goHome();

});
</script>

</body>
</html>
