{% extends 'sites/base_global_dashboard.html' %}
{% block content %}
{% load static %}

<!-- Libraries -->
<script src="{% static 'amcharts/core.js' %}"></script>
<script src="{% static 'amcharts/maps.js' %}"></script>
<script src="{% static 'amcharts/india2020High.js' %}"></script>
<script src="{% static 'amcharts/animated.js' %}"></script>

<style>
:root {
    --bg-dark: #0b1121;
    --bg-darker: #060b17;
    --panel-glass: rgba(15, 23, 42, 0.88);
    --text: #e2e8f0;
    --text-muted: #94a3b8;
    --accent: #60a5fa;
    --accent-glow: rgba(96, 165, 250, 0.24);
    --danger: #f87171;
    --warning: #fbbf24;
    --success: #34d399;
    --border: rgba(96, 165, 250, 0.30);
    --shadow-sm: 0 6px 20px -6px rgba(0, 0, 0, 0.55);
    --shadow-md: 0 16px 40px -12px rgba(0, 0, 0, 0.65);
    --transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    --status-green: #28a745;
    --status-red: red;
    --bg-color: #e8f0f2;
}

body {
    margin: 0;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

body.dark-mode {
    background: var(--bg-darker);
    color: var(--text);
}

#main-content-wrapper {
    display: flex;
    height: calc(100vh - 60px);
    overflow: hidden;
}

#map-column {
    flex: 1;
    position: relative;
    background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
}

#chartdiv {
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
}

#last-updated {
    position: absolute;
    bottom: 16px;
    right: 32px;
    color: var(--text-muted);
    font-size: 13px;
    z-index: 1000;
    pointer-events: none;
}

.control-btn {
    position: absolute;
    left: 32px;
    background: rgba(2, 43, 92, 0.80);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    color: white;
    padding: 12px 18px;
    border: 1px solid var(--border);
    border-radius: 14px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.3px;
    width: 190px;
    z-index: 1002;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
}

.control-btn:hover {
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 16px 40px -12px var(--accent-glow);
    border-color: var(--accent);
    background: rgba(2, 43, 92, 0.94);
}

#resetZoomBtn { top: 32px; }
#settings-btn   { top: 92px; }
#dark-mode-btn  { top: 157px; }

#legend {
    position: absolute;
    bottom: 40px;
    left: 32px;
    background: var(--panel-glass);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px 24px;
    font-size: 14px;
    color: var(--text);
    box-shadow: var(--shadow-md);
    z-index: 1001;
    transition: var(--transition);
}

#legend:hover {
    transform: translateY(-6px);
    box-shadow: 0 20px 50px -12px var(--accent-glow);
}

#legend b {
    color: var(--accent);
    font-weight: 700;
}

.city-container {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: flex-start;
}

.city-box {
    background: var(--bg-color);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    flex: 0 1 auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
    transition: all 0.2s ease;
    cursor: pointer;
    min-width: fit-content;
}

.city-box:hover {
    transform: translateY(-3px);
    border-color: var(--accent);
    background: var(--panel-glass);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
}

.city-name {
    font-size: 12px;
    font-weight: 700;
    color: var(--text);
    white-space: nowrap;
}

.status-dots {
    display: flex;
    gap: 5px;
}

.glass-card {
    background: #0f172a;
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.1);
    position: relative;
    transition: transform 0.2s;
}

.dot:hover {
    transform: scale(1.4);
    z-index: 10;
}

.dot::after {
    content: attr(data-label);
    position: absolute;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: #fff;
    padding: 4px 8px;
    font-size: 10px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: 0.2s;
}

.dot:hover::after {
    opacity: 1;
}

.bg-green { background-color: var(--status-green); }
.bg-red    { background-color: var(--status-red); }

#sidebar-column {
    width: 420px;
    min-width: 420px;
    background: var(--panel-glass);
    backdrop-filter: blur(20px);
    border-left: 1px solid var(--border);
    box-shadow: -8px 0 32px rgba(0, 0, 0, 0.6);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: width 0.45s cubic-bezier(0.22, 1, 0.36, 1);
    position: relative;
    z-index: 1000;
}

#sidebar-column.collapsed {
    width: 64px;
    min-width: 64px;
}

#sidebar-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(2, 43, 92, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 22px;
    cursor: pointer;
    z-index: 1010;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
}

#sidebar-toggle:hover {
    transform: scale(1.14) rotate(180deg);
    background: var(--accent);
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px 20px;
    transition: opacity 0.45s ease;
}

#sidebar-column.collapsed .sidebar-content {
    opacity: 0;
    pointer-events: none;
}

.panel-header {
    background: linear-gradient(135deg, rgba(30, 58, 138, 0.88), rgba(59, 130, 246, 0.38));
    color: white;
    padding: 16px 20px;
    font-size: 15.5px;
    font-weight: 600;
    border-radius: 14px;
    margin-bottom: 16px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
}

.panel-header:hover {
    transform: translateY(-3px);
    box-shadow: 0 16px 40px -12px var(--accent-glow);
}

.panel-content {
    background: rgba(15, 23, 42, 0.68);
    border-radius: 14px;
    padding: 20px;
    border: 1px solid var(--border);
    margin-bottom: 20px;
    display: none;
    animation: fadeInUp 0.45s ease-out;
}

.panel-content.open {
    display: block;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
}

.problem-entry {
    padding: 16px 18px;
    margin-bottom: 12px;
    background: rgba(239, 68, 68, 0.62);
    border-radius: 12px;
    border-left: 5px solid var(--danger);
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.problem-entry.yellow {
    border-left-color: var(--warning);
}

.problem-entry:hover {
    transform: translateX(8px) scale(1.02);
    box-shadow: 0 12px 36px -8px rgba(239, 68, 68, 0.42);
}

.problem-site {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 6px;
}

.problem-status {
    font-size: 13.5px;
    font-weight: 700;
    margin: 4px 0;
}

.problem-since {
    font-size: 12.5px;
    color: var(--text-muted);
}

.history-entry {
    padding: 14px 18px;
    margin-bottom: 12px;
    background: rgba(30, 41, 59, 0.62);
    border-radius: 12px;
    font-size: 13.8px;
    transition: var(--transition);
}

.history-entry:hover {
    background: rgba(96, 165, 250, 0.16);
    transform: translateX(4px);
}

.history-time {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 6px;
}

.sidebar-content::-webkit-scrollbar {
    width: 6px;
}

.sidebar-content::-webkit-scrollbar-track {
    background: rgba(30, 41, 59, 0.4);
    border-radius: 10px;
}

.sidebar-content::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 10px;
}

#alert-container {
    position: fixed;
    top: 24px;
    right: 460px;
    z-index: 2000;
    max-width: 420px;
}

.alert {
    padding: 16px 22px;
    margin-bottom: 14px;
    border-radius: 14px;
    color: white;
    font-size: 15px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
    animation: slideInRight 0.45s ease-out;
}

@keyframes slideInRight {
    from { transform: translateX(140%); opacity: 0; }
    to   { transform: translateX(0);    opacity: 1; }
}

.alert-danger  { background: rgba(239, 68, 68, 0.92); border-color: #fca5a5; }
.alert-success { background: rgba(16, 185, 129, 0.92); border-color: #6ee7b7; }
.alert-warning { background: rgba(245, 158, 11, 0.92); border-color: #fcd34d; }

.sort-btn.active,
.history-sort-btn.active {
    background: var(--accent);
    color: white !important;
    border-color: var(--accent);
}

#site-search {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: rgba(30, 41, 59, 0.8);
    color: var(--text);
    font-size: 14px;
}

#site-search::placeholder {
    color: var(--text-muted);
}

#search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: var(--panel-glass);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-top: 6px;
    z-index: 1002;
    box-shadow: var(--shadow-md);
    display: none;
}

#search-results .search-item {
    padding: 10px 14px;
    cursor: pointer;
    color: var(--text);
}

#search-results .search-item:hover {
    background: rgba(96, 165, 250, 0.3);
}

#contact-panel {
    background: var(--panel-glass);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: var(--shadow-md);
    color: var(--text);
    margin: 20px 0;
    width: 100%;
    max-width: 380px;
}

#contact-header {
    background: linear-gradient(135deg, rgba(2, 43, 92, 0.9), rgba(30, 58, 138, 0.77));
    color: white;
    padding: 14px 20px;
    font-size: 15.5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border-radius: 14px 14px 0 0;
}

#contact-content {
    padding: 20px;
    font-size: 14px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    text-align: left;
    padding: 10px 0;
    color: var(--text-muted);
    width: 35%;
}

td {
    padding: 10px 0;
}

#settings-panel,
#history-panel {
    position: fixed;
    top: 320px;
    right: -340px;
    max-height: 65vh;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    padding: 16px;
    transition: right 0.3s ease;
    z-index: 1002;
}

body.dark-mode #settings-panel,
body.dark-mode #history-panel {
    background: #1e293b;
    color: #e2e8f0;
}

#settings-panel  { width: 300px; z-index: 1002; }
#history-panel   { width: 340px; z-index: 1003; font-size: 13px; }

#settings-panel.open,
#history-panel.open {
    right: 24px;
}

.settings-title {
    font-weight: 600;
    margin: 16px 0 10px;
    color: #333;
}

body.dark-mode .settings-title {
    color: #cbd5e1;
}

.settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 10px 0;
}

.switch {
    position: relative;
    width: 38px;
    height: 20px;
}

.switch input {
    display: none;
}

.slider {
    position: absolute;
    inset: 0;
    background: #ccc;
    border-radius: 20px;
    cursor: pointer;
    transition: .35s;
}

.slider:before {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    left: 2px;
    bottom: 2px;
    background: white;
    border-radius: 50%;
    transition: .35s;
}

input:checked + .slider {
    background: #4caf50;
}

input:checked + .slider:before {
    transform: translateX(18px);
}

input[type=range] {
    width: 130px;
    accent-color: #002b5c;
}

.size-label {
    min-width: 70px;
    text-align: right;
    color: #555;
    font-size: 13px;
}

#saveSettings {
    margin-top: 20px;
    width: 100%;
    padding: 10px;
    background: #002b5c;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

.group-site {
    background: rgba(30, 41, 59, 0.62);
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
    width: 100%;
}

.group-site:hover {
    transform: translateX(6px);
    box-shadow: 0 12px 36px -8px var(--accent-glow);
}

.group-title {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14.5px;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.status-dot.green  { background: #22c55e; }
.status-dot.yellow { background: #fbbf24; }
.status-dot.red    { background: #ef4444; }
.status-dot.blue   { background: #3b82f6; }
.status-dot.orange { background: #f97316; }
</style>

<div id="main-content-wrapper">
    <div id="map-column">
        <div id="chartdiv"></div>
        <button id="resetZoomBtn" class="control-btn"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset View</button>
        <button id="settings-btn" class="control-btn"><i class="bi bi-gear me-2"></i>Settings</button>
        <button id="dark-mode-btn" class="control-btn"><i class="bi bi-brightness-high"></i></button>

        <div id="legend">
            <b>Legend</b><br>
            <div><span style="color:green; font-size:22px">•</span> Site</div>
            <div><span style="color:#60a5fa; font-size:22px">•</span> Satcom Nodes</div>
        </div>

        <div id="last-updated">
            Last updated: <span id="last-update-time"></span>
        </div>
    </div>

    <div id="sidebar-column">
        <button id="sidebar-toggle" title="Collapse sidebar">«</button>
        <div class="sidebar-content">

            <!-- Site Search -->
            <div class="mb-4 position-relative">
                <input type="text" id="site-search" placeholder="Search sites (e.g. MCC)" autocomplete="off">
                <div id="search-results"></div>
            </div>

            <div class="panel-header" id="group-header">
                <span>Site Groups</span>
                <span>▼</span>
            </div>
            <div class="panel-content" id="group-content">
                <div class="btn-group btn-group-sm w-100 mb-3">
                    <button class="btn btn-outline-light group-btn active" data-group="group_A">IACCS</button>
                    <button class="btn btn-outline-light group-btn" data-group="group_B">DC</button>
                </div>
                <div id="group-sites-list" class="city-container"></div>
                <div id="group-empty" style="text-align:center; color:var(--text-muted); padding:30px 0; display:none;">
                    No sites in this group
                </div>
            </div>

            <!-- MCT and Satcom display -->
            <div class="panel-header" id="subtype-header">
                <span>MCT & Satcom</span>
                <span id="subtype-arrow">▼</span>
            </div>
            <div class="panel-content" id="subtype-content">
                <div class="btn-group btn-group-sm w-100 mb-3">
                    <button class="btn btn-outline-light type-btn active" data-type="MCT_Vehicle">MCT</button>
                    <button class="btn btn-outline-light type-btn" data-type="SATCOM">SATCOM</button>
                </div>
                <div id="subtype-list"></div>
                <div id="subtype-empty" style="text-align:center; color:var(--text-muted); padding:30px 0; display:none;">
                    No Data in this group
                </div>
            </div>

            <!-- Current Active Issues -->
            <div class="panel-header" id="problems-header">
                <span>Current Active Issues</span>
                <span>▼</span>
            </div>
            <div class="panel-content" id="problems-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        Current Active Issues
                        <span id="issues-count" class="badge bg-danger ms-2" style="font-size:0.8rem; display:none;">0</span>
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light sort-btn active" data-sort="time">Newest</button>
                        <button class="btn btn-outline-light sort-btn" data-sort="name">Name</button>
                        <button class="btn btn-outline-light sort-btn" data-sort="color">Color</button>
                    </div>
                </div>
                <div id="problems-list"></div>
                <div id="problems-empty" style="text-align:center; color:var(--text-muted); padding:50px 0; display:none;">
                    No active issues detected
                </div>
            </div>

            <!-- Status History -->
            <div class="panel-header" id="history-header">
                <span id="history-panel-title">Status History</span>
                <span>▼</span>
            </div>
            <div class="panel-content" id="history-content">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h6 class="mb-0" id="history-panel-subtitle">Status History</h6>
                    <button id="history-back-btn" class="btn btn-outline-light btn-sm" style="display:none;">Back</button>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light history-sort-btn active" data-order="desc">Newest first</button>
                        <button class="btn btn-outline-light history-sort-btn" data-order="asc">Oldest first</button>
                    </div>
                </div>
                <div id="history-list" style="height: 300px; overflow-y: auto;"></div>
            </div>

            <!-- Contact Panel -->
            <div id="contact-panel" style="display:none;">
                <div id="contact-header">
                    <span id="contact-title">Site Details</span>
                    <span>▼</span>
                </div>
                <div id="contact-content" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Panel -->
<div id="settings-panel">
    <div class="settings-title">Visibility</div>
    <div class="settings-row">AFNET Sites <label class="switch"><input type="checkbox" id="showA" checked><span class="slider"></span></label></div>
    <div class="settings-row">Satcom Sites <label class="switch"><input type="checkbox" id="showB" checked><span class="slider"></span></label></div>
    <div class="settings-row">Unreachable <label class="switch"><input type="checkbox" id="showC" checked><span class="slider"></span></label></div>
    <div class="settings-row">IACCS Sites <label class="switch"><input type="checkbox" id="showD" checked><span class="slider"></span></label></div>

    <div class="settings-title">Pulse Animation</div>
    <div class="settings-row">AFNET Sites <label class="switch"><input type="checkbox" id="pulseA"><span class="slider"></span></label></div>
    <div class="settings-row">Satcom Sites <label class="switch"><input type="checkbox" id="pulseB"><span class="slider"></span></label></div>
    <div class="settings-row">Unreachable <label class="switch"><input type="checkbox" id="pulseC" checked><span class="slider"></span></label></div>
    <div class="settings-row">IACCS Sites <label class="switch"><input type="checkbox" id="pulseD"><span class="slider"></span></label></div>

    <div class="settings-title">Marker Sizes</div>
    <div class="settings-row">
        Marker <span id="markerValue" class="size-label">6 px</span>
        <input type="range" id="markerSize" min="3" max="16" value="6">
    </div>
    <div class="settings-row">
        Pulse ring <span id="pulseValue" class="size-label">10 px</span>
        <input type="range" id="pulseSize" min="6" max="19" value="10">
    </div>
    <button id="saveSettings">Save Settings</button>
</div>

<div id="alert-container"></div>

<script>
// Data
const siteData = [
    { title: "AYA",   group: "group_A", lat: 28.61, long: 77.20, status: ["green", "green"] },
    { title: "33SU",  group: "group_A", lat: 19.07, long: 72.87, status: ["green", "green", "green"] },
    { title: "58SU",  group: "group_A", lat: 18.52, long: 73.85, status: ["green", "green", "green", "green"] },
    { title: "MEM",   group: "group_A", lat: 25.31, long: 82.97, status: ["green", "green"] },
    { title: "601SU", group: "group_A", lat: 22.57, long: 88.36, status: ["green", "green"] },
    { title: "BNLA",  group: "group_A", lat: 13.08, long: 80.27, status: ["green", "green"] },
    { title: "WAD",   group: "group_A", lat: 14.97, long: 77.59, status: ["green", "green"] },
    { title: "SAL",   group: "group_A", lat: 12.97, long: 77.59, status: ["green", "green"] },
    { title: "PK",    group: "group_A", lat: 12.97, long: 77.59, status: ["green", "green"] },
    { title: "MCC",   group: "group_B", lat: 28.57, long: 77.17, status: ["green"] },
    { title: "KNH",   group: "group_B", lat: 19.52, long: 72.98, status: ["green"] },
    { title: "BGLR",  group: "group_B", lat: 13.07, long: 77.54, status: ["green"] },
    { title: "BMRL",  group: "group_B", lat: 25.44, long: 81.73, status: ["green"] }
];

let currentGroup = "group_A";

// Theme & Constants
const MAP_THEME = {
    light: {
        background: "#f1f5f9",
        polygonFill: "#60a5fa",
        polygonHover: "#93c5fd",
        polygonStroke: "#e2e8f0",
        tooltipBg: "#ffffff",
        tooltipText: "#0f172a"
    },
    dark: {
        background: "#0b1121",
        polygonFill: "#1e293b",
        polygonHover: "#334155",
        polygonStroke: "#475569",
        tooltipBg: "#1e293b",
        tooltipText: "#e2e8f0"
    }
};

let currentTheme = localStorage.getItem("mapTheme") || "dark";
let theme = MAP_THEME[currentTheme];

const root = document.documentElement;
if (currentTheme === "dark") {
    document.body.classList.add("dark-mode");
    root.style.setProperty("--bg-color", "#0f172a");
} else {
    root.style.setProperty("--bg-color", "#e8f0f2");
}

const SITE_COLORS = {
    A: "green",
    B: "yellow",
    C: "red",
    D: "orange",
    E: "blue"
};

let settings = JSON.parse(localStorage.getItem("mapSettings")) || {
    showA: true, showB: true, showC: true, showD: true,
    pulseA: false, pulseB: false, pulseC: true, pulseD: false,
    markerSize: 6,
    pulseSize: 10
};

const PULSE_CONFIG = {
    opacity: 0.45,
    maxScale: 5.5,
    duration: 1800
};

// Helpers
function formatDateLocal(dt) {
    return new Date(dt).toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: true
    }).replace(/,/g, '');
}

function showAlert(message, type = "danger") {
    const container = document.getElementById("alert-container");
    const alert = document.createElement("div");
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

function debounce(fn, delay = 200) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
    };
}

// ────────────────────────────────────────────────
// AMCHARTS
// ────────────────────────────────────────────────

let chartInstance;
am4core.ready(function () {
    am4core.useTheme(am4themes_animated);
    chartInstance = am4core.create("chartdiv", am4maps.MapChart);
    chartInstance.geodata = am4geodata_india2020High;
    chartInstance.projection = new am4maps.projections.Miller();
    chartInstance.zoomControl = new am4maps.ZoomControl();

    chartInstance.tooltip.background.fill = am4core.color(theme.tooltipBg);
    chartInstance.tooltip.label.fill = am4core.color(theme.tooltipText);
    chartInstance.background.fill = am4core.color(theme.background);

    const polygonSeries = chartInstance.series.push(new am4maps.MapPolygonSeries());
    polygonSeries.useGeodata = true;
    const poly = polygonSeries.mapPolygons.template;
    poly.fill = am4core.color(theme.polygonFill);
    poly.stroke = am4core.color(theme.polygonStroke);
    poly.strokeOpacity = 0.35;
    poly.tooltipText = "{name}";
    poly.states.create("hover").properties.fill = am4core.color(theme.polygonHover);

    const imageSeries = chartInstance.series.push(new am4maps.MapImageSeries());
    const template = imageSeries.mapImages.template;
    template.propertyFields.latitude = "lat";
    template.propertyFields.longitude = "long";
    template.tooltipText = "{title}";

    const pulseCircle = template.createChild(am4core.Circle);
    pulseCircle.adapter.add("radius", () => settings.pulseSize);
    pulseCircle.nonScaling = true;
    pulseCircle.propertyFields.fill = "color";
    pulseCircle.opacity = PULSE_CONFIG.opacity;
    pulseCircle.zIndex = 9;

    const markerCircle = template.createChild(am4core.Circle);
    markerCircle.adapter.add("radius", () => settings.markerSize);
    markerCircle.nonScaling = true;
    markerCircle.propertyFields.fill = "color";
    markerCircle.zIndex = 1;

    // Visibility adapter
    template.adapter.add("opacity", (value, target) => {
        const c = (target.dataItem?.dataContext?.color || "").toLowerCase().trim();
        if (!Object.values(SITE_COLORS).includes(c)) return 0;
        const key = Object.keys(SITE_COLORS).find(k => SITE_COLORS[k] === c);
        return settings[`show${key}`] ? 1 : 0;
    });

    function zoomToLatLon(lat, lon, zoomLevel = 8, animate = true) {
        if (!chartInstance) return;
        chartInstance.zoomToGeoPoint({ latitude: lat, longitude: lon }, zoomLevel, animate);
    }

    function focusSiteTemporarily(siteTitle, duration = 5000) {
        imageSeries.mapImages.each(function (img) {
            if (img.dataItem?.dataContext?.title === siteTitle) {
                img.isHover = true;
                img.showTooltip();
                setTimeout(() => {
                    img.isHover = false;
                    if (img.tooltip) img.tooltip.hide();
                }, duration);
            }
        });
    }

    window.focusSiteTemporarily = focusSiteTemporarily;
    window.zoomToLatLon = zoomToLatLon;

    // ────────────────────────────────────────────────
    // MCT / SATCOM Section
    // ────────────────────────────────────────────────

    let currentSubtype = "MCT_Vehicle";
    let subtypeData = [];

    async function loadMCTSatcomData() {
        try {
            const response = await fetch("{% url 'mct_satcom_india_map' %}");
            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            const data = await response.json();
            if (!Array.isArray(data)) return [];
            return data.filter(item => item.name && item.data_type && item.status);
        } catch (err) {
            console.error(err);
            showAlert("Failed to load MCT/Satcom data", "danger");
            return [];
        }
    }

    async function refreshMCTSatcomData() {
        const data = await loadMCTSatcomData();
        if (data.length) subtypeData = data;
        renderMCTSatcomData(currentSubtype);
    }

    function renderMCTSatcomData(selectedType) {
        const container = document.getElementById('subtype-list');
        const emptyDiv = document.getElementById('subtype-empty');
        container.innerHTML = '';

        const filteredData = subtypeData.filter(d => d.data_type === selectedType);

        if (filteredData.length === 0) {
            emptyDiv.style.display = 'block';
            return;
        }
        emptyDiv.style.display = 'none';

        const statusList = ['FULLY_OPS', 'RESTRICTED_OPS', 'NON_OPS'];
        statusList.forEach(status => {
            const items = filteredData.filter(d => d.status === status);
            if (items.length > 0) {
                const statusHeader = document.createElement('div');
                statusHeader.textContent = `${status} (Total: ${items.length})`;
                statusHeader.style.fontWeight = '700';
                statusHeader.style.marginTop = "10px";
                statusHeader.style.marginBottom = "6px";
                statusHeader.style.color = '#0ff';
                statusHeader.style.fontSize = "14px";
                container.appendChild(statusHeader);

                const row = document.createElement('div');
                row.style.display = "flex";
                row.style.flexWrap = "wrap";
                row.style.gap = "6px";
                row.style.marginBottom = "10px";

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = item.name;
                    div.style.backgroundImage = "linear-gradient(45deg, #00ffff, #00eeff)";
                    div.style.color = '#000';
                    div.style.fontWeight = '600';
                    div.style.padding = '4px 10px';
                    div.style.borderRadius = '6px';
                    div.style.boxShadow = "0 0 8px rgba(0, 255, 255, 0.6)";
                    div.style.textShadow = "0 0 4px #00ffff";
                    div.style.fontFamily = 'monospace';
                    div.style.display = "inline-block";
                    row.appendChild(div);
                });
                container.appendChild(row);
            }
        });
    }

    document.querySelectorAll(".type-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".type-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            currentSubtype = btn.dataset.type;
            renderMCTSatcomData(currentSubtype);
        });
    });

    document.getElementById("subtype-header").addEventListener("click", () => {
        const content = document.getElementById("subtype-content");
        const isOpen = content.classList.toggle("open");
        document.getElementById("subtype-arrow").textContent = isOpen ? "▲" : "▼";
        if (isOpen) refreshMCTSatcomData();
    });

    // ────────────────────────────────────────────────
    // Group Sites (IACCS / DC)
    // ────────────────────────────────────────────────

    const groupList = document.getElementById("group-sites-list");
    const groupEmpty = document.getElementById("group-empty");

    function renderGroupSites(group) {
        const filtered = siteData.filter(s => s.group === group);
        groupList.innerHTML = "";
        groupEmpty.style.display = filtered.length ? "none" : "block";

        filtered.forEach(site => {
            const div = document.createElement("div");
            div.className = "group-site";
            div.onclick = () => {
                zoomToLatLon(site.lat, site.long, 10);
                setTimeout(() => focusSiteTemporarily(site.title, 5000), 600);
            };

            let dotsHtml = site.status.map((s, index) => {
                let label = s === 'green' ? 'Reachable' : 'Alert';
                return `<div class="dot bg-${s}" data-label="${site.title} #${index+1}: ${label}"></div>`;
            }).join("");

            div.innerHTML = `
                <span class="city-name">${site.title}</span>
                <div class="status-dots">${dotsHtml}</div>
            `;
            groupList.appendChild(div);
        });
    }

    document.querySelectorAll(".group-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".group-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            currentGroup = btn.dataset.group;
            renderGroupSites(currentGroup);
        });
    });

    // ────────────────────────────────────────────────
    // Pulse Animation
    // ────────────────────────────────────────────────

    function startPulse(circle) {
        if (circle._pulseAnim) circle._pulseAnim.stop();
        circle.scale = 1;
        circle.opacity = PULSE_CONFIG.opacity;

        circle._pulseAnim = circle.animate([
            { property: "scale", from: 1, to: PULSE_CONFIG.maxScale },
            { property: "opacity", from: PULSE_CONFIG.opacity, to: 0 }
        ], PULSE_CONFIG.duration);

        circle._pulseAnim.events.on("animationended", () => startPulse(circle));
    }

    function stopPulse(circle) {
        if (circle._pulseAnim) circle._pulseAnim.stop();
        circle.opacity = 0;
        circle.scale = 1;
    }

    function updatePulse(image) {
        const data = image.dataItem?.dataContext;
        if (!data) return;
        const c = (data.color || "").toLowerCase().trim();
        if (!Object.values(SITE_COLORS).includes(c)) return;

        const pulse = image.children.getIndex(0);
        const key = Object.keys(SITE_COLORS).find(k => SITE_COLORS[k] === c);

        if (settings[`pulse${key}`]) {
            startPulse(pulse);
        } else {
            stopPulse(pulse);
        }
    }

    imageSeries.mapImages.template.events.on("inited", e => updatePulse(e.target));
    imageSeries.mapImages.template.events.on("dataitemchanged", e => updatePulse(e.target));

    // ────────────────────────────────────────────────
    // Site Click → Contact Info
    // ────────────────────────────────────────────────

    template.events.on("hit", ev => {
        const ctx = ev.target.dataItem.dataContext;
        fetch(`/api/site-contact-info/${encodeURIComponent(ctx.title)}/`)
            .then(r => r.ok ? r.json() : [])
            .then(data => {
                document.getElementById("contact-title").textContent = ctx.title;
                const content = document.getElementById("contact-content");
                content.innerHTML = data.length === 0
                    ? "<i style='color:var(--text-muted)'>No contact details available</i>"
                    : `<table>${data.map(c => `
                        <tr><th>Email</th><td>${c.email || "-"}</td></tr>
                        <tr><th>Phone</th><td>${c.phone || "-"}</td></tr>
                        <tr><th>Address</th><td>${c.address || "-"}</td></tr>
                        <tr><th>EN Details</th><td><a href="/getnasdetails_india_map/${c.id}/">view EN Details</a></td></tr>
                    `).join("")}</table>`;

                document.getElementById("contact-panel").style.display = "block";
                document.getElementById("contact-content").style.display = "block";
            })
            .catch(() => {
                showAlert("Failed to load contact info", "danger");
                document.getElementById("contact-panel").style.display = "block";
            });
    });

    chartInstance.seriesContainer.events.on("hit", () => {
        document.getElementById("contact-panel").style.display = "none";
    });

    // ────────────────────────────────────────────────
    // Data Loading
    // ────────────────────────────────────────────────

    let allSitesData = [];

    function loadSiteData() {
        fetch("{% url 'site-map-api' %}")
            .then(r => r.json())
            .then(raw => {
                allSitesData = raw.filter(s => Object.values(SITE_COLORS).includes((s.color || "").toLowerCase().trim()));
                imageSeries.data = allSitesData;
                updateProblemsDisplay(allSitesData);
                refreshAll();
                document.getElementById("last-update-time").textContent = formatDateLocal(new Date());
            })
            .catch(err => {
                console.error(err);
                showAlert("Failed to load site data", "danger");
            });
    }

    function refreshAll() {
        imageSeries.mapImages.each(updatePulse);
        chartInstance.invalidateRawData();
    }

    loadSiteData();
    setInterval(loadSiteData, 120000);

    // ────────────────────────────────────────────────
    // Sidebar Collapse
    // ────────────────────────────────────────────────

    const sidebar = document.getElementById('sidebar-column');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const contactPanel = document.getElementById('contact-panel');
    const sidebarContent = document.querySelector('#sidebar-column .sidebar-content');

    function updateContactPosition() {
        if (sidebar.classList.contains('collapsed')) {
            document.body.appendChild(contactPanel);
            contactPanel.style.position = "fixed";
            contactPanel.style.bottom = "100px";
            contactPanel.style.right = "40px";
            contactPanel.style.width = "400px";
            contactPanel.style.margin = "0";
        } else {
            sidebarContent.appendChild(contactPanel);
            contactPanel.style.position = "relative";
            contactPanel.style.bottom = "auto";
            contactPanel.style.right = "auto";
            contactPanel.style.width = "100%";
            contactPanel.style.maxWidth = "380px";
            contactPanel.style.margin = "20px 0";
        }
    }

    if (localStorage.getItem('sidebarCollapsed') === "true") {
        sidebar.classList.add('collapsed');
        toggleBtn.textContent = '»';
        toggleBtn.title = 'Expand sidebar';
        updateContactPosition();
    }

    toggleBtn.addEventListener('click', () => {
        const collapsed = sidebar.classList.toggle('collapsed');
        toggleBtn.textContent = collapsed ? '»' : '«';
        toggleBtn.title = collapsed ? 'Expand sidebar' : 'Collapse sidebar';
        localStorage.setItem('sidebarCollapsed', collapsed);
        updateContactPosition();
    });

    // ────────────────────────────────────────────────
    // Site Search
    // ────────────────────────────────────────────────

    const searchInput = document.getElementById("site-search");
    const searchResults = document.getElementById("search-results");

    searchInput.addEventListener("input", debounce(() => {
        const query = searchInput.value.toLowerCase().trim();
        searchResults.innerHTML = "";
        searchResults.style.display = "none";

        if (query.length < 2) return;

        const matches = allSitesData.filter(s =>
            s.title.toLowerCase().includes(query) ||
            (s.address || "").toLowerCase().includes(query)
        );

        if (matches.length === 0) {
            searchResults.innerHTML = '<div class="p-3 text-center text-muted">No matching sites</div>';
        } else {
            matches.forEach(site => {
                const item = document.createElement("div");
                item.className = "search-item";
                item.textContent = site.title;
                item.onclick = () => {
                    zoomToLatLon(site.lat, site.long, 10);
                    setTimeout(() => focusSiteTemporarily(site.title, 5000), 600);
                    searchInput.value = "";
                    searchResults.style.display = "none";
                };
                searchResults.appendChild(item);
            });
        }
        searchResults.style.display = "block";
    }, 300));

    document.addEventListener("click", e => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = "none";
        }
    });

    // ────────────────────────────────────────────────
    // Accordion (panels)
    // ────────────────────────────────────────────────

    document.querySelectorAll('.panel-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            const isCurrentlyOpen = content.classList.contains('open');

            // Close others
            document.querySelectorAll('.panel-content').forEach(c => {
                if (c !== content) c.classList.remove('open');
            });

            // Reset arrows
            document.querySelectorAll('.panel-header span:last-child').forEach(s => {
                s.textContent = '▼';
            });

            // Toggle current
            if (isCurrentlyOpen) {
                content.classList.remove('open');
                header.querySelector('span:last-child').textContent = '▼';
            } else {
                content.classList.add('open');
                header.querySelector('span:last-child').textContent = '▲';
            }
        });
    });

    // Initial render
    renderGroupSites(currentGroup);
    renderMCTSatcomData(currentSubtype);
});

const dc_locations = ["DELHI", "MUMBAI", "KOLKATA", "CHENNAI"];


// Placeholder functions (to be implemented or already exist in your backend)
function loadIACCSData() { /* ... */ }
function updateProblemsDisplay() { /* ... */ }
function loadAllSitesHistory() { /* ... */ }
function loadSiteHistory() { /* ... */ }

// Settings save & UI sync would go here (omitted for brevity, but syntax is already corrected in HTML part)

</script>

{% if user.is_authenticated %}
<!-- Watermark -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const username = "{{ user.username|escapejs }}";
    const wm = document.createElement("div");
    wm.style.cssText = `position:fixed;inset:0;pointer-events:none;z-index:999;user-select:none;display:grid;grid-template-columns:repeat(auto-fill, 340px);grid-auto-rows:240px;transform:rotate(-32deg);color:rgba(255,255,255,0.12);font-size:48px;font-weight:900;opacity:0.155;`;
    for (let i = 0; i < 60; i++) {
        let t = document.createElement("div");
        t.textContent = username;
        wm.appendChild(t);
    }
    document.body.appendChild(wm);
});
</script>
{% endif %}

{% endblock %}