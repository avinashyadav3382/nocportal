{% extends 'sites/base_global_dashboard.html' %}
{% load static %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<style>
    .table {
        border-collapse: separate;
        border-spacing: 0 10px;
    }

    .table thead th {
        background-color: #f8f9fa;
        color: #212529;
        border: 1px solid #dee2e6;
        padding: 12px;
        text-align: center;
        vertical-align: middle;
    }

    .table tbody td {
        border: 1px solid #dee2e6;
        padding: 12px 14px;
        text-align: center;
        vertical-align: middle;
        background-color: #ffffff;
    }

    tr.has-error td {
        border-color: #dc3545 !important;
        background-color: #fff5f5;
    }

    .display-value {
        display: inline;
        font-weight: 500;
    }

    .edit-value {
        display: none;
    }

    .edit-mode .display-value {
        display: none;
    }

    .edit-mode .edit-value {
        display: inline;
    }

    .edit-value input {
        width: 90px;
        padding: 6px;
        text-align: center;
    }

    input[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
</style>

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">MCT Status Management</h2>
        <div>
            <button id="editBtn" class="btn btn-primary">Edit Mode</button>
            <button type="submit" form="editForm" id="saveBtn" class="btn btn-success ms-2" style="display:none;">
                Save Changes
            </button>
            <button id="cancelBtn" class="btn btn-outline-secondary ms-2" style="display:none;"
                onclick="location.reload();">
                Cancel
            </button>
        </div>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <form id="editForm" method="post">
        {% csrf_token %}
        {{ edit_formset.management_form }}

        <table id="dataTable" class="table mb-0">
            <thead>
                <tr>
                    <th>Location</th>
                    <th>Data Type</th>
                    <th>Total</th>
                    <th>Fully Ops</th>
                    <th>Restricted Ops</th>
                    <th>Non Ops</th>
                    <th>Misc</th>
                    <th>Last Updated By</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody>
                {% for form in edit_formset %}
                <tr class="{% if form.errors %}has-error{% endif %}">
                    {{ form.id }}

                    <td>
                        <span class="display-value">{{ form.instance.location }}</span>
                        <span class="edit-value">{{ form.instance.location }}</span>
                    </td>
                    <td>
                        <span class="display-value">{{ form.instance.get_data_type_display }}</span>
                        <span class="edit-value">{{ form.instance.get_data_type_display }}</span>
                    </td>
                    <td>
                        <span class="display-value">{{ form.instance.total_counter }}</span>
                        <span class="edit-value">
                            {{ form.total_counter }}
                        </span>
                    </td>

                    <td>
                        <span class="display-value">{{ form.instance.fully_ops_counter }}</span>
                        <span class="edit-value">{{ form.fully_ops_counter }}</span>
                    </td>

                    <td>
                        <span class="display-value">{{ form.instance.restricted_ops_counter }}</span>
                        <span class="edit-value">{{ form.restricted_ops_counter }}</span>
                    </td>

                    <td>
                        <span class="display-value">{{ form.instance.non_ops_counter }}</span>
                        <span class="edit-value">{{ form.non_ops_counter }}</span>
                    </td>

                    <td>
                        <span class="display-value">{{ form.instance.misc_counter }}</span>
                        <span class="edit-value">{{ form.misc_counter }}</span>
                    </td>

                    <td>{{ form.instance.last_updated_by|default:"â€”" }}</td>
                    <td>{{ form.instance.last_updated|date:"Y-m-d H:i:s" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function () {

    $('#dataTable').DataTable({
        pageLength: 10,
        ordering: true
    });

    $('#editBtn').on('click', function () {
        $('body').addClass('edit-mode');
        $('#editBtn').hide();
        $('#saveBtn, #cancelBtn').show();
    });

    {% if edit_formset.errors %}
        $('body').addClass('edit-mode');
        $('#editBtn').hide();
        $('#saveBtn, #cancelBtn').show();
    {% endif %}

    function recalcTotal(row) {
        let fully = parseInt(row.find('[name$="fully_ops_counter"]').val()) || 0;
        let restricted = parseInt(row.find('[name$="restricted_ops_counter"]').val()) || 0;
        let non = parseInt(row.find('[name$="non_ops_counter"]').val()) || 0;
        let misc = parseInt(row.find('[name$="misc_counter"]').val()) || 0;

        let total = fully + restricted + non + misc;
        row.find('[name$="total_counter"]').val(total);
    }

    $('tbody tr').each(function () {
        let row = $(this);
        row.find('[name$="total_counter"]').prop('readonly', true);

        row.find('[name$="fully_ops_counter"], [name$="restricted_ops_counter"], [name$="non_ops_counter"], [name$="misc_counter"]')
            .on('input', function () {
                recalcTotal(row);
            });
    });

});
</script>

{% endblock %}
